<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Join Team â€” Forge.inc</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#07090e;--surface:#0d1117;--surface2:#131920;--surface3:#1a2230;
  --border:rgba(255,255,255,0.055);--border2:rgba(255,255,255,0.1);
  --blue:#1a6de8;--blue-l:#4a8ff0;
  --text:#edf0f5;--text2:#9aa3b4;--muted:#55627a;
  --green:#0da068;--red:#f87171;
}
html,body{height:100%;font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;}
.bg-grid{position:fixed;inset:0;pointer-events:none;z-index:0;background-image:linear-gradient(rgba(255,255,255,0.013) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.013) 1px,transparent 1px);background-size:52px 52px;mask-image:radial-gradient(ellipse 80% 80% at 50% 50%,black 0%,transparent 100%);}
.bg-glow{position:fixed;top:-10%;left:50%;transform:translateX(-50%);width:80vw;height:60vh;background:radial-gradient(ellipse,rgba(26,109,232,0.07) 0%,transparent 65%);pointer-events:none;z-index:0;}
.page{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2rem 1rem;position:relative;z-index:1;}
.logo{display:flex;align-items:center;gap:0.55em;text-decoration:none;color:var(--text);margin-bottom:2.5rem;}
.logo-mark{width:2rem;height:2rem;background:var(--blue);border-radius:0.45em;display:grid;place-items:center;flex-shrink:0;}
.logo-name{font-size:1.1rem;font-weight:700;letter-spacing:-0.02em;}
.logo-name .tld{color:var(--blue-l);}
.card{background:var(--surface);border:1px solid var(--border2);border-radius:1em;width:100%;max-width:420px;overflow:hidden;box-shadow:0 0 0 1px rgba(255,255,255,0.03),0 2em 5em rgba(0,0,0,0.5);animation:rise 0.4s cubic-bezier(0.16,1,0.3,1) both;}
@keyframes rise{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}

/* LOADING */
.loading{padding:3em;display:flex;justify-content:center;align-items:center;gap:0.4em;}
.loading span{width:8px;height:8px;border-radius:50%;background:var(--blue);animation:pulse 1.2s ease-in-out infinite;}
.loading span:nth-child(2){animation-delay:0.2s;}
.loading span:nth-child(3){animation-delay:0.4s;}
@keyframes pulse{0%,80%,100%{transform:scale(0.6);opacity:0.4}40%{transform:scale(1);opacity:1}}

/* CARD HEADER */
.card-head{padding:2em 2em 1.5em;border-bottom:1px solid var(--border);text-align:center;}
.company-avatar{width:52px;height:52px;border-radius:12px;background:var(--blue);display:grid;place-items:center;font-size:1.1rem;font-weight:700;color:#fff;margin:0 auto 1em;overflow:hidden;}
.company-avatar img{width:100%;height:100%;object-fit:cover;}
.card-title{font-size:1.2rem;font-weight:700;letter-spacing:-0.02em;margin-bottom:0.3em;}
.card-sub{font-size:0.83rem;color:var(--text2);line-height:1.5;}

/* CARD BODY */
.card-body{padding:1.75em 2em 2em;}
.field{margin-bottom:1em;}
.field label{display:block;font-size:0.78rem;font-weight:600;color:var(--text2);margin-bottom:0.38em;letter-spacing:0.01em;}
.field input{width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:0.5em;padding:0.65em 0.85em;font-size:0.9rem;color:var(--text);font-family:'DM Sans',sans-serif;transition:border-color 0.15s,box-shadow 0.15s;outline:none;-webkit-appearance:none;}
.field input::placeholder{color:var(--muted);}
.field input:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(26,109,232,0.15);}
.field.has-error input{border-color:var(--red);}
.field.has-error .field-error{display:block;}
.field-error{font-size:0.73rem;color:var(--red);margin-top:0.28em;display:none;}
.row-2{display:grid;grid-template-columns:1fr 1fr;gap:0.75em;}
.input-wrap{position:relative;}
.input-wrap input{padding-right:2.5em;}
.pw-toggle{position:absolute;right:0.75em;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--muted);padding:0;display:grid;place-items:center;transition:color 0.15s;}
.pw-toggle:hover{color:var(--text2);}
.optional{color:var(--muted);font-weight:400;}
.btn-join{width:100%;background:var(--blue);color:#fff;padding:0.75em 1.5em;border-radius:0.5em;font-size:0.925rem;font-weight:600;border:none;cursor:pointer;font-family:'DM Sans',sans-serif;transition:opacity 0.15s,transform 0.15s;display:flex;align-items:center;justify-content:center;gap:0.45em;margin-top:0.25em;}
.btn-join:hover:not(:disabled){opacity:0.9;transform:translateY(-1px);}
.btn-join:disabled{opacity:0.45;cursor:not-allowed;transform:none;}
.signin-hint{text-align:center;margin-top:1.25em;font-size:0.8rem;color:var(--muted);}
.signin-hint a{color:var(--blue-l);text-decoration:none;font-weight:600;}
.signin-hint a:hover{text-decoration:underline;}

/* INVALID STATE */
.state-invalid{padding:2.5em 2em;text-align:center;}
.state-icon{font-size:2.5rem;margin-bottom:0.75em;}
.state-title{font-size:1.1rem;font-weight:700;margin-bottom:0.4em;}
.state-sub{font-size:0.83rem;color:var(--text2);line-height:1.5;}

/* SUCCESS STATE */
.state-success{padding:2.5em 2em;text-align:center;}
.success-icon{width:56px;height:56px;background:rgba(13,160,104,0.12);border-radius:50%;display:grid;place-items:center;margin:0 auto 1.25em;animation:pop 0.4s cubic-bezier(0.16,1,0.3,1) both;}
@keyframes pop{from{transform:scale(0.5);opacity:0}to{transform:scale(1);opacity:1}}
.success-title{font-size:1.2rem;font-weight:700;letter-spacing:-0.02em;margin-bottom:0.4em;}
.success-sub{font-size:0.83rem;color:var(--text2);margin-bottom:1.75em;line-height:1.5;}
.btn-go{display:inline-flex;align-items:center;gap:0.45em;background:var(--blue);color:#fff;border:none;border-radius:0.5em;padding:0.72em 1.75em;font-size:0.9rem;font-weight:600;font-family:'DM Sans',sans-serif;cursor:pointer;text-decoration:none;transition:opacity 0.15s;}
.btn-go:hover{opacity:0.9;}

.page-foot{margin-top:2em;font-size:0.72rem;color:var(--muted);}
</style>
</head>
<body>
<div class="bg-grid"></div>
<div class="bg-glow"></div>
<main class="page">
  <a href="index.html" class="logo">
    <div class="logo-mark"><svg viewBox="0 0 14 14" fill="none" width="14" height="14"><path d="M3 3h8M3 7h5M3 11V3" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    <span class="logo-name">Forge<span class="tld">.inc</span></span>
  </a>

  <!-- Loading -->
  <div class="card" id="cardLoading">
    <div class="loading"><span></span><span></span><span></span></div>
  </div>

  <!-- Invalid link -->
  <div class="card" id="cardInvalid" style="display:none">
    <div class="state-invalid">
      <div class="state-icon">ðŸ”—</div>
      <div class="state-title">Invalid invite link</div>
      <div class="state-sub">This link may have expired or been reset. Ask your admin to send you a new invite link.</div>
    </div>
  </div>

  <!-- Join form -->
  <div class="card" id="cardJoin" style="display:none">
    <div class="card-head">
      <div class="company-avatar" id="companyAvatar"></div>
      <div class="card-title" id="cardTitle">Join the team</div>
      <div class="card-sub" id="cardSub">Create your account to get started.</div>
    </div>
    <div class="card-body">
      <div class="row-2">
        <div class="field" id="f-first">
          <label>First name</label>
          <input type="text" id="inp-first" placeholder="Jane" autocomplete="given-name"/>
          <div class="field-error">Required</div>
        </div>
        <div class="field" id="f-last">
          <label>Last name</label>
          <input type="text" id="inp-last" placeholder="Doe" autocomplete="family-name"/>
          <div class="field-error">Required</div>
        </div>
      </div>
      <div class="field" id="f-email">
        <label>Email <span class="optional">(optional)</span></label>
        <input type="email" id="inp-email" placeholder="jane@company.com" autocomplete="email"/>
        <div class="field-error">Enter a valid email</div>
      </div>
      <div class="field" id="f-pw">
        <label>Create a password</label>
        <div class="input-wrap">
          <input type="password" id="inp-pw" placeholder="Min. 8 characters" autocomplete="new-password"/>
          <button class="pw-toggle" type="button" onclick="togglePw()" tabindex="-1">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M1 8s2.5-5 7-5 7 5 7 5-2.5 5-7 5-7-5-7-5z" stroke="currentColor" stroke-width="1.4"/><circle cx="8" cy="8" r="2" stroke="currentColor" stroke-width="1.4"/></svg>
          </button>
        </div>
        <div class="field-error">Must be at least 8 characters</div>
      </div>
      <button class="btn-join" id="btnJoin" onclick="submitJoin()">
        <span id="btnText">Join Team</span>
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M2 6h8M6 2l4 4-4 4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <div class="signin-hint">Already have an account? <a href="auth.html">Sign in</a></div>
    </div>
  </div>

  <!-- Success -->
  <div class="card" id="cardSuccess" style="display:none">
    <div class="state-success">
      <div class="success-icon">
        <svg width="26" height="26" viewBox="0 0 26 26" fill="none"><path d="M4 13l7 7 11-11" stroke="#0da068" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
      <div class="success-title" id="successTitle">You're on the team!</div>
      <div class="success-sub" id="successSub">You can now log purchases and track job budgets.</div>
      <a href="dashboard.html" class="btn-go">
        Open Dashboard
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M2 6h8M6 2l4 4-4 4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </a>
    </div>
  </div>

  <div class="page-foot">Forge.inc Â· Construction Budget Tracking</div>
</main>

<script>
const SB_URL = 'https://rgexuyvucvcqulnhypkw.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJnZXh1eXZ1Y3ZjcXVsbmh5cGt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NzMxMzcsImV4cCI6MjA4NzU0OTEzN30.j2RTOp9Bfc9s0QV4YFqyz_Y4u8-buqtp2yhccF8D_LE';

let company = null;
let joinCode = null;

function showCard(id) {
  ['cardLoading','cardInvalid','cardJoin','cardSuccess'].forEach(c => {
    document.getElementById(c).style.display = c === id ? 'block' : 'none';
  });
}

function avatarColor(str) {
  const colors = ['#1a6de8','#0da068','#d99520','#8b5cf6','#ec4899','#e84040','#06b6d4'];
  let h = 0;
  for (let i = 0; i < str.length; i++) h = str.charCodeAt(i) + ((h << 5) - h);
  return colors[Math.abs(h) % colors.length];
}

async function sbGet(table, params) {
  const r = await fetch(SB_URL + '/rest/v1/' + table + (params ? '?' + params : ''), {
    headers: { 'apikey': SB_KEY, 'Content-Type': 'application/json' }
  });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}
async function sbAuth(path, body) {
  const r = await fetch(SB_URL + '/auth/v1/' + path, {
    method: 'POST',
    headers: { 'apikey': SB_KEY, 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  const data = await r.json();
  if (!r.ok) throw new Error(data.error_description || data.msg || data.error || 'Auth error');
  return data;
}
async function sbPost(table, body, token) {
  const r = await fetch(SB_URL + '/rest/v1/' + table, {
    method: 'POST',
    headers: { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
    body: JSON.stringify(body)
  });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

// â”€â”€ INIT â”€â”€
async function init() {
  joinCode = new URLSearchParams(window.location.search).get('code');
  if (!joinCode) { showCard('cardInvalid'); return; }

  try {
    const rows = await sbGet('companies', 'team_code=eq.' + encodeURIComponent(joinCode) + '&select=id,name&limit=1');
    if (!rows.length) { showCard('cardInvalid'); return; }
    company = rows[0];

    // Populate header
    const avatar  = document.getElementById('companyAvatar');
    const initials = company.name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
    avatar.textContent = initials;
    avatar.style.background = avatarColor(company.name);
    document.getElementById('cardTitle').textContent  = 'Join ' + company.name;
    document.getElementById('cardSub').textContent    = 'You\'ve been invited to join ' + company.name + ' on Forge.inc.';
    document.getElementById('btnText').textContent    = 'Join ' + company.name;
    document.title = 'Join ' + company.name + ' â€” Forge.inc';

    showCard('cardJoin');
    setTimeout(() => document.getElementById('inp-first').focus(), 80);
  } catch(e) {
    showCard('cardInvalid');
  }
}

// â”€â”€ SUBMIT â”€â”€
async function submitJoin() {
  const first = document.getElementById('inp-first').value.trim();
  const last  = document.getElementById('inp-last').value.trim();
  const email = document.getElementById('inp-email').value.trim();
  const pw    = document.getElementById('inp-pw').value;

  let ok = true;
  function check(fieldId, valid) {
    document.getElementById(fieldId).classList.toggle('has-error', !valid);
    if (!valid) ok = false;
  }
  check('f-first', first.length > 0);
  check('f-last',  last.length > 0);
  check('f-pw',    pw.length >= 8);
  if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    document.getElementById('f-email').classList.add('has-error'); ok = false;
  } else {
    document.getElementById('f-email').classList.remove('has-error');
  }
  if (!ok) return;

  const btn = document.getElementById('btnJoin');
  btn.disabled = true;
  document.getElementById('btnText').textContent = 'Joiningâ€¦';

  // Generate placeholder email if none provided
  const uid         = Math.random().toString(36).slice(2, 9);
  const workerEmail = email || (first.toLowerCase().replace(/\s+/g,'') + '.' + last.toLowerCase().replace(/\s+/g,'') + '.' + uid + '@forge-worker.internal');

  try {
    const auth  = await sbAuth('signup', {
      email: workerEmail, password: pw,
      data: { first_name: first, last_name: last, role: 'worker', company_id: company.id }
    });
    const token = auth.access_token;
    if (token) {
      await sbPost('team_members', {
        company_id: company.id, first_name: first, last_name: last,
        email: email || null, role: 'Worker'
      }, token);
      localStorage.setItem('forge_session', JSON.stringify(auth));
      localStorage.setItem('forge_company_id', company.id);
    }
    document.getElementById('successTitle').textContent = 'Welcome, ' + first + '!';
    document.getElementById('successSub').textContent   = 'You\'ve joined ' + company.name + '. You can now log purchases and track job budgets with your crew.';
    showCard('cardSuccess');

  } catch(err) {
    // Already registered â€” try signing in
    if (err.message.toLowerCase().includes('already registered')) {
      try {
        const data = await sbAuth('token?grant_type=password', { email: workerEmail, password: pw });
        localStorage.setItem('forge_session', JSON.stringify(data));
        document.getElementById('successTitle').textContent = 'Welcome back, ' + first + '!';
        document.getElementById('successSub').textContent   = 'Signed back into ' + company.name + '.';
        showCard('cardSuccess');
        return;
      } catch(e2) {
        const errEl = document.querySelector('#f-pw .field-error');
        if (errEl) errEl.textContent = 'Wrong password for existing account';
        document.getElementById('f-pw').classList.add('has-error');
      }
    } else {
      const errEl = document.querySelector('#f-pw .field-error');
      if (errEl) errEl.textContent = err.message;
      document.getElementById('f-pw').classList.add('has-error');
    }
    btn.disabled = false;
    document.getElementById('btnText').textContent = 'Join ' + company.name;
  }
}

function togglePw() {
  const inp  = document.getElementById('inp-pw');
  const btn  = document.querySelector('.pw-toggle');
  const show = inp.type === 'password';
  inp.type   = show ? 'text' : 'password';
  btn.innerHTML = show
    ? `<svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M1 8s2.5-5 7-5 7 5 7 5-2.5 5-7 5-7-5-7-5z" stroke="currentColor" stroke-width="1.4" opacity="0.4"/><path d="M3 3l10 10" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/></svg>`
    : `<svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M1 8s2.5-5 7-5 7 5 7 5-2.5 5-7 5-7-5-7-5z" stroke="currentColor" stroke-width="1.4"/><circle cx="8" cy="8" r="2" stroke="currentColor" stroke-width="1.4"/></svg>`;
}

document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && document.getElementById('cardJoin').style.display !== 'none') submitJoin();
});

init();
</script>
</body>
</html>
