<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Forge.inc — Start Free Trial</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<script>
const SB_URL = 'https://rgexuyvucvcqulnhypkw.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJnZXh1eXZ1Y3ZjcXVsbmh5cGt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NzMxMzcsImV4cCI6MjA4NzU0OTEzN30.j2RTOp9Bfc9s0QV4YFqyz_Y4u8-buqtp2yhccF8D_LE';
(function() {
  try {
    const s = localStorage.getItem('forge_session');
    if (s && JSON.parse(s)?.access_token) window.location.replace('dashboard.html');
  } catch(e) {}
  if (window.location.hash === '#create') {
    window.addEventListener('DOMContentLoaded', () => showFlow('create-s1'));
  }
})();
async function sbAuth(path, body) {
  const r = await fetch(SB_URL + '/auth/v1/' + path, {
    method: 'POST',
    headers: { 'apikey': SB_KEY, 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  const data = await r.json();
  if (!r.ok) throw new Error(data.error_description || data.msg || data.error || 'Authentication failed');
  return data;
}
async function sbPost(table, body, token) {
  const r = await fetch(SB_URL + '/rest/v1/' + table, {
    method: 'POST',
    headers: { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
    body: JSON.stringify(body)
  });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}
function genCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let c = '';
  for (let i = 0; i < 6; i++) c += chars[Math.floor(Math.random() * chars.length)];
  return c;
}
</script>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg:#07090e; --surface:#0d1117; --surface2:#131920; --surface3:#1a2230;
  --border:rgba(255,255,255,0.055); --border2:rgba(255,255,255,0.1);
  --blue:#1a6de8; --blue-l:#4a8ff0;
  --text:#edf0f5; --text2:#9aa3b4; --muted:#55627a;
  --green:#0da068; --red:#f87171;
}
html,body { height:100%; font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); overflow-x:hidden; -webkit-font-smoothing:antialiased; }
.bg-grid { position:fixed; inset:0; pointer-events:none; z-index:0; background-image:linear-gradient(rgba(255,255,255,0.013) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.013) 1px,transparent 1px); background-size:52px 52px; mask-image:radial-gradient(ellipse 80% 80% at 50% 50%,black 0%,transparent 100%); }
.bg-glow { position:fixed; top:-10%; left:50%; transform:translateX(-50%); width:80vw; height:60vh; background:radial-gradient(ellipse,rgba(26,109,232,0.07) 0%,transparent 65%); pointer-events:none; z-index:0; }
.page { min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:2rem 1rem; position:relative; z-index:1; }
.logo { display:flex; align-items:center; gap:0.55em; text-decoration:none; color:var(--text); margin-bottom:2.5rem; animation:fadeUp 0.4s ease both; }
.logo-mark { width:2rem; height:2rem; background:var(--blue); border-radius:0.45em; display:grid; place-items:center; flex-shrink:0; }
.logo-name { font-size:1.1rem; font-weight:700; letter-spacing:-0.02em; }
.logo-name .tld { color:var(--blue-l); }
.card { background:var(--surface); border:1px solid var(--border2); border-radius:1em; padding:2.5rem; width:100%; max-width:440px; box-shadow:0 0 0 1px rgba(255,255,255,0.03),0 2em 5em rgba(0,0,0,0.5); animation:fadeUp 0.4s 0.08s ease both; }
.flow { display:none; }
.flow.active { display:block; }
.flow-title { font-size:1.3rem; font-weight:700; letter-spacing:-0.025em; margin-bottom:0.25em; }
.flow-sub { font-size:0.855rem; color:var(--text2); margin-bottom:1.8rem; line-height:1.5; }
.steps { display:flex; align-items:center; gap:0.4em; margin-bottom:1.8rem; }
.step-dot { width:6px; height:6px; border-radius:50%; background:var(--border2); transition:all 0.2s; }
.step-dot.active { background:var(--blue); width:18px; border-radius:3px; }
.step-dot.done { background:var(--green); }
.step-label { font-size:0.75rem; color:var(--muted); font-weight:500; margin-left:0.4em; }
.field { margin-bottom:1.05rem; }
.field label { display:block; font-size:0.78rem; font-weight:600; color:var(--text2); margin-bottom:0.38em; letter-spacing:0.01em; }
.field input { width:100%; background:var(--surface2); border:1px solid var(--border2); border-radius:0.5em; padding:0.65em 0.85em; font-size:0.9rem; color:var(--text); font-family:'DM Sans',sans-serif; transition:border-color 0.15s,box-shadow 0.15s; outline:none; -webkit-appearance:none; }
.field input::placeholder { color:var(--muted); }
.field input:focus { border-color:var(--blue); box-shadow:0 0 0 3px rgba(26,109,232,0.15); }
.row-2 { display:grid; grid-template-columns:1fr 1fr; gap:0.85em; }
.field-error { font-size:0.73rem; color:var(--red); margin-top:0.28em; display:none; }
.field.has-error input { border-color:var(--red); }
.field.has-error .field-error { display:block; }
.input-wrap { position:relative; }
.input-wrap input { padding-right:2.5em; }
.pw-toggle { position:absolute; right:0.75em; top:50%; transform:translateY(-50%); background:none; border:none; cursor:pointer; color:var(--muted); padding:0; display:grid; place-items:center; transition:color 0.15s; }
.pw-toggle:hover { color:var(--text2); }
.btn-primary { width:100%; background:var(--blue); color:#fff; padding:0.72em 1.5em; border-radius:0.5em; font-size:0.925rem; font-weight:600; border:none; cursor:pointer; font-family:'DM Sans',sans-serif; transition:opacity 0.15s,transform 0.15s,box-shadow 0.15s; display:flex; align-items:center; justify-content:center; gap:0.45em; }
.btn-primary:hover:not(:disabled) { opacity:0.9; transform:translateY(-1px); box-shadow:0 6px 20px rgba(26,109,232,0.3); }
.btn-primary:disabled { opacity:0.45; cursor:not-allowed; transform:none; box-shadow:none; }
.btn-back { background:none; border:none; cursor:pointer; color:var(--text2); font-size:0.82rem; font-family:'DM Sans',sans-serif; display:flex; align-items:center; gap:0.35em; padding:0; margin-bottom:1.4rem; transition:color 0.15s; }
.btn-back:hover { color:var(--text); }
.auth-footer { text-align:center; margin-top:1.4rem; font-size:0.8rem; color:var(--muted); line-height:1.6; }
.auth-footer a { color:var(--blue-l); text-decoration:none; font-weight:600; }
.auth-footer a:hover { text-decoration:underline; }
.forgot-row { display:flex; justify-content:flex-end; margin-top:-0.45rem; margin-bottom:1.2rem; }
.forgot-row a { font-size:0.8rem; color:var(--blue-l); text-decoration:none; }
.forgot-row a:hover { text-decoration:underline; }
.calc-lbl { font-size:0.72rem; font-weight:600; color:var(--text2); text-transform:uppercase; letter-spacing:0.07em; }
.slider-top { display:flex; justify-content:space-between; align-items:baseline; margin-bottom:0.65em; }
.worker-num { font-size:2.2rem; font-weight:700; letter-spacing:-0.05em; line-height:1; }
.worker-lbl { font-size:0.82rem; color:var(--muted); }
input[type=range] { -webkit-appearance:none; width:100%; height:4px; background:var(--surface3); border-radius:2px; outline:none; cursor:pointer; margin-bottom:0.45em; display:block; }
input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:1.1em; height:1.1em; background:var(--blue); border-radius:50%; cursor:pointer; border:2px solid var(--bg); box-shadow:0 0 0 2px var(--blue); transition:transform 0.1s; }
input[type=range]::-webkit-slider-thumb:hover { transform:scale(1.15); }
.price-result { background:var(--surface2); border:1px solid var(--border2); border-radius:0.7em; padding:1.15em 1.2em; position:relative; overflow:hidden; margin-bottom:1.1em; }
.price-result::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; background:linear-gradient(90deg,var(--blue),var(--blue-l)); }
.pr-tier { font-size:0.67rem; font-weight:600; text-transform:uppercase; letter-spacing:0.1em; color:var(--blue-l); margin-bottom:0.35em; }
.pr-amount { font-size:2.6rem; font-weight:700; letter-spacing:-0.06em; line-height:1; margin-bottom:0.2em; }
.pr-amount sup { font-size:1.1rem; letter-spacing:0; vertical-align:super; }
.pr-period { font-size:0.75rem; color:var(--muted); margin-bottom:0.85em; }
.pr-row { display:flex; gap:1em; }
.pr-item { text-align:center; }
.pr-item-val { font-size:0.95rem; font-weight:700; letter-spacing:-0.02em; color:var(--text2); }
.pr-item-lbl { font-size:0.63rem; color:var(--muted); margin-top:0.08em; }
.pr-div { width:1px; background:var(--border); }
.toast { position:fixed; bottom:1.5rem; left:50%; transform:translateX(-50%) translateY(4em); background:#1e1215; border:1px solid rgba(248,113,113,0.3); color:var(--red); padding:0.7em 1.2em; border-radius:0.5em; font-size:0.85rem; font-weight:500; z-index:999; transition:transform 0.3s cubic-bezier(0.16,1,0.3,1),opacity 0.3s; opacity:0; pointer-events:none; white-space:nowrap; }
.toast.show { transform:translateX(-50%) translateY(0); opacity:1; }
@keyframes fadeUp { from { opacity:0; transform:translateY(0.8em); } to { opacity:1; transform:none; } }
.slide-in { animation:fadeUp 0.22s ease both; }
@media(max-width:520px) { .card { padding:1.8rem 1.4rem; } .row-2 { grid-template-columns:1fr; } }
</style>
</head>
<body>
<div class="bg-grid"></div>
<div class="bg-glow"></div>
<div class="toast" id="toast"></div>
<main class="page">
  <a href="index.html" class="logo">
    <div class="logo-mark"><svg viewBox="0 0 14 14" fill="none" width="14" height="14"><path d="M3 3h8M3 7h5M3 11V3" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    <span class="logo-name">Forge<span class="tld">.inc</span></span>
  </a>
  <div class="card">

    <!-- CREATE — STEP 1 -->
    <div class="flow active" id="flow-create-s1">
      <div class="steps">
        <div class="step-dot active"></div><div class="step-dot"></div><div class="step-dot"></div>
        <span class="step-label">Step 1 of 3 — Your company</span>
      </div>
      <div class="flow-title">Create your company</div>
      <div class="flow-sub">Set up Forge for your crew. Takes about 60 seconds.</div>
      <div class="field" id="ca-f-company">
        <label>Company name</label>
        <input type="text" id="ca-company" placeholder="Smith Construction LLC" autocomplete="organization"/>
        <div class="field-error">Required</div>
      </div>
      <div class="field" id="ca-f-email">
        <label>Email</label>
        <input type="email" id="ca-email" placeholder="you@smithconstruction.com" autocomplete="email"/>
        <div class="field-error">Enter a valid email</div>
      </div>
      <div class="field" id="ca-f-pw">
        <label>Password</label>
        <div class="input-wrap">
          <input type="password" id="ca-pw" placeholder="Min. 8 characters" autocomplete="new-password"/>
          <button class="pw-toggle" type="button" onclick="togglePw('ca-pw',this)" tabindex="-1">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M1 8s2.5-5 7-5 7 5 7 5-2.5 5-7 5-7-5-7-5z" stroke="currentColor" stroke-width="1.4"/><circle cx="8" cy="8" r="2" stroke="currentColor" stroke-width="1.4"/></svg>
          </button>
        </div>
        <div class="field-error">Must be at least 8 characters</div>
      </div>
      <button class="btn-primary" onclick="createS1Next()">
        Continue
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M2 6h8M6 2l4 4-4 4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <div class="auth-footer">Already have an account? <a href="auth.html">Sign in</a></div>
    </div>

    <!-- CREATE — STEP 2 -->
    <div class="flow" id="flow-create-s2">
      <button class="btn-back" onclick="showFlow('create-s1')">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M9 2L4 7l5 5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Back
      </button>
      <div class="steps">
        <div class="step-dot done"></div><div class="step-dot active"></div><div class="step-dot"></div>
        <span class="step-label">Step 2 of 3 — Your name</span>
      </div>
      <div class="flow-title">What's your name?</div>
      <div class="flow-sub">This is how you'll appear to your team inside Forge.</div>
      <div class="row-2">
        <div class="field" id="ca-f-first">
          <label>First name</label>
          <input type="text" id="ca-first" placeholder="John" autocomplete="given-name"/>
          <div class="field-error">Required</div>
        </div>
        <div class="field" id="ca-f-last">
          <label>Last name</label>
          <input type="text" id="ca-last" placeholder="Smith" autocomplete="family-name"/>
          <div class="field-error">Required</div>
        </div>
      </div>
      <button class="btn-primary" onclick="createS2Next()">
        Continue
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M2 6h8M6 2l4 4-4 4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <div class="auth-footer">Already have an account? <a href="auth.html">Sign in</a></div>
    </div>

    <!-- CREATE — STEP 3 -->
    <div class="flow" id="flow-create-s3">
      <button class="btn-back" onclick="showFlow('create-s2')">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M9 2L4 7l5 5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Back
      </button>
      <div class="steps">
        <div class="step-dot done"></div><div class="step-dot done"></div><div class="step-dot active"></div>
        <span class="step-label">Step 3 of 3 — Your crew</span>
      </div>
      <div class="flow-title">How big is your crew?</div>
      <div class="flow-sub">Drag to set your team size. You can change plans anytime.</div>
      <div class="calc-lbl" style="margin-bottom:0.7em">Workers on your team</div>
      <div class="slider-top">
        <div><span class="worker-num" id="s3-wNum">10</span><span class="worker-lbl"> workers</span></div>
        <span class="pr-tier" id="s3-tierBadge" style="font-size:0.7rem">Growth Plan</span>
      </div>
      <input type="range" id="s3-slider" min="1" max="51" value="10" oninput="s3Update(this.value)">
      <div style="position:relative;height:1.4em;margin-bottom:1.2em">
        <span id="s3-planTick" style="position:absolute;font-size:0.72rem;font-weight:700;color:var(--blue-l);transform:translateX(-50%);transition:left 0.15s ease">20</span>
      </div>
      <div class="price-result">
        <div class="pr-tier" id="s3-planName">Growth Plan</div>
        <div class="pr-amount"><sup>$</sup><span id="s3-prNum">99</span></div>
        <div class="pr-period">per month · cancel anytime</div>
        <div class="pr-row">
          <div class="pr-item"><div class="pr-item-val" id="s3-prPer">$10</div><div class="pr-item-lbl">per worker/mo</div></div>
          <div class="pr-div"></div>
          <div class="pr-item"><div class="pr-item-val" id="s3-prYear">$1,188</div><div class="pr-item-lbl">per year</div></div>
          <div class="pr-div"></div>
          <div class="pr-item"><div class="pr-item-val">All</div><div class="pr-item-lbl">features included</div></div>
        </div>
      </div>
      <button class="btn-primary" id="startTrialBtn" onclick="submitCreate()">
        Start 14-Day Free Trial
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M2 6h8M6 2l4 4-4 4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <p style="font-size:0.73rem;color:var(--muted);text-align:center;margin-top:0.65em">14-day free trial · No credit card required</p>
      <div class="auth-footer">Already have an account? <a href="auth.html">Sign in</a></div>
    </div>

  </div>
</main>

<script>
let companyData  = {};
let selectedPlan = 'growth';
const PLANS = [
  { id:'starter',    name:'Starter',    max:5,        price:49,  year:588  },
  { id:'growth',     name:'Growth',     max:20,       price:99,  year:1188 },
  { id:'pro',        name:'Pro',        max:50,       price:199, year:2388 },
  { id:'enterprise', name:'Enterprise', max:Infinity, price:399, year:4788 },
];

let _toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => t.classList.remove('show'), 4000);
}

function showFlow(name) {
  document.querySelectorAll('.flow').forEach(f => f.classList.remove('active'));
  const id = { 'create-s1':'flow-create-s1', 'create-s2':'flow-create-s2', 'create-s3':'flow-create-s3' }[name] || 'flow-create-s1';
  const el = document.getElementById(id);
  el.classList.add('active');
  el.classList.remove('slide-in'); void el.offsetWidth; el.classList.add('slide-in');
  if (name === 'create-s3') s3Update(document.getElementById('s3-slider').value);
  // Focus first input
  setTimeout(() => { const inp = el.querySelector('input'); if (inp) inp.focus(); }, 50);
}

function s3Update(val) {
  const n    = Math.min(parseInt(val), 51);
  const plan = PLANS.find(p => n <= p.max) || PLANS[3];
  selectedPlan = plan.id;
  const maxW    = plan.max === Infinity ? 51 : plan.max;
  const fillPct = plan.max === Infinity ? 100 : (plan.max / 51) * 100;
  document.getElementById('s3-wNum').textContent     = n >= 51 ? '51+' : n;
  document.getElementById('s3-tierBadge').textContent = plan.name + ' Plan';
  document.getElementById('s3-planName').textContent  = plan.name + ' Plan';
  document.getElementById('s3-prNum').textContent     = plan.price;
  document.getElementById('s3-prPer').textContent     = '$' + (plan.price / maxW).toFixed(1);
  document.getElementById('s3-prYear').textContent    = '$' + plan.year.toLocaleString();
  const tick = document.getElementById('s3-planTick');
  tick.textContent = plan.max === Infinity ? '∞' : plan.max;
  tick.style.left  = Math.min(98, Math.max(2, fillPct)) + '%';
  document.getElementById('s3-slider').style.background = `linear-gradient(to right, var(--blue) ${fillPct}%, var(--surface3) ${fillPct}%)`;
}

function validate(rules) {
  let ok = true;
  rules.forEach(([fieldId, valid, msg]) => {
    const el = document.getElementById(fieldId);
    el.classList.toggle('has-error', !valid);
    if (!valid && msg) { const err = el.querySelector('.field-error'); if (err) err.textContent = msg; }
    if (!valid) ok = false;
  });
  return ok;
}

function createS1Next() {
  const company = document.getElementById('ca-company').value.trim();
  const email   = document.getElementById('ca-email').value.trim();
  const pw      = document.getElementById('ca-pw').value;
  if (!validate([
    ['ca-f-company', company.length > 0],
    ['ca-f-email',   /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)],
    ['ca-f-pw',      pw.length >= 8],
  ])) return;
  companyData = { companyName: company, email, password: pw };
  showFlow('create-s2');
}

function createS2Next() {
  const first = document.getElementById('ca-first').value.trim();
  const last  = document.getElementById('ca-last').value.trim();
  if (!validate([['ca-f-first', first.length > 0], ['ca-f-last', last.length > 0]])) return;
  companyData.firstName = first;
  companyData.lastName  = last;
  showFlow('create-s3');
}

async function submitCreate() {
  const workers = parseInt(document.getElementById('s3-slider').value) || 1;
  const btn = document.getElementById('startTrialBtn');
  btn.textContent = 'Creating account…'; btn.disabled = true;
  try {
    // 1. Sign up
    const auth = await sbAuth('signup', {
      email: companyData.email, password: companyData.password,
      data: { first_name: companyData.firstName, last_name: companyData.lastName }
    });
    const token  = auth.access_token;
    const userId = auth.user?.id;
    if (!token || !userId) throw new Error('Signup failed — please try again');

    // 2. Create company
    const companies = await sbPost('companies', {
      owner_id: userId, name: companyData.companyName,
      plan: selectedPlan, team_code: genCode(),
      worker_count: workers, trial_end: Date.now() + 14 * 24 * 60 * 60 * 1000
    }, token);

    const company = Array.isArray(companies) ? companies[0] : companies;
    if (!company?.id) throw new Error('Company creation failed — please try again');

    // 3. Save session + company_id so dashboard can find it immediately
    localStorage.setItem('forge_session', JSON.stringify(auth));
    localStorage.setItem('forge_company_id', company.id);
    window.location.href = 'dashboard.html';

  } catch(err) {
    btn.textContent = 'Start 14-Day Free Trial'; btn.disabled = false;
    showToast(err.message);
  }
}

function togglePw(inputId, btn) {
  const input = document.getElementById(inputId);
  const show  = input.type === 'password';
  input.type  = show ? 'text' : 'password';
  btn.innerHTML = show
    ? `<svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M1 8s2.5-5 7-5 7 5 7 5-2.5 5-7 5-7-5-7-5z" stroke="currentColor" stroke-width="1.4" opacity="0.4"/><path d="M3 3l10 10" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/></svg>`
    : `<svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M1 8s2.5-5 7-5 7 5 7 5-2.5 5-7 5-7-5-7-5z" stroke="currentColor" stroke-width="1.4"/><circle cx="8" cy="8" r="2" stroke="currentColor" stroke-width="1.4"/></svg>`;
}

document.addEventListener('keydown', e => {
  if (e.key !== 'Enter') return;
  const active = document.querySelector('.flow.active');
  if (!active) return;
  switch(active.id) {
    case 'flow-create-s1': createS1Next(); break;
    case 'flow-create-s2': createS2Next(); break;
    case 'flow-create-s3': submitCreate(); break;
  }
});
</script>
</body>
</html>
