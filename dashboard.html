<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Forge.inc — Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
input[type=number] { -moz-appearance: textfield; }
:root {
  --bg:        #07090e;
  --surface:   #0d1117;
  --surface2:  #131920;
  --surface3:  #1a2230;
  --border:    rgba(255,255,255,0.055);
  --border2:   rgba(255,255,255,0.1);
  --blue:      #1a6de8;
  --blue-l:    #4a8ff0;
  --text:      #edf0f5;
  --text2:     #9aa3b4;
  --muted:     #55627a;
  --green:     #0da068;
  --orange:    #d99520;
  --red:       #e84040;
  --sidebar-w: 260px;
}
html, body { height: 100%; font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }

.app { display: flex; height: 100vh; }

/* SIDEBAR */
.sidebar { width: var(--sidebar-w); flex-shrink: 0; background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; height: 100%; }
.sidebar-logo { padding: 1.2em 1.3em; display: flex; align-items: center; gap: 0.55em; border-bottom: 1px solid var(--border); flex-shrink: 0; text-decoration: none; color: var(--text); }
.logo-mark { width: 1.75rem; height: 1.75rem; background: var(--blue); border-radius: 0.4em; display: grid; place-items: center; flex-shrink: 0; }
.logo-name { font-size: 0.95rem; font-weight: 700; letter-spacing: -0.02em; }
.logo-name .tld { color: var(--blue-l); }
.sidebar-section { padding: 0.7em 0.85em 0.4em; }
.sidebar-label { font-size: 0.72rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); padding: 0 0.5em; margin-bottom: 0.3em; }
.nav-item { display: flex; align-items: center; gap: 0.65em; padding: 0.52em 0.75em; border-radius: 0.45em; font-size: 0.95rem; font-weight: 500; color: var(--text2); cursor: pointer; transition: all 0.12s; user-select: none; margin-bottom: 0.1em; }
.nav-item:hover { background: var(--surface2); color: var(--text); }
.nav-item.active { background: rgba(26,109,232,0.12); color: var(--blue-l); }
.nav-item svg { flex-shrink: 0; opacity: 0.7; width: 17px; height: 17px; }
.nav-item.active svg { opacity: 1; }
.sidebar-projects { flex: 1; padding: 0; overflow-y: auto; min-height: 0; }
.proj-item { display: flex; align-items: center; gap: 0.6em; padding: 0.45em 0.75em; border-radius: 0.4em; font-size: 0.9rem; font-weight: 500; color: var(--text2); cursor: pointer; transition: all 0.12s; margin-bottom: 0.08em; }
.proj-item:hover { background: var(--surface2); color: var(--text); }
.proj-item.active { background: var(--surface2); color: var(--text); }
.proj-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.proj-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.btn-new-proj { margin: 0.5em 0 0.5em; display: flex; align-items: center; gap: 0.4em; justify-content: center; padding: 0.5em; border-radius: 0.4em; border: 1px dashed var(--border2); background: none; color: var(--muted); font-size: 0.8rem; font-weight: 500; cursor: pointer; font-family: 'DM Sans', sans-serif; transition: all 0.12s; }
.btn-new-proj:hover { border-color: var(--blue-l); color: var(--blue-l); background: rgba(26,109,232,0.05); }
.sidebar-bottom { padding: 0.75em; border-top: 1px solid var(--border); flex-shrink: 0; }
.user-row { display: flex; align-items: center; gap: 0.7em; padding: 0.5em 0.6em; border-radius: 0.4em; cursor: pointer; }
.user-row:hover { background: var(--surface2); }
.user-avatar { width: 2.2em; height: 2.2em; border-radius: 50%; background: var(--blue); display: grid; place-items: center; font-size: 0.8rem; font-weight: 700; flex-shrink: 0; }
.user-name { font-size: 0.93rem; font-weight: 600; }
.user-company { font-size: 0.8rem; color: var(--muted); }

/* MAIN */
.main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.topbar { height: 52px; flex-shrink: 0; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 1.5em; gap: 1em; }
.topbar-left { display: flex; align-items: center; gap: 0.4em; font-size: 0.82rem; color: var(--muted); }
.topbar-left span { color: var(--text); font-weight: 600; }
.topbar-right { display: flex; align-items: center; gap: 0.6em; }
.tb-btn { display: flex; align-items: center; gap: 0.4em; padding: 0.4em 0.8em; border-radius: 0.4em; font-size: 0.82rem; font-weight: 600; border: 1px solid var(--border2); background: none; color: var(--text2); cursor: pointer; font-family: 'DM Sans', sans-serif; transition: all 0.12s; }
.tb-btn:hover { color: var(--text); border-color: rgba(255,255,255,0.18); background: var(--surface2); }
.tb-btn.primary { background: var(--blue); border-color: var(--blue); color: #fff; }
.tb-btn.primary:hover { opacity: 0.88; }
.content { flex: 1; overflow-y: auto; padding: 1.75em 2em; }

/* VIEWS */
.view { display: none; }
.view.active { display: block; }

/* EMPTY STATE */
.empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center; gap: 0.8em; }
.empty-icon { font-size: 2.5rem; margin-bottom: 0.3em; opacity: 0.5; }
.empty-title { font-size: 1.2rem; font-weight: 700; }
/* SIDEBAR COMPANY BLOCK */
.sidebar-company { padding: 0.75em 1.1em; border-bottom: 1px solid var(--border); flex-shrink: 0; }
.company-name { font-size: 1rem; font-weight: 700; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.company-plan { font-size: 0.78rem; color: var(--muted); margin-top: 0.1em; text-transform: capitalize; }

/* TRANSACTION TYPE TOGGLE */
.type-toggle { display:flex;border:1px solid var(--border2);border-radius:2em;overflow:hidden;flex-shrink:0;width:fit-content; }
.type-toggle button { padding:0.38em 0.85em;border:none;background:none;cursor:pointer;font-size:0.9rem;font-weight:700;color:var(--muted);transition:all 0.12s;font-family:'DM Sans',sans-serif;line-height:1; }
.type-toggle button.active-expense { background:rgba(232,64,64,0.15);color:var(--red); }
.type-toggle button.active-income  { background:rgba(34,197,94,0.15);color:#22c55e; }

/* ALERTS BADGE */
.nav-badge { margin-left: auto; min-width: 1.25em; height: 1.25em; border-radius: 0.65em; background: var(--red); color: #fff; font-size: 0.62rem; font-weight: 700; display: grid; place-items: center; padding: 0 0.3em; }

/* SIDEBAR BOTTOM NAV */
.sidebar-bottom-nav { padding: 0 0.75em 0.3em; flex-shrink: 0; }

.empty-sub { font-size: 0.875rem; color: var(--text2); max-width: 24em; line-height: 1.6; }

/* STATS */
.stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1em; margin-bottom: 1.5em; }
.stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 0.65em; padding: 1em 1.1em; position: relative; overflow: hidden; }
.stat-card::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; border-radius: 2px 2px 0 0; }
.stat-card.s-blue::after { background: var(--blue); }
.stat-card.s-green::after { background: var(--green); }
.stat-card.s-orange::after { background: var(--orange); }
.stat-card.s-red::after { background: var(--red); }
.stat-lbl { font-size: 0.72rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.4em; }
.stat-val { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.03em; line-height: 1; }
.stat-note { font-size: 0.75rem; color: var(--text2); margin-top: 0.3em; }
.c-green { color: var(--green); } .c-orange { color: var(--orange); } .c-red { color: var(--red); } .c-blue { color: var(--blue-l); }

/* DASHBOARD GRID LAYOUT */
.dash-grid { display: grid; grid-template-columns: 1fr 320px; gap: 1.25em; align-items: start; }
.dash-main { min-width: 0; }
.dash-side { display: flex; flex-direction: column; gap: 1.25em; }

/* SECTION CARD */
.section-card { background: var(--surface); border: 1px solid var(--border); border-radius: 0.65em; overflow: hidden; }
.section-card-head { padding: 0.9em 1.2em; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.section-card-title { font-size: 0.78rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: var(--muted); }

/* AT RISK PROJECTS */
.risk-row { display: flex; align-items: center; gap: 0.75em; padding: 0.8em 1.2em; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.1s; }
.risk-row:last-child { border-bottom: none; }
.risk-row:hover { background: rgba(255,255,255,0.02); }
.risk-dot-wrap { flex-shrink: 0; width: 2em; height: 2em; border-radius: 0.4em; display: grid; place-items: center; }
.risk-info { flex: 1; min-width: 0; }
.risk-name { font-size: 0.85rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.risk-meta { font-size: 0.72rem; color: var(--muted); margin-top: 0.1em; }
.risk-right { text-align: right; flex-shrink: 0; }
.risk-pct { font-size: 0.88rem; font-weight: 700; }
.risk-bar-wrap { width: 60px; height: 3px; background: var(--surface3); border-radius: 2px; position: relative; margin-top: 0.25em; margin-left: auto; }
.risk-bar { height: 100%; border-radius: 2px; position: relative; }

/* ACTIVITY FEED */
.activity-item { display: flex; align-items: flex-start; gap: 0.7em; padding: 0.75em 1.2em; border-bottom: 1px solid var(--border); }
.activity-item:last-child { border-bottom: none; }
.activity-icon { width: 1.8em; height: 1.8em; border-radius: 50%; display: grid; place-items: center; flex-shrink: 0; font-size: 0.75rem; margin-top: 0.05em; }
.activity-body { flex: 1; min-width: 0; }
.activity-text { font-size: 0.82rem; line-height: 1.4; }
.activity-text strong { color: var(--text); }
.activity-time { font-size: 0.7rem; color: var(--muted); margin-top: 0.15em; }

/* BURN RATE */
.burn-card { background: var(--surface2); border-radius: 0.5em; padding: 0.85em 1em; display: flex; align-items: center; justify-content: space-between; gap: 0.75em; }
.burn-label { font-size: 0.72rem; color: var(--muted); margin-bottom: 0.2em; }
.burn-val { font-size: 1rem; font-weight: 700; letter-spacing: -0.02em; }

/* BUDGET BARS */
.budget-section { background: var(--surface); border: 1px solid var(--border); border-radius: 0.65em; padding: 1.2em 1.3em; margin-bottom: 1.5em; }
.section-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em; }
.section-title { font-size: 0.82rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: var(--muted); }
.budget-labels { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--muted); margin-top: 0.4em; }
.cat-rows { display: flex; flex-direction: column; gap: 0.75em; }
.cat-row { display: grid; grid-template-columns: 7em 1fr 3.5em 3.5em; gap: 0.75em; align-items: center; }
.cat-name { font-size: 0.82rem; font-weight: 500; }
.cat-pct { font-size: 0.75rem; color: var(--muted); text-align: right; }
.cat-amt { font-size: 0.75rem; color: var(--text2); text-align: right; }

/* Universal bar component */
.bar-wrap { position: relative; border-radius: 4px; overflow: visible; display: block; }
.bar-wrap.bar-sm { height: 5px; border-radius: 3px; }
.bar-wrap.bar-md { height: 8px; border-radius: 4px; }
.bar-track { position: absolute; inset: 0; border-radius: inherit; background: var(--surface3); }
.bar-track.over { background: rgba(100,15,15,0.7); }
.bar-fill { position: absolute; top: 0; left: 0; height: 100%; border-radius: inherit; z-index: 1; box-shadow: 3px 0 10px rgba(0,0,0,0.7); }
.bar-over { position: absolute; top: 0; left: 0; height: 100%; border-radius: inherit; z-index: 2; box-shadow: 3px 0 10px rgba(0,0,0,0.7); }

/* TABLES */
.table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 0.65em; overflow: hidden; }
.table-head { padding: 1em 1.3em; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
.table-title { font-size: 0.82rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: var(--muted); }
table { width: 100%; border-collapse: collapse; }
th { padding: 0.65em 1.2em; text-align: left; font-size: 0.72rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); white-space: nowrap; }
td { padding: 0.75em 1.2em; font-size: 0.85rem; border-bottom: 1px solid var(--border); vertical-align: middle; }
tr:last-child td { border-bottom: none; }
tr:hover td { background: rgba(255,255,255,0.015); }
.tag { display: inline-flex; padding: 0.18em 0.55em; border-radius: 0.3em; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; }
.tag-green { background: rgba(13,160,104,0.12); color: var(--green); }
.tag-orange { background: rgba(217,149,32,0.12); color: var(--orange); }
.tag-blue { background: rgba(26,109,232,0.12); color: var(--blue-l); }
.tag-red { background: rgba(232,64,64,0.12); color: var(--red); }

/* PROJECTS GRID */
.projects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1em; }
.proj-card { background: var(--surface); border: 1px solid var(--border); border-radius: 0.65em; padding: 1.2em 1.3em; cursor: pointer; transition: border-color 0.12s, box-shadow 0.12s; }
.proj-card:hover { border-color: var(--border2); box-shadow: 0 4px 16px rgba(0,0,0,0.3); }
.proj-card-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75em; }
.proj-card-name { font-size: 0.95rem; font-weight: 700; }
.proj-card-meta { font-size: 0.75rem; color: var(--muted); margin-top: 0.15em; }
.proj-card-bar { margin: 0.75em 0; }
.proj-card-foot { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--muted); }
.proj-card-foot strong { color: var(--text2); }
.proj-card-burn { font-size: 0.72rem; color: var(--muted); margin-top: 0.5em; padding-top: 0.5em; border-top: 1px solid var(--border); display: flex; justify-content: space-between; }

/* TEAM */
.team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1em; }
.member-card { background: var(--surface); border: 1px solid var(--border); border-radius: 0.8em; padding: 1.4em; display: flex; flex-direction: column; gap: 0; cursor: pointer; transition: border-color 0.15s, box-shadow 0.15s; position: relative; }
.member-card:hover { border-color: var(--border2); box-shadow: 0 4px 20px rgba(0,0,0,0.25); }
.member-card .member-menu-btn { opacity: 0; transition: opacity 0.15s; }
.member-card:hover .member-menu-btn { opacity: 1; }
.sub-card { background: var(--surface); border: 1px solid var(--border); border-radius: 0.8em; padding: 1.25em 1.4em; cursor: pointer; transition: border-color 0.15s, box-shadow 0.15s; }
.sub-card:hover { border-color: var(--border2); box-shadow: 0 4px 20px rgba(0,0,0,0.25); }
.sub-status-active { background:rgba(13,160,104,0.12);color:#0da068;border:1px solid rgba(13,160,104,0.25); }
.sub-status-pending { background:rgba(217,149,32,0.12);color:#d99520;border:1px solid rgba(217,149,32,0.25); }
.sub-status-complete { background:rgba(255,255,255,0.06);color:var(--muted);border:1px solid var(--border); }
.member-avatar { width: 3.2em; height: 3.2em; border-radius: 50%; display: grid; place-items: center; font-size: 1.1rem; font-weight: 700; flex-shrink: 0; overflow: hidden; }
.member-name { font-size: 0.95rem; font-weight: 700; }
.member-role { font-size: 0.75rem; color: var(--text2); }
.member-stats { display: flex; gap: 0.75em; margin-top: 0.3em; }
.member-stat { text-align: center; }
.member-stat-val { font-size: 0.88rem; font-weight: 700; }
.member-stat-lbl { font-size: 0.65rem; color: var(--muted); }

/* ALERTS */
.alert-item { display: flex; align-items: flex-start; gap: 0.85em; padding: 1em 1.3em; border-bottom: 1px solid var(--border); transition: background 0.1s; cursor: pointer; }
.alert-item:last-child { border-bottom: none; }
.alert-item:hover { background: rgba(255,255,255,0.02); }
.alert-icon { width: 2em; height: 2em; border-radius: 50%; display: grid; place-items: center; flex-shrink: 0; }
.alert-body { flex: 1; }
.alert-title { font-size: 0.875rem; font-weight: 600; }
.alert-desc { font-size: 0.78rem; color: var(--text2); margin-top: 0.2em; line-height: 1.45; }
.alert-time { font-size: 0.7rem; color: var(--muted); margin-top: 0.3em; }
.alert-severity { padding: 0.2em 0.5em; border-radius: 0.3em; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; flex-shrink: 0; align-self: center; }

/* REPORTS */
.report-card { background: var(--surface); border: 1px solid var(--border); border-radius: 0.65em; padding: 1.3em; cursor: pointer; transition: border-color 0.12s, box-shadow 0.12s; display: flex; align-items: center; gap: 1em; }
.report-card:hover { border-color: var(--border2); box-shadow: 0 4px 16px rgba(0,0,0,0.2); }
.report-icon { width: 2.5em; height: 2.5em; border-radius: 0.5em; background: rgba(26,109,232,0.1); display: grid; place-items: center; flex-shrink: 0; }
.report-info { flex: 1; }
.report-name { font-size: 0.9rem; font-weight: 700; }
.report-desc { font-size: 0.75rem; color: var(--muted); margin-top: 0.15em; }
.reports-grid { display: flex; flex-direction: column; gap: 0.75em; }
.report-filter-btn { padding:0.4em 0.95em;border:1px solid var(--border);border-radius:0.45em;background:var(--surface2);color:var(--muted);font-size:0.8rem;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all 0.12s; }
.report-filter-btn:hover { border-color:var(--border2);color:var(--text); }
.report-filter-btn.active { background:var(--blue);border-color:var(--blue);color:#fff; }
.an-metric-card { background:var(--surface);border:1px solid var(--border);border-radius:0.75em;padding:1.1em 1.25em;cursor:pointer;transition:border-color 0.15s,background 0.15s;user-select:none; }
.an-metric-card:hover { border-color:var(--border2); }
.an-metric-card.active { border-color:var(--blue);background:rgba(26,109,232,0.07); }
.an-metric-label { font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--muted);margin-bottom:0.4em; }
.an-metric-val { font-size:1.35rem;font-weight:700;letter-spacing:-0.03em; }
.an-metric-card.active .an-metric-val { color:var(--blue-l); }
.an-filter-pill { padding:0.35em 0.8em;border:1px solid var(--border);border-radius:0.4em;background:var(--surface2);color:var(--muted);font-size:0.75rem;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all 0.12s; }
.an-filter-pill:hover { border-color:var(--border2);color:var(--text); }
.an-filter-pill.active { background:var(--surface3);border-color:var(--border2);color:var(--text); }
.an-proj-row { display:grid;grid-template-columns:1fr 100px 100px 90px 140px;gap:0.5em;align-items:center;padding:0.85em 1.15em;border-bottom:1px solid var(--border);font-size:0.83rem; }
.an-proj-row:last-child { border-bottom:none; }
.an-proj-head { font-size:0.63rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--muted);padding:0.65em 1.15em;border-bottom:1px solid var(--border);display:grid;grid-template-columns:1fr 100px 100px 90px 140px;gap:0.5em; }

/* MODAL */
.modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.18s; padding: 1rem; }
.modal-bg.open { opacity: 1; pointer-events: all; }
.modal { background: var(--surface); border: 1px solid var(--border2); border-radius: 0.85em; padding: 1.8em 2em; width: 100%; max-width: 480px; box-shadow: 0 2em 5em rgba(0,0,0,0.6); transform: translateY(0.8em) scale(0.98); transition: transform 0.18s; max-height: 90vh; overflow-y: auto; }
.modal-bg.open .modal { transform: none; }
.modal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.4em; }
.modal-title { font-size: 1.05rem; font-weight: 700; }
.modal-close { background: none; border: none; color: var(--muted); font-size: 1.1rem; cursor: pointer; padding: 0.1em 0.3em; transition: color 0.12s; }
.modal-close:hover { color: var(--text); }
.field { margin-bottom: 1rem; }
.field label { display: block; font-size: 0.78rem; font-weight: 600; color: var(--text2); margin-bottom: 0.35em; }
.field input, .field select, .field textarea { width: 100%; background: var(--surface2); border: 1px solid var(--border2); border-radius: 0.45em; padding: 0.6em 0.8em; font-size: 0.875rem; color: var(--text); font-family: 'DM Sans', sans-serif; outline: none; transition: border-color 0.12s, box-shadow 0.12s; resize: vertical; }
.field input::placeholder, .field textarea::placeholder { color: var(--muted); }
.field input:focus, .field select:focus, .field textarea:focus { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(26,109,232,0.15); }
.field select { appearance: none; -webkit-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8' fill='none'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%239aa3b4' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.8em center; padding-right: 2em; cursor: pointer; }
.field select option { background: var(--surface2); }
.modal-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75em; }
.modal-foot { display: flex; justify-content: flex-end; gap: 0.6em; margin-top: 1.4em; }
.btn-cancel { padding: 0.55em 1.1em; border-radius: 0.4em; border: 1px solid var(--border2); background: none; color: var(--text2); font-size: 0.875rem; font-weight: 500; cursor: pointer; font-family: 'DM Sans', sans-serif; transition: all 0.12s; }
.btn-cancel:hover { color: var(--text); }
.btn-save { padding: 0.55em 1.3em; border-radius: 0.4em; border: none; background: var(--blue); color: #fff; font-size: 0.875rem; font-weight: 600; cursor: pointer; font-family: 'DM Sans', sans-serif; transition: opacity 0.12s; }
.btn-save:hover { opacity: 0.88; }

/* MISC */
.page-header { margin-bottom: 1.5em; }
.page-title { font-size: 1.4rem; font-weight: 700; letter-spacing: -0.025em; }
.page-sub { font-size: 0.85rem; color: var(--text2); margin-top: 0.2em; }
.trial-banner { background: rgba(26,109,232,0.08); border: 1px solid rgba(26,109,232,0.2); border-radius: 0.5em; padding: 0.65em 1em; display: flex; align-items: center; justify-content: space-between; font-size: 0.82rem; margin-bottom: 1.5em; gap: 1em; }
.trial-banner strong { color: var(--blue-l); }
.trial-upgrade { padding: 0.35em 0.75em; border-radius: 0.35em; background: var(--blue); color: #fff; font-size: 0.78rem; font-weight: 600; border: none; cursor: pointer; font-family: 'DM Sans', sans-serif; white-space: nowrap; }
.dot-colors { display: flex; gap: 0.4em; flex-wrap: wrap; }
.dot-color { width: 1.2em; height: 1.2em; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: border-color 0.12s; }
.dot-color.selected { border-color: #fff; }
.del-btn { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 0.75rem; padding: 0.2em 0.4em; border-radius: 0.3em; transition: color 0.12s; }
.del-btn:hover { color: var(--red); }
.divider { height: 1px; background: var(--border); margin: 0.4em 0.75em; }

/* EDITABLE STAT CARDS */
.stat-card.editable { cursor:pointer; transition:border-color 0.12s, box-shadow 0.12s; }
.stat-card.editable:hover { border-color:var(--border2); box-shadow:0 0 0 2px rgba(26,109,232,0.15); }
.stat-card.editable:hover .stat-edit-hint { opacity:1; }
.stat-edit-hint { opacity:0; font-size:0.65rem; color:var(--blue-l); margin-top:0.25em; transition:opacity 0.12s; }

/* CLICKABLE TABLE ROWS */
.pu-row { cursor:pointer; }
.pu-row:hover td { background:rgba(26,109,232,0.05) !important; }

/* CATEGORY CHIPS */
.cat-chip { display:flex; align-items:center; gap:0.5em; padding:0.45em 0.7em; border-radius:0.4em; background:var(--surface2); border:1px solid var(--border); font-size:0.82rem; }
.cat-chip-all { border-color:rgba(26,109,232,0.25); background:rgba(26,109,232,0.06); }
.cat-chip-name { font-weight:600; }
.cat-chip-pct { font-size:0.7rem; color:var(--blue-l); font-weight:700; background:rgba(26,109,232,0.1); padding:0.1em 0.4em; border-radius:0.25em; }
.cat-chip-del { margin-left:auto; background:none; border:none; cursor:pointer; color:var(--muted); font-size:0.85rem; padding:0 0.1em; line-height:1; transition:color 0.12s; }
.cat-chip-del:hover { color:var(--red); }

/* FILTER ROW */
.filter-row { display: flex; gap: 0.5em; padding: 0.75em 1.2em; border-bottom: 1px solid var(--border); flex-wrap: wrap; }
.filter-input { background: var(--surface2); border: 1px solid var(--border); border-radius: 0.4em; padding: 0.4em 0.75em; font-size: 0.82rem; color: var(--text); font-family: 'DM Sans', sans-serif; outline: none; transition: border-color 0.12s; }
.filter-input:focus { border-color: var(--blue); }
.filter-input::placeholder { color: var(--muted); }

@media(max-width:1100px) { .dash-grid { grid-template-columns: 1fr; } }
@media(max-width:800px) { .stats-row { grid-template-columns: 1fr 1fr; } }
</style>
</head>
<body>

<!-- MODALS -->
<div class="modal-bg" id="newProjModal">
  <div class="modal" style="max-width:520px">
    <div class="modal-head"><div class="modal-title">New Project</div><button class="modal-close" onclick="closeModal('newProjModal')">✕</button></div>
    <div class="field"><label>Project name</label><input type="text" id="np-name" placeholder="e.g. Riverside Remodel"/></div>
    <div class="modal-row">
      <div class="field"><label>Client name</label><input type="text" id="np-client" placeholder="John Smith"/></div>
      <div class="field"><label>Location</label><input type="text" id="np-location" placeholder="123 Oak St, Denver CO"/></div>
    </div>
    <div class="field"><label>Total budget ($)</label><input type="number" id="np-budget" placeholder="50000" min="0"/></div>
    <div class="modal-row">
      <div class="field"><label>Start date</label><input type="date" id="np-start" style="resize:none"/></div>
      <div class="field"><label>End date</label><input type="date" id="np-end" style="resize:none"/></div>
    </div>
    <div class="field"><label>Color</label>
      <div class="dot-colors">
        <div class="dot-color selected" style="background:#3b82f6" data-color="#3b82f6" onclick="pickColor(this)"></div>
        <div class="dot-color" style="background:#0da068" data-color="#0da068" onclick="pickColor(this)"></div>
        <div class="dot-color" style="background:#d99520" data-color="#d99520" onclick="pickColor(this)"></div>
        <div class="dot-color" style="background:#e84040" data-color="#e84040" onclick="pickColor(this)"></div>
        <div class="dot-color" style="background:#8b5cf6" data-color="#8b5cf6" onclick="pickColor(this)"></div>
        <div class="dot-color" style="background:#ec4899" data-color="#ec4899" onclick="pickColor(this)"></div>
      </div>
    </div>

    <!-- CATEGORY BUILDER -->
    <div class="field">
      <label>Budget categories</label>
      <!-- Add category row -->
      <div style="display:flex;gap:0.5em;align-items:center">
        <input type="text" id="np-cat-name" placeholder="Category name" style="flex:1;background:var(--surface2);border:1px solid var(--border2);border-radius:0.45em;padding:0.55em 0.75em;font-size:0.875rem;color:var(--text);font-family:'DM Sans',sans-serif;outline:none;transition:border-color 0.12s"/>
        <input type="number" id="np-cat-pct" placeholder="%" min="1" max="100" style="width:4em;background:var(--surface2);border:1px solid var(--border2);border-radius:0.45em;padding:0.55em 0.6em;font-size:0.875rem;color:var(--text);font-family:'DM Sans',sans-serif;outline:none;text-align:center;transition:border-color 0.12s"/>
        <button onclick="addCategory()" style="width:2.2em;height:2.2em;border-radius:0.4em;border:none;background:var(--blue);color:#fff;font-size:1.1rem;cursor:pointer;display:grid;place-items:center;flex-shrink:0;transition:opacity 0.12s" title="Add category">+</button>
      </div>
      <div id="np-cat-err" style="font-size:0.72rem;color:var(--red);margin-top:0.3em;display:none"></div>
      <div style="font-size:0.72rem;color:var(--muted);margin-top:0.4em">% = portion of total budget allocated to this category. Optional.</div>
      <!-- Category chips appear below -->
      <div id="np-cats-list" style="display:flex;flex-direction:column;gap:0.4em;margin-top:0.6em">
        <div class="cat-chip cat-chip-all">
          <span style="font-size:0.8rem;font-weight:600">All</span>
          <span style="font-size:0.72rem;color:var(--muted);margin-left:auto">Tracks total spend</span>
        </div>
      </div>
    </div>

    <div id="np-workers-field" class="field" style="margin-bottom:0.5em">
      <label>Assign Workers</label>
      <div id="np-workers-list" style="display:flex;flex-direction:column;gap:0.4em;max-height:9em;overflow-y:auto"></div>
    </div>
    <div class="modal-foot">
      <button class="btn-cancel" onclick="closeModal('newProjModal')">Cancel</button>
      <button class="btn-save" onclick="saveNewProject()">Create Project</button>
    </div>
  </div>
</div>

<!-- ASSIGN WORKERS MODAL -->
<div class="modal-bg" id="assignWorkersModal">
  <div class="modal" style="max-width:400px">
    <div class="modal-head">
      <div class="modal-title">Assign Workers</div>
      <button class="modal-close" onclick="closeModal('assignWorkersModal')">✕</button>
    </div>
    <div class="field">
      <label>Select workers for this project</label>
      <div id="aw-list" style="display:flex;flex-direction:column;gap:0.5em;max-height:16em;overflow-y:auto"></div>
    </div>
    <div class="modal-foot">
      <button class="btn-cancel" onclick="closeModal('assignWorkersModal')">Cancel</button>
      <button class="btn-save" onclick="saveAssignWorkers()">Save</button>
    </div>
  </div>
</div>

<!-- ADD SUBCONTRACTOR -->
<div class="modal-bg" id="addSubModal">
  <div class="modal" style="max-width:440px">
    <div class="modal-head">
      <div class="modal-title">Add Subcontractor</div>
      <button class="modal-close" onclick="closeModal('addSubModal')">✕</button>
    </div>
    <div class="field"><label>Name</label><input type="text" id="sub-name" placeholder="e.g. Martinez Electric"/></div>
    <div class="field"><label>Trade / Scope <span style="font-weight:400;color:var(--muted)">(optional)</span></label><input type="text" id="sub-trade" placeholder="e.g. Electrical, Plumbing, HVAC"/></div>
    <div class="modal-foot">
      <button class="btn-cancel" onclick="closeModal('addSubModal')">Cancel</button>
      <button class="btn-save" onclick="saveNewSub()">Add Subcontractor</button>
    </div>
  </div>
</div>

<!-- SUB DETAIL / EDIT -->
<div class="modal-bg" id="subDetailModal">
  <div class="modal" style="max-width:480px">
    <div class="modal-head">
      <div>
        <div class="modal-title" id="subDetailName"></div>
        <div style="font-size:0.78rem;color:var(--muted);margin-top:0.15em" id="subDetailTrade"></div>
      </div>
      <button class="modal-close" onclick="closeModal('subDetailModal')">✕</button>
    </div>
    <!-- Project entries -->
    <div style="margin-bottom:1em">
      <div style="font-size:0.75rem;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--muted);margin-bottom:0.65em">Project Work</div>
      <div id="subProjectList" style="display:flex;flex-direction:column;gap:0.5em;max-height:14em;overflow-y:auto"></div>
    </div>
    <!-- Add project entry -->
    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:0.6em;padding:0.9em;margin-bottom:0.5em">
      <div style="font-size:0.75rem;font-weight:600;color:var(--text2);margin-bottom:0.65em">Add Project</div>
      <div class="modal-row">
        <div class="field" style="margin:0"><label>Project</label><select id="sub-proj-select" style="width:100%;background:var(--surface);border:1px solid var(--border2);border-radius:0.45em;padding:0.6em 0.75em;font-size:0.875rem;color:var(--text);font-family:'DM Sans',sans-serif;outline:none"></select></div>
        <div class="field" style="margin:0"><label>Contract ($)</label><input type="number" id="sub-contract-amt" placeholder="10000" min="0"/></div>
      </div>
      <div class="modal-row" style="margin-top:0.65em">
        <div class="field" style="margin:0"><label>Status</label>
          <select id="sub-status" style="width:100%;background:var(--surface);border:1px solid var(--border2);border-radius:0.45em;padding:0.6em 0.75em;font-size:0.875rem;color:var(--text);font-family:'DM Sans',sans-serif;outline:none">
            <option>Pending</option><option>Active</option><option>Complete</option>
          </select>
        </div>
        <div class="field" style="margin:0;display:flex;align-items:flex-end">
          <button class="btn-save" style="width:100%;margin:0" onclick="addSubProjectEntry()">Add</button>
        </div>
      </div>
    </div>
    <div class="modal-foot" style="justify-content:space-between">
      <button onclick="deleteCurrentSub()" style="background:none;border:none;color:var(--red);font-size:0.82rem;cursor:pointer;font-family:'DM Sans',sans-serif;padding:0">Remove Subcontractor</button>
      <button class="btn-cancel" onclick="closeModal('subDetailModal')">Close</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="laborModal">
  <div class="modal" style="max-width:480px">
    <div class="modal-head">
      <div class="modal-title">Labor Estimate</div>
      <button class="modal-close" onclick="closeModal('laborModal')">✕</button>
    </div>
    <div id="labor-modal-body" style="padding:0 0 0.5em"></div>
    <div class="modal-foot">
      <button class="btn-cancel" onclick="closeModal('laborModal')">Close</button>
      <button class="btn-save" onclick="saveLaborModal()">Save</button>
    </div>
  </div>
</div>
</div>

<!-- QUICK ADD PURCHASE (from project detail — no project/date/worker fields) -->
<div class="modal-bg" id="quickPurchaseModal">
  <div class="modal" style="max-width:400px">
    <div class="modal-head">
      <div>
        <div class="modal-title">Add Transaction</div>
        <div id="qpu-proj-label" style="font-size:0.75rem;color:var(--muted);margin-top:0.15em"></div>
      </div>
      <button class="modal-close" onclick="closeModal('quickPurchaseModal')">✕</button>
    </div>
    <div class="field"><label>Vendor / Description</label><input type="text" id="qpu-vendor" placeholder="Home Depot"/></div>
    <div class="field">
      <label>Amount ($)</label>
      <div style="display:flex;gap:0.6em;align-items:center">
        <div class="type-toggle" id="qpu-type-toggle">
          <button id="qpu-btn-expense" class="active-expense" onclick="setTxType('qpu','expense')">−</button>
          <button id="qpu-btn-income" onclick="setTxType('qpu','income')">+</button>
        </div>
        <input type="number" id="qpu-amount" placeholder="0.00" min="0" step="0.01" style="flex:1"/>
      </div>
    </div>
    <div class="field"><label>Category</label><select id="qpu-category"></select></div>
    <div class="field"><label>Notes (optional)</label><textarea id="qpu-notes" rows="2" placeholder="Any details..." style="resize:none"></textarea></div>
    <div class="modal-foot">
      <button class="btn-cancel" onclick="closeModal('quickPurchaseModal')">Cancel</button>
      <button class="btn-save" onclick="saveQuickPurchase()">Add Transaction</button>
    </div>
  </div>
</div>

<!-- FULL ADD TRANSACTION (from transactions tab / other views) -->
<div class="modal-bg" id="newPurchaseModal">
  <div class="modal">
    <div class="modal-head"><div class="modal-title">Add Transaction</div><button class="modal-close" onclick="closeModal('newPurchaseModal')">✕</button></div>
    <div class="field"><label>Vendor / Description</label><input type="text" id="pu-vendor" placeholder="Home Depot"/></div>
    <div class="field">
      <label>Amount ($)</label>
      <div style="display:flex;gap:0.6em;align-items:center">
        <div class="type-toggle" id="pu-type-toggle">
          <button id="pu-btn-expense" class="active-expense" onclick="setTxType('pu','expense')">−</button>
          <button id="pu-btn-income" onclick="setTxType('pu','income')">+</button>
        </div>
        <input type="number" id="pu-amount" placeholder="0.00" min="0" step="0.01" style="flex:1"/>
      </div>
    </div>
    <div class="modal-row">
      <div class="field"><label>Project</label><select id="pu-project" onchange="updatePurchaseCats()"></select></div>
      <div class="field"><label>Category</label><select id="pu-category"></select></div>
    </div>
    <div class="modal-row">
      <div class="field"><label>Date</label><input type="date" id="pu-date" style="resize:none"/></div>
      <div class="field"><label>Added by</label><select id="pu-worker"></select></div>
    </div>
    <div class="field"><label>Notes (optional)</label><textarea id="pu-notes" rows="2" placeholder="Any details..." style="resize:none"></textarea></div>
    <div class="modal-foot">
      <button class="btn-cancel" onclick="closeModal('newPurchaseModal')">Cancel</button>
      <button class="btn-save" onclick="saveNewPurchase()">Add Transaction</button>
    </div>
  </div>
</div>

<!-- PURCHASE DETAIL / EDIT -->
<div class="modal-bg" id="purchaseDetailModal">
  <div class="modal" style="max-width:420px">
    <div class="modal-head">
      <div class="modal-title">Transaction Details</div>
      <button class="modal-close" onclick="closeModal('purchaseDetailModal')">✕</button>
    </div>
    <!-- VIEW MODE -->
    <div id="pd-view">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75em;margin-bottom:1em">
        <div style="background:var(--surface2);border-radius:0.5em;padding:0.75em 0.9em">
          <div style="font-size:0.68rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.3em">Amount</div>
          <div id="pd-amount" style="font-size:1.3rem;font-weight:700;letter-spacing:-0.02em"></div>
        </div>
        <div style="background:var(--surface2);border-radius:0.5em;padding:0.75em 0.9em">
          <div style="font-size:0.68rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.3em">Category</div>
          <div id="pd-category" style="font-size:0.9rem;font-weight:600"></div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:0.5em;margin-bottom:1.2em">
        <div style="display:flex;justify-content:space-between;font-size:0.85rem;padding:0.5em 0;border-bottom:1px solid var(--border)">
          <span style="color:var(--muted)">Vendor</span><span id="pd-vendor" style="font-weight:600"></span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:0.85rem;padding:0.5em 0;border-bottom:1px solid var(--border)">
          <span style="color:var(--muted)">Date</span><span id="pd-date"></span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:0.85rem;padding:0.5em 0;border-bottom:1px solid var(--border)">
          <span style="color:var(--muted)">Added by</span><span id="pd-worker"></span>
        </div>
        <div id="pd-notes-row" style="display:flex;flex-direction:column;gap:0.3em;font-size:0.85rem;padding:0.5em 0">
          <span style="color:var(--muted)">Notes</span><span id="pd-notes" style="color:var(--text2);line-height:1.5"></span>
        </div>
      </div>
      <div style="display:flex;justify-content:space-between;gap:0.6em">
        <button class="btn-cancel" style="color:var(--red);border-color:rgba(232,64,64,0.3)" onclick="deletePurchaseFromDetail()">Delete</button>
        <button class="btn-save" onclick="switchToEditMode()">Edit Transaction</button>
      </div>
    </div>
    <!-- EDIT MODE -->
    <div id="pd-edit" style="display:none">
      <div class="field"><label>Vendor / Description</label><input type="text" id="pd-edit-vendor"/></div>
      <div class="field">
        <label>Amount ($)</label>
        <div style="display:flex;gap:0.6em;align-items:center">
          <div class="type-toggle" id="pd-type-toggle">
            <button id="pd-btn-expense" class="active-expense" onclick="setTxType('pd','expense')">−</button>
            <button id="pd-btn-income" onclick="setTxType('pd','income')">+</button>
          </div>
          <input type="number" id="pd-edit-amount" min="0" step="0.01" style="flex:1"/>
        </div>
      </div>
      <div class="field"><label>Category</label><select id="pd-edit-category"></select></div>
      <div class="modal-row">
        <div class="field"><label>Date</label><input type="date" id="pd-edit-date" style="resize:none"/></div>
        <div class="field"><label>Added by</label><input type="text" id="pd-edit-worker"/></div>
      </div>
      <div class="field"><label>Notes</label><textarea id="pd-edit-notes" rows="2" style="resize:none" placeholder="Any details..."></textarea></div>
      <div style="display:flex;justify-content:space-between;gap:0.6em;margin-top:1.2em">
        <button class="btn-cancel" onclick="switchToViewMode()">← Back</button>
        <button class="btn-save" onclick="savePurchaseEdit()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- EDIT PROJECT FIELD (inline popover-style modal) -->
<div class="modal-bg" id="editFieldModal">
  <div class="modal" style="max-width:380px">
    <div class="modal-head">
      <div class="modal-title" id="ef-title">Edit Field</div>
      <button class="modal-close" onclick="closeModal('editFieldModal')">✕</button>
    </div>
    <div class="field">
      <label id="ef-label"></label>
      <input type="text"   id="ef-input-text"   style="display:none"/>
      <input type="number" id="ef-input-number" style="display:none" min="0"/>
      <input type="date"   id="ef-input-date"   style="display:none;resize:none"/>
    </div>
    <div class="modal-foot">
      <button class="btn-cancel" onclick="closeModal('editFieldModal')">Cancel</button>
      <button class="btn-save"   onclick="saveFieldEdit()">Save</button>
    </div>
  </div>
</div>

<!-- EDIT CATEGORIES (for existing project) -->
<div class="modal-bg" id="editCatsModal">
  <div class="modal" style="max-width:480px">
    <div class="modal-head">
      <div class="modal-title">Edit Categories</div>
      <button class="modal-close" onclick="closeModal('editCatsModal')">✕</button>
    </div>
    <div style="display:flex;gap:0.5em;align-items:center">
      <input type="text"   id="ec-cat-name" placeholder="Category name" style="flex:1;background:var(--surface2);border:1px solid var(--border2);border-radius:0.45em;padding:0.55em 0.75em;font-size:0.875rem;color:var(--text);font-family:'DM Sans',sans-serif;outline:none"/>
      <input type="number" id="ec-cat-pct"  placeholder="%" min="1" max="100" style="width:4em;background:var(--surface2);border:1px solid var(--border2);border-radius:0.45em;padding:0.55em 0.6em;font-size:0.875rem;color:var(--text);font-family:'DM Sans',sans-serif;outline:none;text-align:center"/>
      <button onclick="ecAddCategory()" style="width:2.2em;height:2.2em;border-radius:0.4em;border:none;background:var(--blue);color:#fff;font-size:1.1rem;cursor:pointer;display:grid;place-items:center;flex-shrink:0">+</button>
    </div>
    <div id="ec-err" style="font-size:0.72rem;color:var(--red);margin-top:0.3em;display:none"></div>
    <div id="ec-chips-list" style="display:flex;flex-direction:column;gap:0.4em;margin-top:0.75em"></div>
    <div class="modal-foot">
      <button class="btn-cancel" onclick="closeModal('editCatsModal')">Cancel</button>
      <button class="btn-save"   onclick="saveEditedCats()">Save Categories</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="newMemberModal">
  <div class="modal">
    <div class="modal-head"><div class="modal-title">Add Team Member</div><button class="modal-close" onclick="closeModal('newMemberModal')">✕</button></div>
    <div class="modal-row">
      <div class="field"><label>First name</label><input type="text" id="tm-first" placeholder="Jane"/></div>
      <div class="field"><label>Last name</label><input type="text" id="tm-last" placeholder="Doe"/></div>
    </div>
    <div class="field"><label>Email</label><input type="email" id="tm-email" placeholder="jane@company.com"/></div>
    <div class="field"><label>Role</label>
      <select id="tm-role">
        <option>Foreman</option><option>Worker</option><option>Project Manager</option>
        <option>Accountant</option><option>Admin</option><option>Subcontractor</option>
      </select>
    </div>
    <div class="modal-foot">
      <button class="btn-cancel" onclick="closeModal('newMemberModal')">Cancel</button>
      <button class="btn-save" onclick="saveNewMember()">Add Member</button>
    </div>
  </div>
</div>

<div class="app">
  <aside class="sidebar">
    <!-- FIXED TOP -->
    <a href="index.html" class="sidebar-logo" style="flex-shrink:0">
      <div class="logo-mark"><svg viewBox="0 0 14 14" fill="none" width="14" height="14"><path d="M3 3h8M3 7h5M3 11V3" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
      <span class="logo-name">Forge<span class="tld">.inc</span></span>
    </a>
    <div class="sidebar-company" style="flex-shrink:0;cursor:pointer;transition:background 0.12s" onclick="openCompanyInfo()" title="Company info"
      onmouseenter="this.style.background='rgba(255,255,255,0.04)'" onmouseleave="this.style.background=''">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:0.5em">
        <div style="display:flex;align-items:center;gap:0.6em;min-width:0">
          <div id="companyLogoDisplay" style="width:36px;height:36px;border-radius:7px;background:var(--blue);display:grid;place-items:center;flex-shrink:0;overflow:hidden;font-size:0.75rem;font-weight:700;color:#fff"></div>
          <div style="min-width:0">
            <div class="company-name" id="sidebarCompany">—</div>
            <div class="company-plan" id="sidebarPlan">—</div>
          </div>
        </div>
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none" style="flex-shrink:0;color:var(--muted)"><path d="M2 4l4 4 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
    </div>

    <!-- SCROLLABLE MIDDLE -->
    <div style="flex:1;overflow-y:auto;min-height:0;">
      <div class="sidebar-section">
        <div class="nav-item active" onclick="showView('dashboard')" id="nav-dashboard">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><rect x="1" y="1" width="5" height="5" rx="1" stroke="currentColor" stroke-width="1.4"/><rect x="8" y="1" width="5" height="5" rx="1" stroke="currentColor" stroke-width="1.4"/><rect x="1" y="8" width="5" height="5" rx="1" stroke="currentColor" stroke-width="1.4"/><rect x="8" y="8" width="5" height="5" rx="1" stroke="currentColor" stroke-width="1.4"/></svg>
          Dashboard
        </div>
        <div class="nav-item" onclick="showView('purchases')" id="nav-purchases">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><rect x="2" y="1" width="10" height="12" rx="1.2" stroke="currentColor" stroke-width="1.4"/><path d="M4 5h6M4 8h4" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/></svg>
          Transactions
        </div>
        <div class="nav-item" onclick="showView('team')" id="nav-team">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><circle cx="5" cy="4.5" r="2" stroke="currentColor" stroke-width="1.4"/><path d="M1 12c0-2.2 1.8-4 4-4s4 1.8 4 4" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/><path d="M10 6.5c1.1 0 2 .9 2 2M10 12h3" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/></svg>
          Team
        </div>
        <div class="nav-item" onclick="showView('alerts')" id="nav-alerts">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M7 1a4 4 0 014 4v3l1 2H2l1-2V5a4 4 0 014-4z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/><path d="M5.5 12a1.5 1.5 0 003 0" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/></svg>
          Notifications
          <span class="nav-badge" id="alertsBadge" style="display:none">0</span>
        </div>
        <div class="nav-item" onclick="showView('reports')" id="nav-reports">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><rect x="2" y="1" width="10" height="12" rx="1.2" stroke="currentColor" stroke-width="1.4"/><path d="M4 4h6M4 7h6M4 10h3" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/></svg>
          Reports
        </div>
        <div class="nav-item" onclick="showView('analytics')" id="nav-analytics">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M1 11l3.5-4 3 2.5L11 4" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="4" r="1.2" fill="currentColor"/></svg>
          Analytics
        </div>
      </div>
      <div class="divider"></div>
      <div class="sidebar-section">
        <div class="sidebar-label">Projects</div>
        <div id="sidebarProjects"></div>
      </div>
    </div>

    <!-- FIXED BOTTOM -->
    <div class="sidebar-bottom" style="flex-shrink:0">
      <div class="user-row" onclick="openProfileModal()" title="Edit profile">
        <div class="user-avatar" id="userAvatar" style="overflow:hidden">?</div>
        <div style="flex:1;min-width:0"><div class="user-name" id="userName">...</div><div class="user-company" id="userRole">Admin</div></div>
        <button style="background:none;border:none;cursor:pointer;color:var(--muted);padding:0.2em;transition:color 0.12s" title="Sign out" onclick="event.stopPropagation();signOut()" onmouseover="this.style.color='var(--text)'" onmouseout="this.style.color='var(--muted)'">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M5 2H2a1 1 0 00-1 1v8a1 1 0 001 1h3M9 10l3-3-3-3M12 7H5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
    </div>
  </aside>

  <div class="main">
    <div class="topbar">
      <div class="topbar-left" id="topbarCrumb"><span>Dashboard</span></div>
      <div class="topbar-right" id="topbarActions"></div>
    </div>
    <div class="content">
      <div class="trial-banner" id="trialBanner" style="display:none">
        <span>🎉 <strong id="trialDays">14 days</strong> left in your free trial.</span>
        <button class="trial-upgrade" onclick="showAlert('Billing & plan upgrades coming soon!', 'Coming Soon')">Upgrade Now</button>
      </div>

      <!-- OVERVIEW -->
      <div class="view active" id="view-dashboard">
        <div class="page-header" style="display:flex;justify-content:space-between;align-items:flex-start">
          <div><div class="page-title">Dashboard</div><div class="page-sub" id="dashSub"></div></div>
          <button class="tb-btn primary" onclick="openModal('newProjModal')">+ New Project</button>
        </div>
        <div class="stats-row" id="dashStats"></div>

        <div class="dash-grid">
          <div class="dash-main">
            <!-- Projects grid -->
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75em">
              <div style="font-size:0.78rem;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted)">Active Projects</div>
            </div>
            <div class="projects-grid" id="dashProjects"></div>
            <div class="empty-state" id="dashEmpty" style="display:none">
              <div class="empty-icon">📋</div>
              <div class="empty-title">No projects yet</div>
              <div class="empty-sub">Create your first project to start tracking budgets and transactions.</div>
              <button class="tb-btn primary" style="margin-top:0.5em" onclick="openModal('newProjModal')">+ New Project</button>
            </div>
          </div>

          <div class="dash-side">
            <!-- At Risk -->
            <div class="section-card" id="atRiskCard">
              <div class="section-card-head">
                <div class="section-card-title">⚠ Needs Attention</div>
                <span class="tag tag-orange" id="atRiskCount">0 jobs</span>
              </div>
              <div id="atRiskList"></div>
            </div>

            <!-- Recent Activity -->
            <div class="section-card">
              <div class="section-card-head">
                <div class="section-card-title">Recent Activity</div>
              </div>
              <div id="activityFeed"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- PROJECT DETAIL -->
      <div class="view" id="view-project">
        <div class="page-header" style="display:flex;justify-content:space-between;align-items:flex-start">
          <div>
            <div class="page-title" id="projDetailName" style="cursor:pointer;display:inline-flex;align-items:center;gap:0.4em" onclick="editProjectField('name')" title="Click to edit">
              <span id="projDetailNameText"></span>
              <svg width="12" height="12" viewBox="0 0 12 12" fill="none" style="color:var(--muted);flex-shrink:0"><path d="M8.5 1.5l2 2-7 7H1.5v-2l7-7z" stroke="currentColor" stroke-width="1.3" stroke-linejoin="round"/></svg>
            </div>
            <div class="page-sub" id="projDetailMeta"></div>
          </div>
          <div style="display:flex;gap:0.6em">
            <button id="projLaborBtn" class="tb-btn" style="font-size:0.78rem;display:none" onclick="openLaborModal(activeProject)">⏱ Labor</button>
            <button id="projAssignBtn" class="tb-btn" style="font-size:0.78rem;display:none" onclick="openAssignWorkersModal(activeProject)">👥 Assign Workers</button>
            <button class="tb-btn primary" onclick="openQuickPurchase()">+ Add Transaction</button>
            <button class="tb-btn" style="color:var(--red);border-color:rgba(232,64,64,0.25)" onclick="deleteCurrentProject()">Delete</button>
          </div>
        </div>
        <div class="stats-row" id="projStats"></div>
        <div class="budget-section" id="projBudgetSection"></div>
        <div class="table-wrap" style="margin-top:1.5em">
          <div class="table-head"><div class="table-title">Transactions</div><button class="tb-btn" onclick="openQuickPurchase()">+ Add</button></div>
          <table><thead><tr><th>Vendor</th><th>Category</th><th>Amount</th><th>Added By</th><th>Date</th></tr></thead><tbody id="projPurchasesTable"></tbody></table>
          <div class="empty-state" id="projPurchasesEmpty" style="display:none;min-height:12em">
            <div class="empty-icon" style="font-size:1.5rem">🧾</div>
            <div class="empty-title" style="font-size:1rem">No transactions yet</div>
            <div class="empty-sub" style="font-size:0.8rem">Add your first transaction to track spend.</div>
          </div>
        </div>
      </div>

      <!-- ALL PURCHASES -->
      <div class="view" id="view-purchases">
        <div class="page-header" style="display:flex;justify-content:space-between;align-items:flex-start">
          <div><div class="page-title">Transactions</div><div class="page-sub">All transactions across every project.</div></div>
          <button class="tb-btn primary" onclick="openAddPurchase()">+ Add Transaction</button>
        </div>
        <div class="table-wrap">
          <table><thead><tr><th>Vendor</th><th>Project</th><th>Category</th><th>Amount</th><th>Added By</th><th>Date</th><th></th></tr></thead><tbody id="allPurchasesTable"></tbody></table>
          <div class="empty-state" id="allPurchasesEmpty" style="display:none;min-height:16em">
            <div class="empty-icon">🧾</div><div class="empty-title">No transactions yet</div>
            <div class="empty-sub">Add transactions from any project to see them here.</div>
          </div>
        </div>
      </div>

      <!-- TEAM -->
      <div class="view" id="view-team">
        <div class="page-header" style="display:flex;justify-content:space-between;align-items:flex-start">
          <div><div class="page-title">Team</div><div class="page-sub" id="teamSub"></div></div>
          <div style="position:relative">
            <button id="teamDotBtn" class="tb-btn" style="font-size:1rem;padding:0.2em 0.55em;letter-spacing:0.05em" onclick="toggleTeamHeaderMenu()">···</button>
            <div id="teamHeaderDropdown" style="display:none;position:absolute;right:0;top:calc(100% + 4px);background:var(--surface);border:1px solid var(--border2);border-radius:0.5em;min-width:200px;z-index:100;box-shadow:0 8px 24px rgba(0,0,0,0.4);overflow:hidden">
              <button onclick="openDefaultPermsModal()" style="display:flex;align-items:center;gap:0.6em;width:100%;text-align:left;padding:0.65em 0.9em;background:none;border:none;cursor:pointer;font-size:0.82rem;color:var(--text);font-family:'DM Sans',sans-serif" onmouseenter="this.style.background='var(--surface2)'" onmouseleave="this.style.background='none'"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" style="flex-shrink:0"><circle cx="7" cy="7" r="2" stroke="currentColor" stroke-width="1.5"/><path d="M7 1v1.5M7 11.5V13M1 7h1.5M11.5 7H13M2.636 2.636l1.06 1.06M10.304 10.304l1.06 1.06M11.364 2.636l-1.06 1.06M3.696 10.304l-1.06 1.06" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg> Default permissions</button>
            </div>
          </div>
        </div>
        <div id="teamCodeBanner" style="margin-bottom:1.5em;display:none">
          <div style="display:flex;align-items:stretch;gap:0.75em">
            <!-- Reset button -->
            <button onclick="regenerateCode()" title="Reset code & link" style="display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0.35em;background:var(--blue);border:1px solid var(--blue);border-radius:0.65em;padding:0.9em 1em;cursor:pointer;color:#fff;flex-shrink:0;min-width:3.5em" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">
              <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M3 9a6 6 0 1 0 1.5-3.9" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M3 4.5V9h4.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
              <span style="font-size:0.62rem;font-weight:600;letter-spacing:0.04em;text-transform:uppercase">Reset</span>
            </button>
            <!-- Team code -->
            <div style="flex:1;background:var(--surface);border:1px solid var(--border);border-radius:0.65em;padding:0.9em 1.1em;min-width:0">
              <div style="font-size:0.62rem;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;color:var(--muted);margin-bottom:0.45em">Team Code</div>
              <div style="display:flex;align-items:center;gap:0.6em">
                <span id="teamCodeText" style="font-size:1.5rem;font-weight:700;letter-spacing:0.2em;font-family:monospace;color:var(--text);flex:1"></span>
                <button id="copyCodeBtn" onclick="copyTeamCode()" style="padding:0.35em 0.8em;background:var(--blue);color:#fff;border:none;border-radius:0.4em;font-size:0.75rem;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;white-space:nowrap">Copy</button>
              </div>
            </div>
            <!-- Invite link -->
            <div style="flex:2;background:var(--surface);border:1px solid var(--border);border-radius:0.65em;padding:0.9em 1.1em;min-width:0">
              <div style="font-size:0.62rem;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;color:var(--muted);margin-bottom:0.45em">Invite Link</div>
              <div style="display:flex;align-items:center;gap:0.6em">
                <input id="teamLinkInput" type="text" readonly onclick="this.select()" style="flex:1;min-width:0;background:var(--surface2);border:1px solid var(--border);border-radius:0.4em;padding:0.38em 0.65em;font-size:0.75rem;color:var(--text2);font-family:monospace;outline:none;cursor:pointer"/>
                <button id="copyLinkBtn" onclick="copyInviteLink()" style="padding:0.35em 0.8em;background:var(--blue);color:#fff;border:none;border-radius:0.4em;font-size:0.75rem;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;white-space:nowrap">Copy</button>
              </div>
            </div>
          </div>
        </div>
        <div class="team-grid" id="teamGrid"></div>
        <div class="empty-state" id="teamEmpty" style="display:none">
          <div class="empty-icon">👷</div><div class="empty-title">No team members yet</div>
          <div class="empty-sub">Share the invite link above with your crew. They'll appear here automatically once they join.</div>
        </div>

        <!-- SUBCONTRACTORS -->
        <div id="subSection" style="margin-top:2.5em">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1em">
            <div>
              <div style="font-size:0.68rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);margin-bottom:0.2em">Subcontractors</div>
              <div id="subSub" style="font-size:0.8rem;color:var(--muted)">External contractors hired per project</div>
            </div>
            <button id="addSubBtn" class="tb-btn primary" style="display:none;font-size:0.8rem" onclick="openAddSubModal()">+ Add Sub</button>
          </div>
          <div class="team-grid" id="subGrid"></div>
          <div id="subEmpty" style="display:none;padding:1.5em;text-align:center;border:1px dashed var(--border);border-radius:0.8em">
            <div style="font-size:1.5rem;margin-bottom:0.5em">🔧</div>
            <div style="font-size:0.88rem;font-weight:600;margin-bottom:0.3em">No subcontractors yet</div>
            <div style="font-size:0.78rem;color:var(--muted)">Add external contractors you hire for specific projects.</div>
          </div>
        </div>
      </div>

      <!-- ALERTS -->
      <div class="view" id="view-alerts">
        <div class="page-header" style="display:flex;justify-content:space-between;align-items:flex-start">
          <div><div class="page-title">Notifications</div><div class="page-sub">Activity and alerts across your company.</div></div>
          <button class="tb-btn" id="markAllReadBtn" onclick="markAllRead()" style="font-size:0.78rem;display:none">Mark all read</button>
        </div>
        <!-- Budget Alerts section -->
        <div id="budgetAlertsWrap" style="margin-bottom:1.25em"></div>
        <!-- Activity notifications -->
        <div id="notifList" style="display:flex;flex-direction:column;gap:0.5em"></div>
        <div class="empty-state" id="alertsEmpty" style="display:none">
          <div class="empty-icon">🔔</div>
          <div class="empty-title">No notifications yet</div>
          <div class="empty-sub">Activity from your team will show up here.</div>
        </div>
      </div>

      <!-- REPORTS -->
      <div class="view" id="view-reports">
        <div class="page-header">
          <div><div class="page-title">Reports</div><div class="page-sub">Shareable project reports for clients.</div></div>
        </div>
        <div style="display:flex;gap:0.4em;margin-bottom:1.25em">
          <button class="report-filter-btn active" data-filter="all" onclick="setReportFilter('all')">All</button>
          <button class="report-filter-btn" data-filter="upcoming" onclick="setReportFilter('upcoming')">Upcoming</button>
          <button class="report-filter-btn" data-filter="in-progress" onclick="setReportFilter('in-progress')">In Progress</button>
          <button class="report-filter-btn" data-filter="completed" onclick="setReportFilter('completed')">Completed</button>
        </div>
        <div class="reports-grid" id="reportsGrid"></div>
        <div class="empty-state" id="reportsEmpty" style="display:none">
          <div class="empty-icon">📊</div>
          <div class="empty-title">No projects found</div>
          <div class="empty-sub">No projects match this filter.</div>
        </div>
      </div>

      <!-- ANALYTICS -->
      <div class="view" id="view-analytics">
        <div class="page-header">
          <div><div class="page-title">Analytics</div><div class="page-sub">Company-wide performance at a glance.</div></div>
        </div>

        <!-- Metric selector cards -->
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.75em;margin-bottom:1.5em" id="analyticsMetricRow">
          <div class="an-metric-card active" data-metric="spending" onclick="selectMetric('spending')">
            <div class="an-metric-label">Spending</div>
            <div class="an-metric-val" id="anv-spending">—</div>
          </div>
          <div class="an-metric-card" data-metric="revenue" onclick="selectMetric('revenue')">
            <div class="an-metric-label">Revenue</div>
            <div class="an-metric-val" id="anv-revenue">—</div>
          </div>
          <div class="an-metric-card" data-metric="profit" onclick="selectMetric('profit')">
            <div class="an-metric-label">Profit</div>
            <div class="an-metric-val" id="anv-profit">—</div>
          </div>
          <div class="an-metric-card" data-metric="transactions" onclick="selectMetric('transactions')">
            <div class="an-metric-label">Transactions</div>
            <div class="an-metric-val" id="anv-transactions">—</div>
          </div>
        </div>

        <!-- Chart area -->
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:0.9em;padding:1.5em 1.5em 1em;margin-bottom:0.75em;position:relative">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.25em;flex-wrap:wrap;gap:0.75em">
            <div>
              <div style="font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--muted);margin-bottom:0.25em" id="an-chart-label">Spending Over Time</div>
              <div style="font-size:1.6rem;font-weight:700;letter-spacing:-0.04em" id="an-chart-total">—</div>
            </div>
            <div style="display:flex;gap:0.4em;flex-wrap:wrap" id="an-granularity-filters"></div>
          </div>
          <div id="an-chart-wrap" style="position:relative;height:180px;width:100%">
            <svg id="an-chart-svg" width="100%" height="180" style="overflow:visible;display:block"></svg>
            <div id="an-tooltip" style="position:absolute;background:var(--surface2);border:1px solid var(--border2);border-radius:0.45em;padding:0.5em 0.75em;font-size:0.75rem;pointer-events:none;display:none;white-space:nowrap;z-index:10">
              <div id="an-tooltip-label" style="color:var(--muted);margin-bottom:0.2em;font-size:0.68rem"></div>
              <div id="an-tooltip-val" style="font-weight:700"></div>
            </div>
          </div>
          <div id="an-no-data" style="display:none;position:absolute;inset:0;align-items:center;justify-content:center;flex-direction:column;gap:0.5em;color:var(--muted);font-size:0.85rem;border-radius:0.9em;background:var(--surface)">
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none"><path d="M4 24l7-9 6 5 8-12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" opacity="0.3"/></svg>
            No data for this period
          </div>
        </div>

        <!-- Period filter pills -->
        <div style="display:flex;gap:0.4em;margin-bottom:1.75em;flex-wrap:wrap" id="an-period-filters"></div>

        <!-- Project comparison table -->
        <div style="font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--muted);margin-bottom:0.75em">Project Breakdown</div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:0.9em;overflow:hidden" id="an-proj-table"></div>

      </div>

    </div>
  </div>



<!-- COMPANY SETTINGS MODAL -->
<!-- COMPANY INFO (read-only, for non-editors) -->
<div class="modal-bg" id="companyInfoModal">
  <div class="modal" style="max-width:360px">
    <div class="modal-head">
      <div class="modal-title">Company Info</div>
      <div style="display:flex;align-items:center;gap:0.5em">
        <button id="ci-edit-btn" onclick="closeModal('companyInfoModal');openModal('companySettingsModal')" title="Edit company info" style="display:none;background:none;border:none;cursor:pointer;color:var(--muted);padding:0.2em;border-radius:0.3em;transition:color 0.12s" onmouseenter="this.style.color='var(--text)'" onmouseleave="this.style.color='var(--muted)'">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M11 2.5a1.5 1.5 0 012.121 2.121l-8.5 8.5L2 13.5l.379-2.621 8.5-8.5z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <button class="modal-close" onclick="closeModal('companyInfoModal')">✕</button>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:1em;margin-bottom:1.4em">
      <div id="ci-logo" style="width:52px;height:52px;border-radius:10px;background:var(--blue);display:grid;place-items:center;font-size:1rem;font-weight:700;color:#fff;flex-shrink:0;overflow:hidden"></div>
      <div>
        <div style="font-size:1.05rem;font-weight:700" id="ci-name">—</div>
        <div style="font-size:0.75rem;color:var(--muted);margin-top:0.2em" id="ci-plan">—</div>
      </div>
    </div>
    <div style="display:grid;gap:0.6em">
      <div style="display:flex;justify-content:space-between;padding:0.6em 0;border-bottom:1px solid var(--border)">
        <span style="font-size:0.8rem;color:var(--muted)">Team size</span>
        <span style="font-size:0.8rem;font-weight:600" id="ci-workers">—</span>
      </div>
      <div style="display:flex;justify-content:space-between;padding:0.6em 0;border-bottom:1px solid var(--border)">
        <span style="font-size:0.8rem;color:var(--muted)">Admin</span>
        <span style="font-size:0.8rem;font-weight:600" id="ci-admin">—</span>
      </div>
      <div style="display:flex;justify-content:space-between;padding:0.6em 0">
        <span style="font-size:0.8rem;color:var(--muted)">Team code</span>
        <span style="font-size:0.8rem;font-weight:600;font-family:monospace" id="ci-code">—</span>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn-save" onclick="closeModal('companyInfoModal')">Close</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="companySettingsModal">
  <div class="modal" style="max-width:440px">
    <div class="modal-head">
      <div class="modal-title">Company Settings</div>
      <button class="modal-close" onclick="closeModal('companySettingsModal')">✕</button>
    </div>

    <!-- Logo upload -->
    <div style="padding:0 1.5em 0">
      <div style="font-size:0.72rem;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:0.75em">Logo</div>
      <div style="display:flex;align-items:center;gap:1em;margin-bottom:1.25em">
        <div id="cs-logo-preview" style="width:56px;height:56px;border-radius:10px;background:var(--blue);display:grid;place-items:center;font-size:1.1rem;font-weight:700;color:#fff;flex-shrink:0;overflow:hidden"></div>
        <div>
          <label style="display:inline-flex;align-items:center;gap:0.4em;background:var(--surface2);border:1px solid var(--border2);border-radius:0.4em;padding:0.4em 0.9em;font-size:0.8rem;font-weight:600;color:var(--text2);cursor:pointer;transition:all 0.12s" onmouseenter="this.style.borderColor='var(--blue-l)';this.style.color='var(--blue-l)'" onmouseleave="this.style.borderColor='var(--border2)';this.style.color='var(--text2)'">
            <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M6 1v7M3 4l3-3 3 3M1 9v1a1 1 0 001 1h8a1 1 0 001-1V9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            Upload Image
            <input type="file" id="cs-logo-file" accept="image/*" style="display:none" onchange="previewLogo(this)"/>
          </label>
          <div style="font-size:0.72rem;color:var(--muted);margin-top:0.35em">PNG, JPG up to 2MB. Square works best.</div>
        </div>
      </div>
    </div>

    <div style="padding:0 1.5em;display:grid;gap:0.85em;margin-bottom:1.25em">
      <div style="font-size:0.72rem;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:-0.1em">Details</div>
      <div class="field" style="margin:0">
        <label>Company name</label>
        <input type="text" id="cs-name" placeholder="Acme Construction"/>
      </div>

      <div class="field" style="margin:0">
        <label>Plan</label>
        <select id="cs-plan">
          <option value="starter">Starter — 1-5 workers ($49/mo)</option>
          <option value="growth">Growth — 6-20 workers ($99/mo)</option>
          <option value="pro">Pro — 21-50 workers ($199/mo)</option>
          <option value="enterprise">Enterprise — 51-100 workers ($399/mo)</option>
        </select>
      </div>
    </div>

    <div class="modal-foot">
      <button class="btn-cancel" onclick="closeModal('companySettingsModal')">Cancel</button>
      <button class="btn-save" onclick="saveCompanySettings()">Save Changes</button>
    </div>
  </div>
</div>

<!-- PERMISSIONS MODAL -->
<div class="modal-bg" id="permsModal">
  <div class="modal" style="max-width:400px">
    <div class="modal-head"><div class="modal-title" id="permsModalTitle">Permissions</div><button class="modal-close" onclick="closeModal('permsModal')">✕</button></div>
    <div id="permsModalMember" style="display:flex;align-items:center;gap:0.9em;padding:0.9em 1em;background:var(--surface2);border-radius:0.6em;margin-bottom:1.2em"></div>
    <div id="permsAdminToggle" style="display:flex;align-items:center;justify-content:space-between;padding:0.75em 0;border-bottom:1px solid var(--border);margin-bottom:0.8em">
      <div>
        <div style="font-size:0.88rem;font-weight:600">Admin</div>
        <div style="font-size:0.72rem;color:var(--muted);margin-top:0.15em">Full access — same as account creator</div>
      </div>
      <label style="position:relative;display:inline-block;width:40px;height:22px;cursor:pointer">
        <input type="checkbox" id="permsAdminCheck" onchange="onPermsAdminToggle()" style="opacity:0;width:0;height:0;position:absolute">
        <span id="permsAdminTrack" style="position:absolute;inset:0;border-radius:999px;background:var(--border2);transition:background 0.2s"></span>
        <span id="permsAdminThumb" style="position:absolute;left:3px;top:3px;width:16px;height:16px;border-radius:50%;background:#fff;transition:transform 0.2s;box-shadow:0 1px 3px rgba(0,0,0,0.4)"></span>
      </label>
    </div>
    <div id="permsChecklist" style="display:flex;flex-direction:column;gap:0.1em;max-height:320px;overflow-y:auto"></div>
    <div class="modal-foot">
      <button class="btn-cancel" onclick="closeModal('permsModal')">Cancel</button>
      <button class="btn-save" onclick="savePermissions()">Save</button>
    </div>
  </div>
</div>

<!-- DEFAULT PERMS MODAL -->
<div class="modal-bg" id="defaultPermsModal">
  <div class="modal" style="max-width:400px">
    <div class="modal-head"><div class="modal-title">Default Worker Permissions</div><button class="modal-close" onclick="closeModal('defaultPermsModal')">✕</button></div>
    <div style="font-size:0.78rem;color:var(--muted);margin-bottom:1em">These permissions apply automatically when a new worker joins via invite link.</div>
    <div id="defaultPermsChecklist" style="display:flex;flex-direction:column;gap:0.1em;max-height:340px;overflow-y:auto"></div>
    <div class="modal-foot">
      <button class="btn-cancel" onclick="closeModal('defaultPermsModal')">Cancel</button>
      <button class="btn-save" onclick="saveDefaultPerms()">Save</button>
    </div>
  </div>
</div>

<!-- CUSTOM CONFIRM MODAL -->
<div class="modal-bg" id="confirmModal">
  <div class="modal" style="max-width:380px">
    <div class="modal-head">
      <div class="modal-title" id="confirmTitle">Are you sure?</div>
      <button class="modal-close" onclick="closeConfirm(false)">✕</button>
    </div>
    <div style="padding:0 1.5em 0.5em">
      <div id="confirmMessage" style="font-size:0.88rem;color:var(--text2);line-height:1.5"></div>
    </div>
    <div class="modal-foot">
      <button class="btn-cancel" onclick="closeConfirm(false)">Cancel</button>
      <button class="btn-save" id="confirmOkBtn" onclick="closeConfirm(true)">Confirm</button>
    </div>
  </div>
</div>

<!-- CUSTOM ALERT MODAL -->
<div class="modal-bg" id="alertModal">
  <div class="modal" style="max-width:360px">
    <div class="modal-head">
      <div class="modal-title" id="alertTitle">Notice</div>
      <button class="modal-close" onclick="closeModal('alertModal')">✕</button>
    </div>
    <div style="padding:0 1.5em 1em">
      <div id="alertMessage" style="font-size:0.88rem;color:var(--text2);line-height:1.5"></div>
    </div>
    <div class="modal-foot">
      <button class="btn-save" onclick="closeModal('alertModal')">OK</button>
    </div>
  </div>
</div>

<!-- REPORT LINK MODAL -->
<div class="modal-bg" id="reportLinkModal">
  <div class="modal" style="max-width:480px">
    <div class="modal-head">
      <div class="modal-title">Share Report</div>
      <button class="modal-close" onclick="closeModal('reportLinkModal')">✕</button>
    </div>
    <div style="padding:1.5em 1.5em">
      <div style="font-size:0.82rem;color:var(--muted);margin-bottom:1em">Share this link with your client. Anyone with the link can view the full report.</div>
      <div style="display:flex;gap:0.5em;margin-bottom:1.25em">
        <input id="reportLinkInput" type="text" readonly style="flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:0.4em;padding:0.5em 0.75em;font-size:0.78rem;color:var(--text);font-family:monospace;outline:none" onclick="this.select()">
        <button id="copyLinkBtn" class="tb-btn primary" onclick="copyReportLink()" style="white-space:nowrap">Copy Link</button>
      </div>
      <a id="reportLinkPreview" href="#" target="_blank" class="tb-btn" style="display:inline-flex;text-decoration:none;font-size:0.82rem">
        <svg width="13" height="13" viewBox="0 0 13 13" fill="none" style="margin-right:0.3em"><path d="M5.5 2H2a1 1 0 00-1 1v8a1 1 0 001 1h8a1 1 0 001-1V8M8 1h4m0 0v4m0-4L5.5 7.5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Open Preview
      </a>
    </div>
  </div>
</div>

<!-- PROFILE MODAL -->
<div class="modal-bg" id="profileModal">
  <div class="modal" style="max-width:460px">
    <div class="modal-head">
      <div class="modal-title">Your Profile</div>
      <button class="modal-close" onclick="closeModal('profileModal')">✕</button>
    </div>
    <div style="padding:0 0.25em 0.5em">
      <!-- Avatar preview -->
      <div style="display:flex;align-items:center;gap:1.25em;margin-bottom:1.5em;padding:1.2em;background:var(--surface2);border-radius:0.65em;border:1px solid var(--border)">
        <div id="profileAvatarPreview" style="width:4em;height:4em;border-radius:50%;display:grid;place-items:center;font-size:1.4rem;font-weight:700;flex-shrink:0;overflow:hidden;transition:all 0.2s"></div>
        <div>
          <div style="font-size:0.85rem;font-weight:600;margin-bottom:0.5em">Avatar</div>
          <div style="display:flex;gap:0.5em;flex-wrap:wrap">
            <button onclick="setAvatarMode('initials')" id="avatarModeInitials" class="tb-btn" style="font-size:0.75rem;padding:0.3em 0.65em">Initials</button>
            <button onclick="setAvatarMode('color')" id="avatarModeColor" class="tb-btn" style="font-size:0.75rem;padding:0.3em 0.65em">Color</button>
            <button onclick="setAvatarMode('image')" id="avatarModeImage" class="tb-btn" style="font-size:0.75rem;padding:0.3em 0.65em">Photo</button>
          </div>
        </div>
      </div>
      <!-- Color picker row (shown in color/initials mode) -->
      <div id="avatarColorRow" style="margin-bottom:1.2em">
        <div style="font-size:0.78rem;font-weight:600;color:var(--text2);margin-bottom:0.5em">Background color</div>
        <div style="display:flex;gap:0.5em;flex-wrap:wrap">
          <div onclick="selectAvatarColor('#1a6de8')" style="width:1.8em;height:1.8em;border-radius:50%;background:#1a6de8;cursor:pointer;border:2px solid transparent;transition:border-color 0.1s" class="avatar-color-swatch"></div>
          <div onclick="selectAvatarColor('#0da068')" style="width:1.8em;height:1.8em;border-radius:50%;background:#0da068;cursor:pointer;border:2px solid transparent;transition:border-color 0.1s" class="avatar-color-swatch"></div>
          <div onclick="selectAvatarColor('#8b5cf6')" style="width:1.8em;height:1.8em;border-radius:50%;background:#8b5cf6;cursor:pointer;border:2px solid transparent;transition:border-color 0.1s" class="avatar-color-swatch"></div>
          <div onclick="selectAvatarColor('#e84040')" style="width:1.8em;height:1.8em;border-radius:50%;background:#e84040;cursor:pointer;border:2px solid transparent;transition:border-color 0.1s" class="avatar-color-swatch"></div>
          <div onclick="selectAvatarColor('#d99520')" style="width:1.8em;height:1.8em;border-radius:50%;background:#d99520;cursor:pointer;border:2px solid transparent;transition:border-color 0.1s" class="avatar-color-swatch"></div>
          <div onclick="selectAvatarColor('#ec4899')" style="width:1.8em;height:1.8em;border-radius:50%;background:#ec4899;cursor:pointer;border:2px solid transparent;transition:border-color 0.1s" class="avatar-color-swatch"></div>
          <div onclick="selectAvatarColor('#06b6d4')" style="width:1.8em;height:1.8em;border-radius:50%;background:#06b6d4;cursor:pointer;border:2px solid transparent;transition:border-color 0.1s" class="avatar-color-swatch"></div>
          <label style="width:1.8em;height:1.8em;border-radius:50%;background:conic-gradient(red,yellow,lime,cyan,blue,magenta,red);cursor:pointer;border:2px solid transparent;display:grid;place-items:center;overflow:hidden;flex-shrink:0" title="Custom color">
            <input type="color" id="avatarCustomColor" style="opacity:0;width:0;height:0;position:absolute" oninput="selectAvatarColor(this.value)">
          </label>
        </div>
      </div>
      <!-- Image upload row (shown in image mode) -->
      <div id="avatarImageRow" style="margin-bottom:1.2em;display:none">
        <div style="font-size:0.78rem;font-weight:600;color:var(--text2);margin-bottom:0.5em">Profile photo</div>
        <label style="display:flex;align-items:center;gap:0.75em;padding:0.75em 1em;border:1px dashed var(--border2);border-radius:0.5em;cursor:pointer;transition:border-color 0.15s" onmouseenter="this.style.borderColor='var(--blue-l)'" onmouseleave="this.style.borderColor='var(--border2)'">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 3v10M3 8h10" stroke="var(--blue-l)" stroke-width="1.6" stroke-linecap="round"/></svg>
          <span style="font-size:0.82rem;color:var(--text2)">Upload photo (JPG, PNG)</span>
          <input type="file" id="avatarImageUpload" accept="image/*" style="display:none" onchange="previewAvatarImage(this)">
        </label>
      </div>
      <!-- Name fields -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.85em;margin-bottom:1em">
        <div class="field" style="margin:0">
          <label>First name</label>
          <input type="text" id="profileFirstName" placeholder="John"/>
        </div>
        <div class="field" style="margin:0">
          <label>Last name</label>
          <input type="text" id="profileLastName" placeholder="Smith"/>
        </div>
      </div>
      <div class="field">
        <label>Email</label>
        <input type="text" id="profileEmail" placeholder="you@company.com" disabled style="opacity:0.5;cursor:not-allowed"/>
        <div style="font-size:0.72rem;color:var(--muted);margin-top:0.3em">Email cannot be changed here</div>
      </div>
      <div class="field">
        <label>Job title</label>
        <input type="text" id="profileJobTitle" placeholder="Site Foreman, Project Manager…"/>
      </div>
      <div class="field">
        <label>Phone</label>
        <input type="tel" id="profilePhone" placeholder="(555) 000-0000"/>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn-cancel" onclick="closeModal('profileModal')">Cancel</button>
      <button class="btn-save" id="profileSaveBtn" onclick="saveProfile()">Save Changes</button>
    </div>
  </div>
</div>

<!-- MEMBER DETAIL MODAL -->
<div class="modal-bg" id="memberDetailModal">
  <div class="modal" style="max-width:420px">
    <div class="modal-head">
      <div class="modal-title">Team Member</div>
      <button class="modal-close" onclick="closeModal('memberDetailModal')">✕</button>
    </div>
    <div style="padding:0 0.25em 0.5em">
      <!-- Header with avatar -->
      <div style="display:flex;align-items:center;gap:1.2em;padding:1.2em;background:var(--surface2);border-radius:0.65em;border:1px solid var(--border);margin-bottom:1.25em">
        <div id="mdAvatar" style="width:3.5em;height:3.5em;border-radius:50%;display:grid;place-items:center;font-size:1.25rem;font-weight:700;flex-shrink:0;overflow:hidden"></div>
        <div>
          <div id="mdName" style="font-size:1rem;font-weight:700;margin-bottom:0.25em"></div>
          <div id="mdRoleTag"></div>
        </div>
      </div>
      <!-- Stats row -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.75em;margin-bottom:1.25em">
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:0.55em;padding:0.85em;text-align:center">
          <div id="mdSpent" style="font-size:1.1rem;font-weight:700"></div>
          <div style="font-size:0.68rem;color:var(--muted);margin-top:0.2em">spent</div>
        </div>
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:0.55em;padding:0.85em;text-align:center">
          <div id="mdPurchases" style="font-size:1.1rem;font-weight:700"></div>
          <div style="font-size:0.68rem;color:var(--muted);margin-top:0.2em">transactions</div>
        </div>
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:0.55em;padding:0.85em;text-align:center">
          <div id="mdProjects" style="font-size:1.1rem;font-weight:700"></div>
          <div style="font-size:0.68rem;color:var(--muted);margin-top:0.2em">projects</div>
        </div>
      </div>
      <!-- Details -->
      <div style="display:flex;flex-direction:column;gap:0.6em">
        <div id="mdEmailRow" style="display:flex;align-items:center;gap:0.75em;padding:0.75em;background:var(--surface2);border-radius:0.5em">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none" style="flex-shrink:0;color:var(--muted)"><rect x="1" y="3" width="12" height="8" rx="1.2" stroke="currentColor" stroke-width="1.3"/><path d="M1 4l6 4 6-4" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/></svg>
          <span id="mdEmail" style="font-size:0.85rem;color:var(--text2)"></span>
        </div>
        <div id="mdJoinedRow" style="display:flex;align-items:center;gap:0.75em;padding:0.75em;background:var(--surface2);border-radius:0.5em">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none" style="flex-shrink:0;color:var(--muted)"><rect x="1" y="2" width="12" height="11" rx="1.2" stroke="currentColor" stroke-width="1.3"/><path d="M1 6h12M4 1v2M10 1v2" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/></svg>
          <span id="mdJoined" style="font-size:0.85rem;color:var(--text2)"></span>
        </div>
      </div>
      <!-- Hourly rate — admin only -->
      <div id="mdRateRow" style="display:none;margin-top:0.75em">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:0.75em;background:var(--surface2);border-radius:0.5em;gap:0.75em">
          <div style="display:flex;align-items:center;gap:0.65em;flex:1">
            <svg width="14" height="14" viewBox="0 0 14 14" fill="none" style="flex-shrink:0;color:var(--muted)"><circle cx="7" cy="7" r="5.5" stroke="currentColor" stroke-width="1.3"/><path d="M7 4v3l2 1.5" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <span style="font-size:0.85rem;color:var(--text2)">Hourly rate</span>
          </div>
          <div style="display:flex;align-items:center;gap:0.4em">
            <span style="font-size:0.85rem;color:var(--muted)">$</span>
            <input type="number" id="mdHourlyRate" min="0" step="0.5" placeholder="0.00"
              style="width:5.5em;background:var(--surface);border:1px solid var(--border2);border-radius:0.4em;padding:0.35em 0.5em;font-size:0.88rem;font-weight:600;color:var(--text);font-family:'DM Sans',sans-serif;outline:none;text-align:right"
              onfocus="this.style.borderColor='var(--blue)'" onblur="this.style.borderColor='var(--border2)'"/>
            <span style="font-size:0.82rem;color:var(--muted)">/hr</span>
            <button onclick="saveHourlyRate()" style="padding:0.35em 0.75em;background:var(--blue);color:#fff;border:none;border-radius:0.4em;font-size:0.78rem;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif">Save</button>
          </div>
        </div>
      </div>
      <!-- Recent transactions -->
      <div id="mdPurchasesList" style="margin-top:1.25em"></div>
    </div>
    <div class="modal-foot" id="mdFooter">
      <button class="btn-cancel" onclick="closeModal('memberDetailModal')">Close</button>
    </div>
  </div>
</div>
</div>

<script>
// ══ DATA ══
const ALL_PERMISSIONS = [
  { id: 'view_all_projects',    label: 'View all projects'       },
  { id: 'view_assigned',        label: 'View assigned projects only' },
  { id: 'add_purchases',        label: 'Add purchases'           },
  { id: 'view_all_purchases',   label: 'View all purchases'      },
  { id: 'view_team',            label: 'View team members'       },
  { id: 'view_budget',          label: 'View budget details'     },
  { id: 'view_reports',         label: 'View reports'            },
  { id: 'edit_company',         label: 'Edit company info'       },
];
const DEFAULT_WORKER_PERMISSIONS = ['view_assigned', 'add_purchases'];

// ══ SUPABASE ══
const SB_URL = 'https://rgexuyvucvcqulnhypkw.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJnZXh1eXZ1Y3ZjcXVsbmh5cGt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NzMxMzcsImV4cCI6MjA4NzU0OTEzN30.j2RTOp9Bfc9s0QV4YFqyz_Y4u8-buqtp2yhccF8D_LE';

function sbHeaders() {
  const session = getSession();
  const headers = { 'apikey': SB_KEY, 'Content-Type': 'application/json' };
  if (session?.access_token) headers['Authorization'] = 'Bearer ' + session.access_token;
  return headers;
}
async function sbGet(table, params, token) {
  const q = params ? '?' + params : '';
  const headers = token
    ? { 'apikey': SB_KEY, 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }
    : sbHeaders();
  const r = await fetch(SB_URL + '/rest/v1/' + table + q, { headers });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}
async function sbPost(table, body) {
  const r = await fetch(SB_URL + '/rest/v1/' + table, {
    method: 'POST', headers: { ...sbHeaders(), 'Prefer': 'return=representation' },
    body: JSON.stringify(body)
  });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}
async function sbPatch(table, params, body) {
  const r = await fetch(SB_URL + '/rest/v1/' + table + '?' + params, {
    method: 'PATCH', headers: { ...sbHeaders(), 'Prefer': 'return=representation' },
    body: JSON.stringify(body)
  });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}
async function sbDelete(table, params) {
  const r = await fetch(SB_URL + '/rest/v1/' + table + '?' + params, {
    method: 'DELETE', headers: sbHeaders()
  });
  if (!r.ok) throw new Error(await r.text());
}

// ══ AUTH SESSION ══
function getSession() {
  try { return JSON.parse(localStorage.getItem('forge_session')||'null'); } catch(e) { return null; }
}
function setSession(s) {
  if (s) localStorage.setItem('forge_session', JSON.stringify(s));
  else localStorage.removeItem('forge_session');
}

// Refresh the access token using the refresh_token if the current one is expired or close to expiring
async function refreshSessionIfNeeded() {
  let session = getSession();
  if (!session?.access_token) return null;

  // Normalize: compute expires_at from expires_in if missing
  if (!session.expires_at && session.expires_in) {
    session.expires_at = Math.floor(Date.now() / 1000) + session.expires_in;
    setSession(session);
  }

  const expiresAt = session.expires_at ? session.expires_at * 1000 : null;
  // Only refresh if we know it's expiring soon (within 2 min) — if no expires_at, assume valid
  const needsRefresh = expiresAt && (expiresAt - Date.now()) < 120000;
  if (!needsRefresh) return session;
  if (!session.refresh_token) return session;

  try {
    const res = await fetch(SB_URL + '/auth/v1/token?grant_type=refresh_token', {
      method: 'POST',
      headers: { 'apikey': SB_KEY, 'Content-Type': 'application/json' },
      body: JSON.stringify({ refresh_token: session.refresh_token })
    });
    if (!res.ok) {
      // Refresh failed — if token is truly expired, clear. Otherwise keep trying with current token.
      if (expiresAt && expiresAt < Date.now()) {
        setSession(null);
        localStorage.removeItem('forge_company_id');
        return null;
      }
      return session; // not expired yet, use what we have
    }
    const fresh = await res.json();
    if (fresh.access_token) {
      if (!fresh.expires_at && fresh.expires_in) {
        fresh.expires_at = Math.floor(Date.now() / 1000) + fresh.expires_in;
      }
      setSession(fresh);
      return fresh;
    }
    return session;
  } catch(e) {
    return session; // network error — use existing token
  }
}

function genCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let c = '';
  for (let i=0;i<6;i++) c += chars[Math.floor(Math.random()*chars.length)];
  return c;
}

// ══ IN-MEMORY DB (populated from Supabase) ══
let DB = { companyName:'',plan:'',teamCode:'',role:'worker',projects:[],purchases:[],team:[],subs:[] };
let COMPANY_ID = null;

// ── Save wrappers ──
// These keep the in-memory DB in sync and persist to Supabase
async function save(d) {
  // Legacy: just a no-op here since each action calls its own Supabase function
  // localStorage kept as fallback cache
  try { localStorage.setItem('forge_cache', JSON.stringify(d)); } catch(e) {}
}

async function sbSaveProject(proj, localIdx) {
  if (!COMPANY_ID) return;
  // Store categories as [{name, pct}] so budget allocations persist
  const categoriesPayload = (proj.categories || []).map(name => ({
    name,
    pct: (proj.catBudgets && proj.catBudgets[name]) ? proj.catBudgets[name] : null
  }));
  const payload = {
    company_id: COMPANY_ID,
    name: proj.name,
    client: proj.client || null,
    location: proj.location || null,
    budget: proj.budget || 0,
    start_date: proj.startDate || null,
    end_date: proj.endDate || null,
    color: proj.color || '#3b82f6',
    categories: categoriesPayload,
    sort_order: localIdx,
    assigned_workers: proj.assignedWorkers || [],
    labor_enabled: proj.laborEnabled !== false,
    labor_workers: proj.laborWorkers || {}
  };
  if (proj._id) {
    await sbPatch('projects', 'id=eq.' + proj._id, payload);
  } else {
    const rows = await sbPost('projects', payload);
    if (rows[0]) DB.projects[localIdx]._id = rows[0].id;
  }
}

async function sbSavePurchase(pu, localIdx) {
  if (!COMPANY_ID) return;
  const proj = DB.projects[pu.projectIdx];
  if (!proj?._id) return;
  const payload = {
    company_id: COMPANY_ID,
    project_id: proj._id,
    vendor: pu.vendor,
    amount: pu.amount,
    type: pu.type || 'expense',
    category: pu.category || null,
    date: pu.date || null,
    notes: pu.notes || null,
    worker: pu.worker || null,
    ts: pu.ts || Date.now()
  };
  if (pu._id) {
    await sbPatch('purchases', 'id=eq.' + pu._id, payload);
  } else {
    const rows = await sbPost('purchases', payload);
    if (rows[0]) DB.purchases[localIdx]._id = rows[0].id;
  }
}

async function sbSaveTeamMember(m, localIdx) {
  if (!COMPANY_ID) return;
  const payload = {
    company_id: COMPANY_ID,
    first_name: m.firstName,
    last_name: m.lastName,
    email: m.email || null,
    role: m.role || 'Worker'
  };
  if (m._id) {
    await sbPatch('team_members', 'id=eq.' + m._id, payload);
  } else {
    const rows = await sbPost('team_members', payload);
    if (rows[0]) DB.team[localIdx]._id = rows[0].id;
  }
}

async function sbDeleteProject(proj) {
  if (!proj._id) return;
  await sbDelete('projects', 'id=eq.' + proj._id);
}
async function sbDeletePurchase(pu) {
  if (!pu._id) return;
  await sbDelete('purchases', 'id=eq.' + pu._id);
}
async function sbDeleteTeamMember(m) {
  if (!m._id) return;
  await sbDelete('team_members', 'id=eq.' + m._id);
}
async function sbSaveCompany() {
  if (!COMPANY_ID) return;
  await sbPatch('companies', 'id=eq.' + COMPANY_ID, {
    name: DB.companyName,
    team_code: DB.teamCode,
    plan: DB.plan
  });
}

// ── Load all data from Supabase ──
async function loadFromSupabase() {
  let session = await refreshSessionIfNeeded();
  if (!session?.access_token) { setSession(null); localStorage.removeItem('forge_company_id'); window.location.replace('auth.html'); return false; }

  try {
    const uid  = session.user?.id || getSession()?.user?.id;
    const meta = session.user?.user_metadata || getSession()?.user?.user_metadata || {};

    // ── Find company ──
    // Admin: owns the company
    // Worker: company_id stored in their auth metadata at join time
    let co       = null;
    let isWorker = false;

    // Check localStorage first — set at account creation or worker join
    const cachedCompanyId = localStorage.getItem('forge_company_id');

    const adminCompanies = await sbGet('companies', 'owner_id=eq.' + uid + '&select=*&limit=1');
    if (adminCompanies.length) {
      co = adminCompanies[0];
      localStorage.setItem('forge_company_id', co.id);
    } else {
      // Worker — find company via team_members row (most reliable)
      const myMemberships = await sbGet('team_members', 'user_id=eq.' + uid + '&select=company_id&limit=1').catch(() => []);
      const workerCompanyId = myMemberships[0]?.company_id || cachedCompanyId;
      if (workerCompanyId) {
        const workerCompanies = await sbGet('companies', 'id=eq.' + workerCompanyId + '&select=*&limit=1').catch(() => []);
        if (workerCompanies.length) {
          co = workerCompanies[0];
          isWorker = true;
          localStorage.setItem('forge_company_id', co.id);
        }
      }
    }

    // No company found — sign out cleanly, don't loop
    if (!co) {
      setSession(null);
      localStorage.removeItem('forge_company_id');
      window.location.replace('auth.html');
      return false;
    }

    COMPANY_ID = co.id;

    // ── Load all data in parallel (fail gracefully so one bad query can't loop) ──
    const [projects, purchases, subs, notifications, team] = await Promise.all([
      sbGet('projects',     'company_id=eq.' + COMPANY_ID + '&order=sort_order.asc').catch(() => []),
      sbGet('purchases',    'company_id=eq.' + COMPANY_ID + '&order=ts.desc').catch(() => []),
      sbGet('subs',         'company_id=eq.' + COMPANY_ID + '&order=name.asc').catch(() => []),
      sbGet('notifications', 'company_id=eq.' + COMPANY_ID + '&order=created_at.desc&limit=100').catch(() => []),
      sbGet('team_members', 'company_id=eq.' + COMPANY_ID).catch(() => [])
    ]);

    DB = {
      companyName: co.name,
      plan:        co.plan,
      teamCode:    co.team_code,
      trialEnd:    co.trial_end,
      workerCount: co.worker_count || 0,
      logoUrl:     co.logo_url || null,
      firstName:   meta.first_name || '',
      jobTitle:    meta.job_title    || '',
      phone:       meta.phone        || '',
      avatarColor: meta.avatar_color  || '#1a6de8',
      avatarImage: meta.avatar_image  || null,
      lastName:    meta.last_name  || '',
      role:        isWorker ? 'worker' : 'admin',
      // For workers: load the actual admin's name from their team_members row (owner has owner_id on company)
      // We find the admin by looking for the team_members row where user_id = co.owner_id

      projects: projects.map(p => ({
        _id: p.id, name: p.name, client: p.client,
        location: p.location, budget: p.budget,
        startDate: p.start_date, endDate: p.end_date || null, color: p.color,
        assignedWorkers: p.assigned_workers || [],
        laborEnabled: p.labor_enabled !== false,
        laborWorkers: p.labor_workers || {},
        // categories stored as [{name, pct}] — rebuild flat arrays for app use
        categories: (p.categories || []).map(c => typeof c === 'object' ? c.name : c),
        catBudgets: Object.fromEntries(
          (p.categories || [])
            .filter(c => typeof c === 'object' && c.pct)
            .map(c => [c.name, c.pct])
        )
      })),
      purchases: purchases.map(pu => {
        const projectIdx = projects.findIndex(p => p.id === pu.project_id);
        return {
          _id: pu.id, vendor: pu.vendor, amount: Math.abs(pu.amount), type: pu.type || 'expense',
          category: pu.category, date: pu.date, notes: pu.notes,
          worker: pu.worker, ts: pu.ts, _laborAuto: pu.labor_auto || false, projectIdx
        };
      }).filter(pu => pu.projectIdx >= 0),
      team: team.map(m => ({
        _id: m.id, firstName: m.first_name, lastName: m.last_name,
        email: m.email, role: m.role, user_id: m.user_id || null,
        hourlyRate: m.hourly_rate || 0
      })),
      subs: (subs || []).map(s => ({
        _id: s.id, name: s.name, trade: s.trade || '',
        projects: s.projects || []
      })),
      notifications: (notifications || []).map(n => ({
        _id: n.id, type: n.type, title: n.title, body: n.body,
        read: n.read || false, createdAt: n.created_at,
        projectIdx: n.project_idx !== null && n.project_idx !== undefined
          ? projects.findIndex(p => p.id === n.project_id) : undefined,
        actorName: n.actor_name || '',
      }))
    };

    // Detect new members joining via invite (compare to last known count)
    const prevCount = parseInt(localStorage.getItem('forge_team_count')||'0');
    const currCount = DB.team.length;
    if (prevCount > 0 && currCount > prevCount) {
      // Find new members (ones not in notifications already)
      const existingNames = new Set((DB.notifications||[]).filter(n=>n.type==='member_join').map(n=>n.title.split(' joined')[0]));
      const newest = DB.team.slice(-( currCount - prevCount));
      newest.forEach(m => {
        const name = (m.firstName+' '+m.lastName).trim();
        if (!existingNames.has(name)) {
          pushNotif('member_join', name+' joined your team', (m.email||'New worker')+' joined via invite link.', {});
        }
      });
    }
    localStorage.setItem('forge_team_count', currCount);
    return true;

  } catch(err) {
    console.error('loadFromSupabase error:', err);
    // Always clear session on error — if Supabase rejected us, the token is bad.
    // This prevents the auth.html <-> dashboard.html redirect loop.
    setSession(null);
    localStorage.removeItem('forge_company_id');
    return false;
  }
}

let activeView    = 'dashboard';
let activeProject = null;
let newProjColor  = '#3b82f6';

const AVATAR_COLORS = ['#3b82f6','#0da068','#d99520','#8b5cf6','#ec4899','#e84040','#06b6d4'];

function fmt(n) { return Number(n||0).toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0}); }
function fmtDate(d) { if (!d) return '—'; const dt = new Date(d+'T12:00:00'); return dt.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}); }


function fmtShort(n) {
  n = Number(n||0);
  if (n >= 1000000) return '$'+(n/1000000).toFixed(n%1000000===0?0:1)+'M';
  if (n >= 1000) return '$'+(n/1000).toFixed(n%1000===0?0:1)+'K';
  return '$'+n.toFixed(0);
}

function renderBar(pct, color, height) {
  const h = height || 8;
  const r = h <= 5 ? 3 : 4;
  const over = pct > 100;
  const overPct = over ? Math.min(pct - 100, 100) : 0;
  return '<div style="position:relative;height:'+h+'px;border-radius:'+r+'px;background:'+(over?'rgba(90,10,10,0.65)':'var(--surface3)')+'">'+
    '<div style="position:absolute;top:0;left:0;height:100%;width:'+Math.min(pct,100)+'%;border-radius:'+r+'px;background:'+color+';box-shadow:2px 0 8px rgba(0,0,0,0.5)"></div>'+
    (over ? '<div style="position:absolute;top:0;left:0;height:100%;width:'+overPct+'%;border-radius:'+r+'px;background:rgba(140,15,15,1);box-shadow:2px 0 8px rgba(0,0,0,0.6)"></div>' : '')+
  '</div>';
}

function timeAgo(ts) {
  const s = Math.floor((Date.now()-ts)/1000);
  if (s < 60) return 'just now';
  if (s < 3600) return Math.floor(s/60)+'m ago';
  if (s < 86400) return Math.floor(s/3600)+'h ago';
  return Math.floor(s/86400)+'d ago';
}

// ══ LABOR ESTIMATE ══
function calcLaborEstimate(projIdx) {
  const proj = DB.projects[projIdx];
  if (!proj || !proj.laborEnabled) return 0;
  const workers = proj.laborWorkers || {};
  const start = proj.startDate, end = proj.endDate;
  const weeks = (start && end) ? Math.max(0, (new Date(end) - new Date(start)) / (7*24*3600*1000)) : 0;
  return DB.team.reduce((sum, m) => {
    const uid  = m.user_id || m._id;
    const hrs  = workers[uid] || 0;
    const rate = m.hourlyRate || 0;
    return sum + hrs * rate * weeks;
  }, 0);
}
function calcLaborWeekly(projIdx) {
  const proj = DB.projects[projIdx];
  if (!proj || !proj.laborEnabled) return 0;
  const workers = proj.laborWorkers || {};
  return DB.team.reduce((sum, m) => {
    const uid  = m.user_id || m._id;
    const hrs  = workers[uid] || 0;
    const rate = m.hourlyRate || 0;
    return sum + hrs * rate;
  }, 0);
}

// ══ LABOR EDIT (in project detail) ══
function renderLaborEditRows(projIdx) {
  const proj = DB.projects[projIdx];
  if (!proj) return '';
  const workers = proj.laborWorkers || {};
  const assigned = proj.assignedWorkers || [];
  const members = DB.team.filter(m => {
    const uid = m.user_id || m._id;
    return assigned.length === 0 || assigned.includes(uid);
  });
  if (!members.length) return '<div style="font-size:0.78rem;color:var(--muted)">No workers assigned to this project.</div>';
  const start = proj.startDate, end = proj.endDate;
  const weeks = (start && end) ? Math.max(0,(new Date(end)-new Date(start))/(7*24*3600*1000)) : 0;
  const weeklyTotal = calcLaborWeekly(projIdx);
  const totalEst    = calcLaborEstimate(projIdx);
  const isAdmin = DB.role === 'admin';
  return members.map(m => {
    const uid  = m.user_id || m._id;
    const name = (m.firstName+' '+m.lastName).trim();
    const rate = m.hourlyRate || 0;
    const hrs  = workers[uid] || '';
    const cost = (parseFloat(hrs)||0) * rate * weeks;
    return '<div style="display:flex;align-items:center;gap:0.6em;padding:0.28em 0;font-size:0.82rem">' +
      '<span style="flex:1;font-weight:500">' + name + '</span>' +
      '<span style="color:var(--muted);font-size:0.72rem">$'+rate+'/hr</span>' +
      (isAdmin
        ? '<input type="number" min="0" step="0.5" value="'+hrs+'" placeholder="hrs/wk" ' +
          'style="width:5em;background:var(--surface);border:1px solid var(--border2);border-radius:0.35em;padding:0.28em 0.45em;font-size:0.78rem;color:var(--text);font-family:DM Sans,sans-serif;outline:none;text-align:center" ' +
          'oninput="saveLaborHours('+projIdx+',\''+uid+'\',this.value)" onfocus="this.style.borderColor=\'var(--blue)\'" onblur="this.style.borderColor=\'var(--border2)\'"/>'
        : '<span style="font-size:0.78rem;color:var(--text2)">'+(hrs||'—')+' hrs/wk</span>') +
      (cost > 0 ? '<span style="font-size:0.72rem;color:var(--blue-l);font-weight:600;min-width:3.5em;text-align:right">$'+fmt(cost)+'</span>' : '<span style="min-width:3.5em"></span>') +
    '</div>';
  }).join('') +
  (weeklyTotal > 0 || totalEst > 0 ?
    '<div style="border-top:1px solid rgba(26,109,232,0.15);margin-top:0.4em;padding-top:0.4em;display:flex;justify-content:space-between;font-size:0.75rem;font-weight:600;color:var(--blue-l)">' +
    '<span>'+(weeklyTotal>0?'$'+fmt(weeklyTotal)+'/wk':'')+'</span>' +
    '<span>'+(totalEst>0?'$'+fmt(totalEst)+' total est.':((!start||!end)?'Set project dates to see total':''))+'</span>' +
    '</div>' : '');
}

function openLaborModal(projIdx) {
  const proj = DB.projects[projIdx];
  if (!proj) return;
  const body = document.getElementById('labor-modal-body');
  const start = proj.startDate, end = proj.endDate;
  const weeks = (start && end) ? Math.max(0,(new Date(end)-new Date(start))/(7*24*3600*1000)).toFixed(1) : null;
  const laborPct = proj.catBudgets?.['Labor Estimate'] || '';
  body.innerHTML =
    '<div style="padding:0 1.5em">' +
    '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1em">' +
      '<div style="font-size:0.82rem;color:var(--text2)">Labor estimate for <strong>'+proj.name+'</strong>'+(weeks?' · '+weeks+' weeks':'')+' · $'+fmt(calcLaborEstimate(projIdx))+' total</div>' +
      '<label style="display:flex;align-items:center;gap:0.5em;font-size:0.82rem;cursor:pointer">' +
        '<span style="color:var(--muted)">Enabled</span>' +
        '<input type="checkbox" id="lm-enabled" '+(proj.laborEnabled!==false?'checked':'')+' style="width:1em;height:1em;accent-color:var(--blue)"/>' +
      '</label>' +
    '</div>' +
    '<div style="margin-bottom:1em">' +
      '<label style="font-size:0.78rem;font-weight:600;color:var(--text2);display:block;margin-bottom:0.35em">Budget allocation (%)</label>' +
      '<input type="number" id="lm-pct" min="1" max="100" placeholder="e.g. 30" value="'+laborPct+'" style="width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:0.45em;padding:0.6em 0.8em;font-size:0.9rem;color:var(--text);font-family:DM Sans,sans-serif;outline:none" onfocus="this.style.borderColor=\'var(--blue)\'" onblur="this.style.borderColor=\'var(--border2)\'"/>' +
      '<div style="font-size:0.72rem;color:var(--muted);margin-top:0.3em">Optional — portion of total budget allocated to labor.</div>' +
    '</div>' +
    '<div><label style="font-size:0.78rem;font-weight:600;color:var(--text2);display:block;margin-bottom:0.5em">Hours per week per worker</label>' +
    renderLaborEditRows(projIdx) +
    '</div></div>';
  openModal('laborModal');
  // store projIdx on modal
  document.getElementById('laborModal')._projIdx = projIdx;
}

function saveLaborModal() {
  const modal  = document.getElementById('laborModal');
  const projIdx = modal._projIdx;
  const proj   = DB.projects[projIdx];
  if (!proj) return;
  proj.laborEnabled = document.getElementById('lm-enabled').checked;
  const pctVal = parseInt(document.getElementById('lm-pct').value);
  if (!proj.catBudgets) proj.catBudgets = {};
  if (pctVal >= 1 && pctVal <= 100) proj.catBudgets['Labor Estimate'] = pctVal;
  else delete proj.catBudgets['Labor Estimate'];
  closeModal('laborModal');
  sbSaveProject(proj, projIdx).catch(console.error);
  if (proj.laborEnabled) upsertLaborTransaction(projIdx);
  renderProjectDetail(projIdx);
  pushNotif('labor_saved', 'Labor estimate updated on '+proj.name, 'Budget allocation and hours updated.', {projectIdx:projIdx});
}

function toggleLaborEditPanel(projIdx) {
  const panel = document.getElementById('labor-edit-panel-'+projIdx);
  if (!panel) return;
  panel.style.display = panel.style.display === 'none' ? '' : 'none';
}

async function saveLaborHours(projIdx, uid, val) {
  const proj = DB.projects[projIdx];
  if (!proj) return;
  if (!proj.laborWorkers) proj.laborWorkers = {};
  proj.laborWorkers[uid] = parseFloat(val) || 0;
  // Re-render labor panel inline without full re-render
  const panel = document.getElementById('labor-edit-panel-'+projIdx);
  if (panel) panel.innerHTML = renderLaborEditRows(projIdx);
  // Debounce save + auto-transaction
  clearTimeout(saveLaborHours._t);
  saveLaborHours._t = setTimeout(() => {
    sbSaveProject(proj, projIdx).catch(console.error);
    upsertLaborTransaction(projIdx);
  }, 800);
}

async function upsertLaborTransaction(projIdx) {
  const proj  = DB.projects[projIdx];
  if (!proj || !proj.laborEnabled) return;
  const total = calcLaborEstimate(projIdx);
  if (total <= 0) return;

  const me      = DB.team.find(m => m.user_id === getSession()?.user?.id);
  const addedBy = me ? (me.firstName+' '+me.lastName).trim() : 'Admin';
  const tx = {
    vendor:     'Labor Estimate',
    amount:     total,
    type:       'expense',
    category:   'Labor Estimate',
    date:       new Date().toISOString().slice(0,10),
    notes:      'Auto generated by Forge.inc',
    worker:     addedBy,
    projectIdx: projIdx,
    _laborAuto: true,
    ts:         Date.now(),
  };

  // Delete any existing labor-auto transactions for this project from DB + Supabase
  const oldOnes = DB.purchases.filter(p => p.projectIdx === projIdx && p._laborAuto);
  for (const old of oldOnes) {
    if (old._id) {
      await fetch(SB_URL+'/rest/v1/purchases?id=eq.'+old._id, {
        method: 'DELETE',
        headers: { apikey: SB_KEY, Authorization: 'Bearer '+getSession()?.access_token, 'Content-Type': 'application/json' }
      }).catch(console.error);
    }
  }
  DB.purchases = DB.purchases.filter(p => !(p.projectIdx === projIdx && p._laborAuto));

  // Insert fresh
  DB.purchases.push(tx);
  const localIdx = DB.purchases.length - 1;
  const proj_ = DB.projects[projIdx]; // re-ref in case async
  await sbSavePurchase(tx, localIdx).catch(console.error);
  renderProjectDetail(projIdx);
}

// ══ BURN RATE ══
function calcBurnRate(projectIdx) {
  const p   = DB.projects[projectIdx];
  const pus = DB.purchases.filter(x => x.projectIdx === projectIdx);
  if (!pus.length || !p.startDate) return null;
  const start  = new Date(p.startDate+'T00:00:00').getTime();
  const now    = Date.now();
  const daysSinceStart = Math.max(1, (now - start) / 86400000);
  const spent  = spentFromPurchases(pus);
  const dailyBurn = spent / daysSinceStart;
  const remaining = p.budget - spent;
  if (dailyBurn <= 0) return null;
  const daysLeft = Math.round(remaining / dailyBurn);
  return { dailyBurn, daysLeft, spent };
}

// ══ ALERTS ENGINE ══
function computeAlerts() {
  const alerts = [];
  DB.projects.forEach((p, idx) => {
    const pus   = DB.purchases.filter(x => x.projectIdx === idx);
    const spent = spentFromPurchases(pus);
    const pct   = p.budget > 0 ? spent / p.budget : 0;

    if (pct >= 1) {
      alerts.push({ severity:'critical', title:p.name+' is over budget', desc:'Spent $'+fmt(spent)+' of $'+fmt(p.budget)+' budget — $'+fmt(spent-p.budget)+' over.', projectIdx:idx });
    } else if (pct >= 0.9) {
      alerts.push({ severity:'high', title:p.name+' is at '+Math.round(pct*100)+'% of budget', desc:'Only $'+fmt(p.budget-spent)+' remaining. Review spending before adding more transactions.', projectIdx:idx });
    } else if (pct >= 0.75) {
      alerts.push({ severity:'medium', title:p.name+' is at '+Math.round(pct*100)+'% of budget', desc:'$'+fmt(p.budget-spent)+' remaining across all categories.', projectIdx:idx });
    }

    (p.categories||[]).forEach(cat => {
      const catSpent = spentFromPurchases(pus.filter(x => x.category === cat));
      const share = p.budget > 0 ? catSpent / p.budget : 0;
      if (share >= 0.4 && catSpent > 1000) {
        alerts.push({ severity:'medium', title:'High '+cat+' spending on '+p.name, desc:'$'+fmt(catSpent)+' spent on '+cat+' — '+Math.round(share*100)+'% of total project budget.', projectIdx:idx });
      }
    });

    pus.forEach(pu => {
      const threshold = Math.max(5000, p.budget * 0.1);
      if (pu.amount >= threshold) {
        alerts.push({ severity:'low', title:'Large purchase on '+p.name, desc:'$'+fmt(pu.amount)+' at '+pu.vendor+(pu.worker?' by '+pu.worker:'')+' — '+Math.round(pu.amount/p.budget*100)+'% of project budget.', projectIdx:idx });
      }
    });

    const burn = calcBurnRate(idx);
    if (burn && burn.daysLeft < 7 && pct < 1 && pct > 0.5) {
      alerts.push({ severity:'high', title:p.name+' may run out of budget in '+burn.daysLeft+' days', desc:'At $'+fmt(Math.round(burn.dailyBurn))+'/day burn rate with $'+fmt(p.budget - burn.spent)+' remaining.', projectIdx:idx });
    }
  });
  return alerts.slice(0, 20);
}

// ══ INIT ══
async function init() {
  // Show loading state
  document.body.style.opacity = '0';
  const ok = await loadFromSupabase();
  if (!ok) { setSession(null); localStorage.removeItem('forge_company_id'); window.location.replace('auth.html'); return; }
  document.body.style.transition = 'opacity 0.3s ease';
  document.body.style.opacity = '1';
  const initials = ((DB.firstName||'?')[0]+(DB.lastName||'?')[0]).toUpperCase();
  const avatarEl = document.getElementById('userAvatar');
  // Load saved avatar preferences from user metadata
  const meta = getSession()?.user?.user_metadata || {};
  DB.avatarColor = meta.avatar_color || '#1a6de8';
  DB.avatarImage = meta.avatar_image || null;
  DB.jobTitle    = meta.job_title    || '';
  DB.phone       = meta.phone        || '';
  if (DB.avatarImage) {
    avatarEl.innerHTML = `<img src="${DB.avatarImage}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
    avatarEl.style.background = 'none';
  } else {
    avatarEl.textContent = initials;
    avatarEl.style.background = DB.avatarColor || '#1a6de8';
  }
  document.getElementById('userName').textContent       = (DB.firstName||'' +' '+ DB.lastName||'').trim() || DB.companyName || 'Admin';
  document.getElementById('userRole').textContent       = DB.role ? DB.role.charAt(0).toUpperCase()+DB.role.slice(1) : 'Admin';
  document.getElementById('sidebarCompany').textContent = DB.companyName || '—';
  updateCompanyLogo();
  document.getElementById('sidebarPlan').textContent    = (DB.plan||'starter').charAt(0).toUpperCase()+(DB.plan||'starter').slice(1)+' Plan · '+(DB.workerCount||0)+' workers';
  if (DB.trialEnd) {
    const days = Math.max(0, Math.ceil((DB.trialEnd-Date.now())/86400000));
    if (days <= 14) {
      document.getElementById('trialBanner').style.display = 'flex';
      document.getElementById('trialDays').textContent = days+' day'+(days===1?'':'s');
    }
  }
  renderAll();
  // Restore last view
  const savedView    = localStorage.getItem('forge_view');
  const savedProject = localStorage.getItem('forge_project');
  if (savedView === 'project' && savedProject !== null) {
    const idx = parseInt(savedProject);
    if (DB.projects[idx]) openProject(idx);
    else showView('dashboard');
  } else if (savedView && savedView !== 'dashboard') {
    showView(savedView);
  }
}

// ══ RENDER ALL ══
function renderAll() {
  renderSidebar(); renderDashboard(); renderAllPurchases(); renderTeam(); renderAlerts(); renderReports(); updateAlertsBadge();
  if (activeView === 'analytics') renderAnalytics();
}

// ══ SIDEBAR ══
function renderSidebar() {
  const el = document.getElementById('sidebarProjects');
  if (!DB.projects.length) { el.innerHTML = '<div style="font-size:0.75rem;color:var(--muted);padding:0.3em 0.6em">No projects yet</div><button class="btn-new-proj" style="width:100%;margin:0.4em 0 0.2em" onclick="openModal(\'newProjModal\')"><svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M6 1v10M1 6h10" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg> New Project</button>'; return; }
  el.innerHTML = visibleProjects().map(i => {
    const p = DB.projects[i];
    const spent = spentFromPurchases(DB.purchases.filter(x=>x.projectIdx===i));
    const pct   = p.budget>0 ? Math.min(100,Math.round(spent/p.budget*100)) : 0;
    const col   = pct>90?'var(--red)':pct>70?'var(--orange)':'var(--green)';
    return '<div class="proj-item '+(activeProject===i?'active':'')+'" onclick="openProject('+i+')"><div class="proj-dot" style="background:'+p.color+'"></div><div class="proj-name">'+p.name+'</div><span style="font-size:0.65rem;font-weight:700;color:'+col+';margin-left:auto;flex-shrink:0">'+pct+'%</span></div>';
  }).join('');
  el.innerHTML += '<button class="btn-new-proj" style="width:100%;margin:0.4em 0 0.2em" onclick="openModal(\'newProjModal\')"><svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M6 1v10M1 6h10" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg> New Project</button>';
}

// ══ VIEWS ══
function showView(name) {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('view-'+name).classList.add('active');
  const nav = document.getElementById('nav-'+name);
  if (nav) nav.classList.add('active');
  activeView = name; activeProject = null;
  localStorage.setItem('forge_view', name);
  localStorage.removeItem('forge_project');
  renderSidebar(); updateTopbar();
  if (name === 'analytics') renderAnalytics();
}

function openProject(idx) {
  activeProject = idx; activeView = 'project';
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('view-project').classList.add('active');
  localStorage.setItem('forge_view', 'project');
  localStorage.setItem('forge_project', idx);
  renderProjectDetail(idx); renderSidebar(); updateTopbar();
}

function updateTopbar() {
  const crumb   = document.getElementById('topbarCrumb');
  const actions = document.getElementById('topbarActions');
  const views = {
    dashboard: ['Dashboard', ''],
    purchases: ['Purchases', ''],
    team:      ['Team',      ''],
    alerts:    ['Alerts',    ''],
    reports:   ['Reports',   ''],
    analytics: ['Analytics', ''],
  };
  if (activeView === 'project' && activeProject !== null) {
    const p = DB.projects[activeProject];
    crumb.innerHTML   = 'Projects › <span>'+p.name+'</span>';
    actions.innerHTML = '';
    return;
  }
  const v = views[activeView] || ['—', ''];
  crumb.innerHTML   = '<span>'+v[0]+'</span>';
  actions.innerHTML = v[1];
}

// ══ DASHBOARD ══
function renderDashboard() {
  const totalBudget = DB.projects.reduce((s,p)=>s+(p.budget||0),0);
  const totalSpent  = spentFromPurchases(DB.purchases);
  const remaining   = totalBudget - totalSpent;
  const pct         = totalBudget>0 ? Math.round(totalSpent/totalBudget*100) : 0;
  const atRisk      = DB.projects.filter((p,i) => { const sp=spentFromPurchases(DB.purchases.filter(x=>x.projectIdx===i)); return p.budget>0 && sp/p.budget>=0.7; }).length;

  const statColor = pct>90?'s-red':pct>70?'s-orange':'s-green';
  const totalRevenue = incomeFromPurchases(DB.purchases);
  const totalProfit  = totalRevenue - totalSpent;
  const profitColor  = totalProfit >= 0 ? 's-green' : 's-red';
  const profitValColor = totalProfit >= 0 ? 'c-green' : 'c-red';
  document.getElementById('dashStats').innerHTML =
    '<div class="stat-card '+(profitColor)+'"><div class="stat-lbl">Total Profit</div><div class="stat-val '+profitValColor+'">'+(totalProfit<0?'-':'')+'$'+fmt(Math.abs(totalProfit))+'</div><div class="stat-note">Revenue minus expenses</div></div>'+
    '<div class="stat-card s-blue"><div class="stat-lbl">Total Revenue</div><div class="stat-val c-blue">$'+fmt(totalRevenue)+'</div><div class="stat-note">Income logged</div></div>'+
    '<div class="stat-card '+(remaining<0?'s-red':'s-green')+'"><div class="stat-lbl">Budget Remaining</div><div class="stat-val '+(remaining<0?'c-red':'c-green')+'">'+(remaining<0?'-':'')+'$'+fmt(Math.abs(remaining))+(remaining<0?' over':'')+'</div><div class="stat-note">Across all projects</div></div>'+
    '<div class="stat-card s-blue"><div class="stat-lbl">Total Projects</div><div class="stat-val c-blue">'+DB.projects.length+'</div><div class="stat-note">'+(DB.projects.length===1?'1 active project':DB.projects.length+' active projects')+'</div></div>';

  document.getElementById('dashSub').textContent = DB.projects.length
    ? DB.projects.length+' project'+(DB.projects.length!==1?'s':'')+' · '+DB.purchases.length+' purchase'+(DB.purchases.length!==1?'s':'')+' logged'
    : 'Create your first project to get started.';

  const grid  = document.getElementById('dashProjects');
  const empty = document.getElementById('dashEmpty');
  if (!DB.projects.length) { grid.innerHTML=''; empty.style.display='flex'; }
  else {
    empty.style.display = 'none';
    grid.innerHTML = visibleProjects().map(i => {
      const p = DB.projects[i];
      const spent = spentFromPurchases(DB.purchases.filter(x=>x.projectIdx===i));
      const pp    = p.budget>0 ? Math.round(spent/p.budget*100) : 0;
      const col   = pp>90?'var(--red)':pp>70?'var(--orange)':'var(--green)';
      const burn  = calcBurnRate(i);
      const burnLine = burn ? '<div class="proj-card-burn"><span>~$'+fmt(Math.round(burn.dailyBurn))+'/day</span><span style="color:'+(burn.daysLeft<14?'var(--orange)':'var(--text2)')+'">'+( burn.daysLeft>0?burn.daysLeft+' days left':'Budget exceeded')+'</span></div>' : '';
            const cardBarHTML = '<div class="proj-card-bar">'+renderBar(pp,col,5)+'</div>';
      return '<div class="proj-card" onclick="openProject('+i+')"><div class="proj-card-head"><div><div class="proj-card-name">'+p.name+'</div><div class="proj-card-meta">'+(p.client||'')+'</div></div><span class="tag '+(pp>90?'tag-red':pp>70?'tag-orange':'tag-green')+'">'+pp+'%</span></div>'+cardBarHTML+'<div class="proj-card-foot"><div>Spent <strong>$'+fmt(spent)+'</strong></div><div>Budget <strong>$'+fmt(p.budget)+'</strong></div></div>'+burnLine+'</div>';
    }).join('');
  }

  // At Risk panel
  const riskProjects = DB.projects.map((p,i) => {
    const spent = spentFromPurchases(DB.purchases.filter(x=>x.projectIdx===i));
    return Object.assign({},p,{idx:i,spent,pct:p.budget>0?spent/p.budget:0});
  }).filter(p=>p.pct>=0.7).sort((a,b)=>b.pct-a.pct);

  const riskList  = document.getElementById('atRiskList');
  const riskCount = document.getElementById('atRiskCount');
  riskCount.textContent = riskProjects.length+' job'+(riskProjects.length!==1?'s':'');
  riskCount.className   = 'tag '+(riskProjects.length>0?'tag-orange':'tag-green');

  if (!riskProjects.length) {
    riskList.innerHTML = '<div style="padding:1.1em 1.2em;font-size:0.82rem;color:var(--muted)">All projects under 70% — looking good 👍</div>';
  } else {
    riskList.innerHTML = riskProjects.map(p => {
      const pp  = Math.round(p.pct*100);
      const col = pp>=90?'var(--red)':'var(--orange)';
      return '<div class="risk-row" onclick="openProject('+p.idx+')"><div class="risk-dot-wrap" style="background:'+p.color+'22"><svg width="12" height="12" viewBox="0 0 12 12" fill="none"><rect x="1" y="1" width="10" height="10" rx="2" stroke="'+p.color+'" stroke-width="1.4"/></svg></div><div class="risk-info"><div style="display:flex;justify-content:space-between;align-items:baseline"><div class="risk-name">'+p.name+'</div><div class="risk-pct" style="color:'+col+'">'+pp+'%</div></div><div class="risk-meta">'+fmtShort(p.spent)+' of '+fmtShort(p.budget)+'</div><div style="margin-top:0.4em">'+renderBar(pp,col,3)+'</div></div></div>';
    }).join('');
  }

  // Activity feed
  const feed   = document.getElementById('activityFeed');
  const recent = [...DB.purchases].map((p,i)=>Object.assign({},p,{_i:i})).filter(p=>p.ts).sort((a,b)=>(b.ts||0)-(a.ts||0)).slice(0,8);
  if (!recent.length) {
    feed.innerHTML = '<div style="padding:1.1em 1.2em;font-size:0.82rem;color:var(--muted)">No transactions logged yet.</div>';
  } else {
    feed.innerHTML = recent.map(pu => {
      const proj = DB.projects[pu.projectIdx];
      const col  = proj ? proj.color : 'var(--blue)';
      return '<div class="activity-item"><div class="activity-icon" style="background:'+col+'22;color:'+col+'">$</div><div class="activity-body"><div class="activity-text"><strong>$'+fmt(pu.amount)+'</strong> at '+pu.vendor+(proj?' · <span style="color:var(--text2)">'+proj.name+'</span>':'')+'</div><div class="activity-time">'+(pu.worker||'Unknown')+' · '+(pu.ts?timeAgo(pu.ts):pu.date||'—')+'</div></div></div>';
    }).join('');
  }
}

// ══ PROJECT DETAIL ══
function renderProjectDetail(idx) {
  const p   = DB.projects[idx];
  const pus = DB.purchases.filter(x=>x.projectIdx===idx);
  const spent = spentFromPurchases(pus);
  const rem   = p.budget - spent;
  const pct   = p.budget>0 ? Math.round(spent/p.budget*100) : 0;
  const bc    = pct>90?'var(--red)':pct>70?'var(--orange)':'var(--green)';
  const burn  = calcBurnRate(idx);

  // Editable project name
  document.getElementById('projDetailNameText').textContent = p.name;
  const assignBtn = document.getElementById('projAssignBtn');
  if (assignBtn) assignBtn.style.display = DB.role === 'admin' ? '' : 'none';
  const laborBtn = document.getElementById('projLaborBtn');
  if (laborBtn) laborBtn.style.display = DB.role === 'admin' ? '' : 'none';

  // Meta row — each item clickable to edit
  const metaEl = document.getElementById('projDetailMeta');
  metaEl.innerHTML = '';
  const metaItems = [
    { label: p.clientName||null, field:'clientName', placeholder:'Add client' },
    { label: p.location||null,             field:'location',   placeholder:'Add location' },
    { label: p.startDate ? 'Started '+fmtDate(p.startDate) : null, field:'startDate', placeholder:'Add start date' },
    { label: p.endDate   ? 'Due '+fmtDate(p.endDate) : null,       field:'endDate',   placeholder:'Add end date' },
  ];
  metaItems.forEach((item, i) => {
    if (i > 0) metaEl.appendChild(document.createTextNode(' · '));
    const span = document.createElement('span');
    span.style.cssText = 'cursor:pointer;border-bottom:1px dashed rgba(255,255,255,0.15);transition:color 0.12s;padding-bottom:1px';
    span.title = 'Click to edit';
    span.textContent = item.label || item.placeholder;
    if (!item.label) span.style.color = 'var(--muted)';
    span.onmouseover = () => { span.style.color = 'var(--blue-l)'; };
    span.onmouseout  = () => { span.style.color = item.label ? '' : 'var(--muted)'; };
    span.onclick = () => editProjectField(item.field);
    metaEl.appendChild(span);
  });

  // Stat cards — budget one is editable
  const burnStat = burn
    ? '<div class="stat-card s-blue"><div class="stat-lbl">Burn Rate</div><div class="stat-val c-blue">$'+fmt(Math.round(burn.dailyBurn))+'</div><div class="stat-note">per day · '+(burn.daysLeft>0?burn.daysLeft+' days of budget left':'over budget')+'</div></div>'
    : '<div class="stat-card s-blue"><div class="stat-lbl">Transactions</div><div class="stat-val c-blue">'+pus.length+'</div><div class="stat-note">transactions logged</div></div>';

  document.getElementById('projStats').innerHTML =
        '<div class="stat-card s-blue editable" onclick="editProjectField(&apos;budget&apos;)" title="Click to edit budget">'+
      '<div class="stat-lbl">Total Budget</div>'+
      '<div class="stat-val">$'+fmt(p.budget)+'</div>'+
      '<div class="stat-note">Set at project start</div>'+
      '<div class="stat-edit-hint">✎ Click to edit</div>'+
    '</div>'+
    '<div class="stat-card '+(pct>70?'s-orange':'s-green')+'"><div class="stat-lbl">Spent</div><div class="stat-val '+(pct>90?'c-red':pct>70?'c-orange':'')+'">$'+fmt(spent)+'</div><div class="stat-note">'+pus.length+' transaction'+(pus.length!==1?'s':'')+'</div></div>'+
    '<div class="stat-card '+(rem<0?'s-red':'s-green')+'"><div class="stat-lbl">Remaining</div><div class="stat-val '+(rem<0?'c-red':'c-green')+'">$'+fmt(Math.abs(rem))+(rem<0?' over':'')+'</div><div class="stat-note">'+pct+'% used</div></div>'+
    burnStat;

  // Budget section with Edit Categories button
  const cats = p.categories||[];
  const laborEst = calcLaborEstimate(idx);
  const laborWeekly = calcLaborWeekly(idx);

  // Build labor row if enabled
  const laborRowHTML = p.laborEnabled ? (function() {
    const laborCat = 'Labor Estimate';
    const cs = spentFromPurchases(pus.filter(x=>x.category===laborCat));
    const cp = p.budget>0 ? Math.round(cs/p.budget*100) : 0;
    const estPct = p.budget>0 ? Math.round(laborEst/p.budget*100) : 0;
    const allocLabel = laborEst>0 ? ' <span style="font-size:0.65rem;color:var(--muted)">of $'+fmt(laborEst)+' est.</span>' : '';
    const col = (cs > laborEst && laborEst > 0) ? 'var(--red)' : p.color;
    return '<div class="cat-row">' +
      '<div class="cat-name" style="color:var(--blue-l);font-weight:600">⏱ Labor Estimate</div>' +
      renderBar(estPct, p.color, 5) +
      '<div class="cat-pct">'+estPct+'%'+allocLabel+'</div>' +
      '<div class="cat-amt">$'+fmt(laborEst)+' est.</div>' +
    '</div>' +
    '';
  })() : '';

  const catsWithoutLabor = cats.filter(c => c !== 'Labor Estimate');
  const catHTML = (catsWithoutLabor.length || p.laborEnabled) ? '<div style="margin-top:1.2em"><div class="section-title" style="margin-bottom:0.75em">By Category</div><div class="cat-rows">'+
    laborRowHTML +
    catsWithoutLabor.map(cat=>{
      const cs  = spentFromPurchases(pus.filter(x=>x.category===cat));
      const cp  = p.budget>0?Math.round(cs/p.budget*100):0;
      const alloc = p.catBudgets && p.catBudgets[cat] ? p.catBudgets[cat] : null;
      const allocLabel = alloc ? ' <span style="font-size:0.65rem;color:var(--muted)">of '+alloc+'% budgeted</span>' : '';
      const catBaseCol = alloc&&cp>alloc?'var(--red)':p.color;
      return '<div class="cat-row"><div class="cat-name">'+cat+'</div>'+renderBar(cp,catBaseCol,5)+'<div class="cat-pct">'+cp+'%'+allocLabel+'</div><div class="cat-amt">$'+fmt(cs)+'</div></div>';
    }).join('')+
  '</div></div>' : '';

  document.getElementById('projBudgetSection').innerHTML =
    '<div class="section-head">'+
      '<div class="section-title">Budget Overview</div>'+
      '<div style="display:flex;align-items:center;gap:0.6em">'+
        '<button class="tb-btn" style="font-size:0.75rem;padding:0.3em 0.7em" onclick="openEditCats()">✎ Categories</button>'+
        '<span class="tag '+(pct>90?'tag-red':pct>70?'tag-orange':'tag-green')+'">'+pct+'% Used</span>'+
      '</div>'+
    '</div>'+
    renderBar(pct,bc,8)+
    '<div class="budget-labels"><span>$0</span><span>$'+fmt(spent)+' spent</span><span>$'+fmt(p.budget)+'</span></div>'+catHTML;

  // Purchase table — clickable rows, no Notes column, no delete button
  const tbody = document.getElementById('projPurchasesTable');
  const empty = document.getElementById('projPurchasesEmpty');
  if (!pus.length) { tbody.innerHTML=''; empty.style.display='flex'; return; }
  empty.style.display='none';
  tbody.innerHTML = pus.map(pu => {
    const gi = DB.purchases.indexOf(pu);
    return '<tr class="pu-row" onclick="openPurchaseDetail('+gi+')" title="Click for details">'+
      '<td><strong>'+pu.vendor+'</strong></td>'+
      '<td><span class="tag tag-blue">'+(pu.category||'—')+'</span></td>'+
      '<td><strong style="color:'+(pu.type==='income'?'#22c55e':'var(--red)')+'">'+(pu.type==='income'?'+':'-')+'$'+fmt(Math.abs(pu.amount))+'</strong></td>'+
      '<td style="color:var(--text2)">'+(pu.worker||'—')+'</td>'+
      '<td style="color:var(--muted)">'+fmtDate(pu.date)+'</td>'+
    '</tr>';
  }).join('');
}

// ══ ALL PURCHASES ══
// Helper: signed amount (negative=expense, positive=income)
function txAmount(pu) { return pu.amount; } // already signed
function visibleProjects() {
  // Admins see all projects; workers only see assigned projects
  if (DB.role === 'admin') return DB.projects.map((_,i)=>i);
  const uid = getSession()?.user?.id;
  return DB.projects.map((_,i)=>i).filter(i => {
    const aw = DB.projects[i].assignedWorkers || [];
    return aw.length === 0 || aw.includes(uid);
  });
}

function spentFromPurchases(pus) { return pus.reduce((s,x) => s + (x.type === 'income' ? 0 : Math.abs(x.amount)), 0); }
function incomeFromPurchases(pus) { return pus.reduce((s,x) => s + (x.type === 'income' ? Math.abs(x.amount) : 0), 0); }

function renderAllPurchases() {
  const tbody = document.getElementById('allPurchasesTable');
  const empty = document.getElementById('allPurchasesEmpty');
  if (!DB.purchases.length) { tbody.innerHTML=''; empty.style.display='flex'; return; }
  empty.style.display='none';
  const sorted = [...DB.purchases].map((p,i)=>Object.assign({},p,{_i:i})).sort((a,b)=>(b.date||'').localeCompare(a.date||''));
  tbody.innerHTML = sorted.map(pu=>{
    const proj = DB.projects[pu.projectIdx];
    return '<tr><td><strong>'+pu.vendor+'</strong></td><td>'+(proj?'<span style="display:inline-flex;align-items:center;gap:0.35em"><span style="width:6px;height:6px;border-radius:50%;background:'+proj.color+';display:inline-block"></span>'+proj.name+'</span>':'—')+'</td><td><span class="tag tag-blue">'+(pu.category||'—')+'</span></td><td><strong style="color:'+(pu.type==='income'?'#22c55e':'var(--red)')+'">'+( pu.type==='income'?'+':'-')+'$'+fmt(Math.abs(pu.amount))+'</strong></td><td>'+(pu.worker||'—')+'</td><td style="color:var(--muted)">'+fmtDate(pu.date)+'</td><td><button class="del-btn" onclick="deletePurchase('+pu._i+')">✕</button></td></tr>';
  }).join('');
}

// ══ TEAM ══
function getInviteLink() {
  const base = window.location.href.replace(/[^/]*$/, '');
  return base + 'join.html?code=' + (DB.teamCode || '');
}
function openCompanySettings() {
  openModal('companySettingsModal');
}
function previewLogo(input) {
  if (!input.files || !input.files[0]) return;
  const file = input.files[0];
  if (file.size > 2 * 1024 * 1024) { showAlert('Image must be under 2MB', 'File Too Large'); return; }
  const reader = new FileReader();
  reader.onload = e => {
    const preview = document.getElementById('cs-logo-preview');
    preview.innerHTML = '<img src="'+e.target.result+'" style="width:100%;height:100%;object-fit:cover"/>';
    preview.dataset.dataUrl = e.target.result;
  };
  reader.readAsDataURL(file);
}
function openCompanySettingsModal() {
  // Populate fields
  document.getElementById('cs-name').value    = DB.companyName || '';
  document.getElementById('cs-plan').value    = DB.plan        || 'starter';
  // Logo preview
  const preview = document.getElementById('cs-logo-preview');
  if (DB.logoUrl) {
    preview.innerHTML = '<img src="'+DB.logoUrl+'" style="width:100%;height:100%;object-fit:cover"/>';
  } else {
    const initials = (DB.companyName||'?').split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
    preview.innerHTML = initials;
    preview.style.background = '#1a6de8';
  }
}
function canEditCompany() {
  if (DB.role === 'admin') return true;
  const uid = getSession()?.user?.id;
  const me = DB.team.find(m => m.user_id === uid);
  if (!me) return false;
  if ((me.role||'').toLowerCase() === 'admin') return true;
  return Array.isArray(me.permissions) && me.permissions.includes('edit_company');
}

function openCompanyInfo() {
  const planLabels = { starter:'Starter ($49/mo)', growth:'Growth ($99/mo)', pro:'Pro ($199/mo)', enterprise:'Enterprise ($399/mo)' };
  const memberCount = DB.team.length + 1; // +1 for the admin/owner
  const ci_logo = document.getElementById('ci-logo');
  if (DB.logoUrl) {
    ci_logo.innerHTML = '<img src="'+DB.logoUrl+'" style="width:100%;height:100%;object-fit:cover"/>';
  } else {
    ci_logo.innerHTML = '';
    ci_logo.textContent = (DB.companyName||'?').split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
    ci_logo.style.background = 'var(--blue)';
  }
  document.getElementById('ci-name').textContent = DB.companyName || '—';
  document.getElementById('ci-plan').textContent = planLabels[DB.plan] || DB.plan || '—';
  document.getElementById('ci-workers').textContent = memberCount + ' member' + (memberCount !== 1 ? 's' : '');
  document.getElementById('ci-admin').textContent = (DB.firstName + ' ' + DB.lastName).trim() || '—';
  document.getElementById('ci-code').textContent = DB.teamCode || '—';
  // Show/hide edit gear based on permission
  document.getElementById('ci-edit-btn').style.display = canEditCompany() ? '' : 'none';
  openModal('companyInfoModal');
}

async function saveCompanySettings() {
  const name    = document.getElementById('cs-name').value.trim();

  const workers = DB.team.length + 1; // actual member count, not user-entered
  const plan    = document.getElementById('cs-plan').value;
  if (!name) { document.getElementById('cs-name').focus(); return; }

  const saveBtn = document.querySelector('#companySettingsModal .btn-save');
  if (saveBtn) { saveBtn.textContent = 'Saving…'; saveBtn.disabled = true; }

  // Handle logo upload to Supabase Storage
  const preview = document.getElementById('cs-logo-preview');
  let logoUrl = DB.logoUrl || null;

  if (preview.dataset.dataUrl) {
    try {
      // Convert base64 to blob
      const dataUrl = preview.dataset.dataUrl;
      const res = await fetch(dataUrl);
      const blob = await res.blob();
      const ext = blob.type === 'image/png' ? 'png' : 'jpg';
      const path = COMPANY_ID + '/logo.' + ext;

      // Upload to Supabase Storage
      const session = getSession();
      const uploadRes = await fetch(SB_URL + '/storage/v1/object/logos/' + path, {
        method: 'POST',
        headers: {
          'apikey': SB_KEY,
          'Authorization': 'Bearer ' + session.access_token,
          'Content-Type': blob.type,
          'x-upsert': 'true'
        },
        body: blob
      });

      if (uploadRes.ok) {
        logoUrl = SB_URL + '/storage/v1/object/public/logos/' + path + '?t=' + Date.now();
      } else {
        console.error('Logo upload failed:', await uploadRes.text());
      }
    } catch(e) {
      console.error('Logo upload error:', e);
    }
  }

  // Update local DB
  DB.companyName  = name;
  DB.workerCount  = workers;
  DB.plan         = plan;
  DB.logoUrl      = logoUrl;

  // Update UI immediately
  document.getElementById('sidebarCompany').textContent = name;
  document.getElementById('sidebarPlan').textContent = plan.charAt(0).toUpperCase()+plan.slice(1)+' Plan · '+workers+' workers';
  document.getElementById('userName').textContent = (DB.firstName+' '+DB.lastName).trim() || name;
  updateCompanyLogo();

  // Persist to Supabase
  try {
    await sbPatch('companies', 'id=eq.'+COMPANY_ID, {
      name, plan, worker_count: workers, logo_url: logoUrl
    });
  } catch(e) {
    console.error('Save company failed:', e);
    showAlert('Failed to save. Check your connection.', 'Error');
  }

  if (saveBtn) { saveBtn.textContent = 'Save Changes'; saveBtn.disabled = false; }
  closeModal('companySettingsModal');
  delete preview.dataset.dataUrl;
}
function updateCompanyLogo() {
  const displays = ['companyLogoDisplay', 'cs-logo-preview'];
  displays.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    if (DB.logoUrl) {
      el.innerHTML = '<img src="'+DB.logoUrl+'" style="width:100%;height:100%;object-fit:cover"/>';
    } else {
      const initials = (DB.companyName||'?').split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
      el.textContent = initials;
      el.style.background = '#1a6de8';
      el.innerHTML = initials;
    }
  });
}
function copyInviteLink() {
  navigator.clipboard.writeText(getInviteLink()).then(() => {
    const btn = document.getElementById('copyLinkBtn');
    btn.textContent = 'Copied!';
    setTimeout(() => { btn.textContent = 'Copy'; }, 2000);
  });
}
function copyTeamCode() {
  navigator.clipboard.writeText(DB.teamCode || '').then(() => {
    const btn = document.getElementById('copyCodeBtn');
    btn.textContent = 'Copied!';
    setTimeout(() => { btn.textContent = 'Copy'; }, 2000);
  });
}
function regenerateCode() {
  showConfirm('The old invite link will stop working immediately. Anyone you\'ve already sent it to will need the new link.', () => { DB.teamCode = genCode(); sbSaveCompany().catch(console.error); renderTeam(); }, 'Reset Invite Link?', 'Reset Link');
}
// ══ SUBCONTRACTORS ══
const SUB_STATUS_STYLE = {
  'Active':   'sub-status-active',
  'Pending':  'sub-status-pending',
  'Complete': 'sub-status-complete',
};

function renderSubs() {
  const grid    = document.getElementById('subGrid');
  const empty   = document.getElementById('subEmpty');
  const addBtn  = document.getElementById('addSubBtn');
  if (!grid) return;
  const isAdmin = DB.role === 'admin';
  if (addBtn) addBtn.style.display = isAdmin ? '' : 'none';
  // Workers don't see subcontractor section at all (financial/contract info)
  const subSection = document.getElementById('subSection');
  if (subSection) subSection.style.display = isAdmin ? '' : 'none';
  if (!isAdmin) return;
  const subs = DB.subs || [];
  if (!subs.length) {
    grid.innerHTML = '';
    empty.style.display = '';
    return;
  }
  empty.style.display = 'none';
  grid.innerHTML = subs.map((s, i) => {
    const projects = s.projects || [];
    const totalContract = projects.reduce((sum, p) => sum + (p.contractAmt || 0), 0);
    const activeCount   = projects.filter(p => p.status === 'Active').length;
    const initials      = s.name.split(' ').map(w => w[0]).join('').slice(0,2).toUpperCase();
    const statusSummary = projects.length === 0 ? 'No projects yet'
      : projects.length === 1 ? (projects[0].status + ' · ' + (DB.projects[projects[0].projIdx]?.name || 'Unknown'))
      : projects.length + ' projects' + (activeCount > 0 ? ' · ' + activeCount + ' active' : '');

    // Dominant status color for avatar
    const hasActive   = projects.some(p => p.status === 'Active');
    const hasPending  = projects.some(p => p.status === 'Pending');
    const avatarColor = hasActive ? '#0da068' : hasPending ? '#d99520' : 'var(--surface3)';
    const avatarText  = hasActive ? '#fff' : hasPending ? '#fff' : 'var(--muted)';

    return `<div class="sub-card" onclick="openSubDetail(${i})">
      <div style="display:flex;align-items:center;gap:0.85em;margin-bottom:0.9em">
        <div style="width:40px;height:40px;border-radius:0.5em;background:${avatarColor};display:grid;place-items:center;font-size:0.78rem;font-weight:700;color:${avatarText};flex-shrink:0;letter-spacing:0.02em">${initials}</div>
        <div style="min-width:0;flex:1;overflow:hidden">
          <div style="font-size:0.95rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${s.name}</div>
          <div style="font-size:0.73rem;color:var(--muted);margin-top:0.1em">${s.trade || 'Subcontractor'}</div>
        </div>
        ${totalContract > 0 ? `<div style="text-align:right;flex-shrink:0"><div style="font-size:1rem;font-weight:700">$${fmt(totalContract)}</div><div style="font-size:0.68rem;color:var(--muted)">contracted</div></div>` : ''}
      </div>
      <div style="font-size:0.78rem;color:var(--text2);padding-top:0.7em;border-top:1px solid var(--border)">${statusSummary}</div>
    </div>`;
  }).join('');
}

let currentSubIdx = null;

function openAddSubModal() {
  document.getElementById('sub-name').value = '';
  document.getElementById('sub-trade').value = '';
  openModal('addSubModal');
  setTimeout(() => document.getElementById('sub-name').focus(), 80);
}

function saveNewSub() {
  const name = document.getElementById('sub-name').value.trim();
  if (!name) { document.getElementById('sub-name').focus(); return; }
  const trade = document.getElementById('sub-trade').value.trim();
  const sub = { name, trade, projects: [] };
  DB.subs.push(sub);
  const idx = DB.subs.length - 1;
  closeModal('addSubModal');
  sbSaveSub(sub, idx).then(() => renderSubs()).catch(console.error);
  renderSubs();
  // Auto open detail
  openSubDetail(idx);
}

function openSubDetail(idx) {
  if (DB.role !== 'admin') return;
  currentSubIdx = idx;
  const s = DB.subs[idx];
  document.getElementById('subDetailName').textContent = s.name;
  document.getElementById('subDetailTrade').textContent = s.trade || '';
  // Populate project select
  const sel = document.getElementById('sub-proj-select');
  sel.innerHTML = DB.projects.map((p, i) => `<option value="${i}">${p.name}</option>`).join('');
  document.getElementById('sub-contract-amt').value = '';
  document.getElementById('sub-status').value = 'Active';
  renderSubProjectList(idx);
  openModal('subDetailModal');
}

function renderSubProjectList(idx) {
  const s    = DB.subs[idx];
  const list = document.getElementById('subProjectList');
  if (!s.projects.length) {
    list.innerHTML = '<div style="font-size:0.8rem;color:var(--muted);padding:0.5em 0">No projects yet — add one below.</div>';
    return;
  }
  list.innerHTML = s.projects.map((entry, ei) => {
    const proj     = DB.projects[entry.projIdx];
    const projName = proj?.name || 'Unknown Project';
    const statusClass = SUB_STATUS_STYLE[entry.status] || 'sub-status-pending';
    return `<div style="display:flex;align-items:center;gap:0.75em;padding:0.65em 0.85em;background:var(--surface2);border:1px solid var(--border);border-radius:0.55em">
      <div style="flex:1;min-width:0">
        <div style="font-size:0.88rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${projName}</div>
        <div style="font-size:0.75rem;color:var(--text2);margin-top:0.1em">$${fmt(entry.contractAmt || 0)} contracted</div>
      </div>
      <span style="font-size:0.68rem;font-weight:700;letter-spacing:0.05em;text-transform:uppercase;padding:0.2em 0.6em;border-radius:0.3em" class="${statusClass}">${entry.status}</span>
      ${DB.role==='admin' ? `<button onclick="removeSubProject(${idx},${ei})" style="background:none;border:none;cursor:pointer;color:var(--muted);font-size:0.85rem;padding:0.1em 0.2em;line-height:1;transition:color 0.12s" onmouseover="this.style.color='var(--red)'" onmouseout="this.style.color='var(--muted)'">✕</button>` : ''}
    </div>`;
  }).join('');
}

function addSubProjectEntry() {
  if (currentSubIdx === null) return;
  const projIdx     = parseInt(document.getElementById('sub-proj-select').value);
  const contractAmt = parseFloat(document.getElementById('sub-contract-amt').value) || 0;
  const status      = document.getElementById('sub-status').value;
  if (isNaN(projIdx)) return;
  const s = DB.subs[currentSubIdx];
  const entry = { projIdx, contractAmt, status };
  s.projects.push(entry);
  sbSaveSub(s, currentSubIdx).catch(console.error);
  // Auto-create expense transaction on the project
  if (contractAmt > 0) {
    const me      = DB.team.find(m => m.user_id === getSession()?.user?.id);
    const addedBy = me ? (me.firstName+' '+me.lastName).trim() : 'Admin';
    const tx = {
      vendor: s.name + (s.trade ? ' ('+s.trade+')' : ''),
      amount: contractAmt, type: 'expense',
      category: 'Subcontractors',
      date: new Date().toISOString().slice(0,10),
      notes: 'Subcontractor: ' + s.name,
      worker: addedBy, projectIdx: projIdx, ts: Date.now(),
    };
    DB.purchases.push(tx);
    sbSavePurchase(tx, DB.purchases.length-1).catch(console.error);
  }
  renderSubProjectList(currentSubIdx);
  renderSubs();
  if (contractAmt > 0) {
    const proj = DB.projects[projIdx];
    pushNotif('sub_added', s.name+' added to '+(proj?.name||'project'), '$'+fmt(contractAmt)+' contract · '+status+(s.trade?' · '+s.trade:''), {projectIdx:projIdx});
  }
}

function removeSubProject(subIdx, entryIdx) {
  const s     = DB.subs[subIdx];
  const entry = s.projects[entryIdx];
  // Delete the matching subcontractor transaction from this project
  if (entry) {
    const vendorName = s.name + (s.trade ? ' ('+s.trade+')' : '');
    const txIdx = DB.purchases.findIndex(p =>
      p.projectIdx === entry.projIdx &&
      p.vendor === vendorName &&
      p.category === 'Subcontractors' &&
      p.amount === entry.contractAmt
    );
    if (txIdx >= 0) {
      const tx = DB.purchases[txIdx];
      if (tx._id) {
        fetch(SB_URL+'/rest/v1/purchases?id=eq.'+tx._id, {
          method:'DELETE',
          headers:{apikey:SB_KEY,Authorization:'Bearer '+getSession()?.access_token,'Content-Type':'application/json'}
        }).catch(console.error);
      }
      DB.purchases.splice(txIdx, 1);
    }
  }
  s.projects.splice(entryIdx, 1);
  sbSaveSub(s, subIdx).catch(console.error);
  renderSubProjectList(subIdx);
  renderSubs();
}

function deleteCurrentSub() {
  if (currentSubIdx === null) return;
  const s = DB.subs[currentSubIdx];
  showConfirm('Remove ' + s.name + ' from subcontractors?', async () => {
    if (s._id) {
      await fetch(SB_URL+'/rest/v1/subs?id=eq.'+s._id, {
        method:'DELETE',
        headers:{apikey:SB_KEY,Authorization:'Bearer '+getSession()?.access_token,'Content-Type':'application/json'}
      }).catch(console.error);
    }
    DB.subs.splice(currentSubIdx, 1);
    closeModal('subDetailModal');
    renderSubs();
  }, 'Remove Subcontractor?', 'Remove', true);
}

async function sbSaveSub(sub, localIdx) {
  if (!COMPANY_ID) return;
  const payload = {
    company_id: COMPANY_ID,
    name:       sub.name,
    trade:      sub.trade || null,
    projects:   sub.projects || [],
  };
  if (sub._id) {
    await sbPatch('subs', 'id=eq.'+sub._id, payload);
  } else {
    const rows = await sbPost('subs', payload);
    if (rows?.[0]?.id) DB.subs[localIdx]._id = rows[0].id;
  }
}

function renderTeam() {
  const grid  = document.getElementById('teamGrid');
  const empty = document.getElementById('teamEmpty');
  if (!DB.teamCode) { DB.teamCode = genCode(); sbSaveCompany().catch(console.error); }
  const isPrimaryAdmin = DB.role === 'admin';
  // Show invite section only for admins
  const banner = document.getElementById('teamCodeBanner');
  if (banner) banner.style.display = isPrimaryAdmin ? '' : 'none';
  const linkInput = document.getElementById('teamLinkInput');
  if (linkInput) linkInput.value = getInviteLink();
  const codeText = document.getElementById('teamCodeText');
  if (codeText) codeText.textContent = DB.teamCode || '';
  // Show/hide team header ... button based on admin status
  const teamDotBtn = document.getElementById('teamDotBtn');
  if (teamDotBtn) teamDotBtn.style.display = isPrimaryAdmin ? '' : 'none';
  const currentUid = getSession()?.user?.id;
  const fullTeam = [...DB.team].sort((a, b) => {
    const la = (a.lastName || '').trim().toLowerCase();
    const lb = (b.lastName || '').trim().toLowerCase();
    if (!la && !lb) return 0;
    if (!la) return 1;
    if (!lb) return -1;
    return la.localeCompare(lb);
  });
  document.getElementById('teamSub').textContent = fullTeam.length+' member'+(fullTeam.length!==1?'s':'')+' · '+(DB.plan||'')+' plan';
  empty.style.display = 'none';
  renderSubs();

  grid.innerHTML = fullTeam.map((m, i) => {
    const init    = ((m.firstName||'?')[0]+(m.lastName||'?')[0]).toUpperCase();
    const col     = AVATAR_COLORS[i % AVATAR_COLORS.length];
    const spend   = spentFromPurchases(DB.purchases.filter(p=>p.worker&&p.worker.startsWith(m.firstName)));
    const count   = DB.purchases.filter(p=>p.worker&&p.worker.startsWith(m.firstName)).length;
    const projSet = new Set(DB.purchases.filter(p=>p.worker&&p.worker.startsWith(m.firstName)).map(p=>p.projectIdx));
    const role    = (m.role||'worker').toLowerCase();
    const isOwner = false; // everyone is in team_members now, no special owner entry
    const currentUid = getSession()?.user?.id;
    const isYou = !!currentUid && m.user_id === currentUid;

    const adminStyle = `display:inline-flex;align-items:center;padding:0.2em 0.6em;border-radius:0.3em;font-size:0.67rem;font-weight:700;letter-spacing:0.05em;text-transform:uppercase;background:rgba(217,149,32,0.15);color:#d99520;border:1px solid rgba(217,149,32,0.25)`;
    const workerStyle = `display:inline-flex;align-items:center;padding:0.2em 0.6em;border-radius:0.3em;font-size:0.67rem;font-weight:700;letter-spacing:0.05em;text-transform:uppercase;background:rgba(26,109,232,0.12);color:var(--blue-l);border:1px solid rgba(26,109,232,0.2)`;
    const roleTag = (isOwner || role === 'admin')
      ? `<span style="${adminStyle}">Admin</span>`
      : `<span style="${workerStyle}">Worker</span>`;

    const teamIdx = DB.team.indexOf(m);
    const canManage = isPrimaryAdmin && !isYou && teamIdx >= 0;
    const menuBtn = canManage ? `
      <div style="position:relative;flex-shrink:0">
        <button class="tb-btn member-menu-btn" style="padding:0.2em 0.5em;font-size:0.78rem;line-height:1" onclick="event.stopPropagation();toggleMemberMenu(event,${teamIdx})">···</button>
        <div class="member-menu" id="mmenu-${teamIdx}" style="display:none;position:absolute;right:0;top:calc(100% + 4px);background:var(--surface);border:1px solid var(--border2);border-radius:0.5em;min-width:165px;z-index:100;box-shadow:0 8px 24px rgba(0,0,0,0.4);overflow:hidden">
          <button onclick="event.stopPropagation();openPermsModal(${teamIdx})" style="display:flex;align-items:center;gap:0.55em;width:100%;text-align:left;padding:0.65em 0.9em;background:none;border:none;cursor:pointer;font-size:0.82rem;color:var(--text);font-family:'DM Sans',sans-serif" onmouseenter="this.style.background='var(--surface2)'" onmouseleave="this.style.background='none'"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" style="flex-shrink:0"><path d="M2.5 7L5.5 10L11.5 4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg> Allowed</button>
          <button onclick="event.stopPropagation();promoteMember(${teamIdx})" style="display:flex;align-items:center;gap:0.55em;width:100%;text-align:left;padding:0.65em 0.9em;background:none;border:none;cursor:pointer;font-size:0.82rem;color:var(--text);font-family:'DM Sans',sans-serif" onmouseenter="this.style.background='var(--surface2)'" onmouseleave="this.style.background='none'">${role==='admin'
  ? '<svg width="14" height="14" viewBox="0 0 14 14" fill="none" style="flex-shrink:0"><path d="M7 11V3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M4 6l3-3 3 3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg> Demote'
  : '<svg width="14" height="14" viewBox="0 0 14 14" fill="none" style="flex-shrink:0"><path d="M7 3v8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M4 8l3 3 3-3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg> Promote to Admin'}</button>
          <button onclick="event.stopPropagation();deleteMember(${teamIdx})" style="display:flex;align-items:center;gap:0.55em;width:100%;text-align:left;padding:0.65em 0.9em;background:none;border:none;cursor:pointer;font-size:0.82rem;color:var(--red);font-family:'DM Sans',sans-serif" onmouseenter="this.style.background='var(--surface2)'" onmouseleave="this.style.background='none'"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" style="flex-shrink:0"><path d="M2 3.5h10M5 3.5V2.5a.5.5 0 01.5-.5h3a.5.5 0 01.5.5v1M5.5 6v4M8.5 6v4M3 3.5l.7 7.5a.5.5 0 00.5.5h5.6a.5.5 0 00.5-.5L11 3.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg> Remove</button>
        </div>
      </div>` : '';

    // Determine card click: owner opens profile modal, others open detail modal
    const cardClick = isYou ? `openProfileModal()` : `openMemberDetail(${teamIdx})`;

    // Build recent purchases snippet (last 3)
    const recentBuys = DB.purchases.filter(p=>p.worker&&p.worker.startsWith(m.firstName)).slice(0,3);
    const recentHtml = recentBuys.length ? recentBuys.map(p=>`
      <div style="display:flex;justify-content:space-between;align-items:center;padding:0.45em 0;border-top:1px solid var(--border)">
        <span style="font-size:0.78rem;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:60%">${p.vendor||'Unknown'}</span>
        <span style="font-size:0.78rem;font-weight:600;flex-shrink:0">$${fmt(p.amount)}</span>
      </div>`).join('') : '';

    return `<div class="member-card" onclick="${cardClick}" style="${isYou ? 'background:rgba(26,109,232,0.07);border-color:rgba(26,109,232,0.25);' : ''}">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:0.5em;margin-bottom:1em">
        <div style="display:flex;align-items:center;gap:0.9em;min-width:0;flex:1;overflow:hidden">
          <div class="member-avatar" style="background:${col};flex-shrink:0">${init}</div>
          <div style="min-width:0;overflow:hidden">
            <div class="member-name" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${m.firstName} ${m.lastName}</div>
            <div style="font-size:0.73rem;color:var(--muted);margin-top:0.15em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${m.email||'—'}</div>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:0.35em;flex-shrink:0">
          ${roleTag}${menuBtn}
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.5em;padding:0.85em 0;border-top:1px solid var(--border);border-bottom:${recentHtml?'1px solid var(--border)':'none'};margin-bottom:${recentHtml?'0.6em':'0'}">
        <div style="text-align:center">
          <div class="member-stat-val">${fmtShort(spend)}</div>
          <div class="member-stat-lbl">spent</div>
        </div>
        <div style="text-align:center;border-left:1px solid var(--border)">
          <div class="member-stat-val">${count}</div>
          <div class="member-stat-lbl">transactions</div>
        </div>
        <div style="text-align:center;border-left:1px solid var(--border)">
          <div class="member-stat-val">${projSet.size}</div>
          <div class="member-stat-lbl">projects</div>
        </div>
      </div>
      ${recentHtml ? `<div style="padding:0.1em 0">${recentHtml}</div>` : ''}
    </div>`;
  }).join('');
}

function toggleMemberMenu(e, idx) {
  e.stopPropagation();
  // Close all other menus
  document.querySelectorAll('.member-menu').forEach(m => {
    if (m.id !== 'mmenu-'+idx) m.style.display = 'none';
  });
  const menu = document.getElementById('mmenu-'+idx);
  menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

// Close menus when clicking outside
document.addEventListener('click', () => {
  document.querySelectorAll('.member-menu').forEach(m => m.style.display = 'none');
});

function promoteMember(idx) {
  const m       = DB.team[idx];
  const isAdmin = (m.role||'').toLowerCase() === 'admin';
  const newRole = isAdmin ? 'Worker' : 'Admin';
  const action  = isAdmin ? 'Demote to Worker' : 'Promote to Admin';
  // When promoting to admin, give full permissions; when demoting, use default worker perms
  const newPerms = isAdmin ? (DB.defaultWorkerPerms || DEFAULT_WORKER_PERMISSIONS) : null;
  showConfirm(
    (isAdmin ? 'Remove admin access from ' : 'Give admin access to ') + m.firstName + ' ' + m.lastName + '?',
    async () => {
      DB.team[idx].role = newRole;
      DB.team[idx].permissions = newPerms;
      renderTeam();
      try {
        await sbPatch('team_members', 'id=eq.' + m._id, { role: newRole, permissions: newPerms });
      } catch(e) { console.error('promote failed', e); }
      const pType = newRole==='Admin' ? 'promoted' : 'demoted';
      pushNotif(pType, m.firstName+' '+(m.lastName||'')+' '+(newRole==='Admin'?'promoted to Admin':'demoted to Worker'), newRole==='Admin'?m.firstName+' now has full admin access.':m.firstName+' is now a standard worker.', {});
    },
    action,
    action
  );
}

// ── PERMISSIONS MODAL ──
let _permsTargetIdx = null;

function buildPermsChecklist(containerId, currentPerms, disabled) {
  const el = document.getElementById(containerId);
  if (!el) return;
  el.innerHTML = ALL_PERMISSIONS.map(p => {
    const checked = currentPerms === null || currentPerms.includes(p.id); // null = all (admin)
    return `<label style="display:flex;align-items:center;gap:0.75em;padding:0.7em 0.5em;border-radius:0.4em;cursor:${disabled?'default':'pointer'};transition:background 0.12s" onmouseenter="if(!${disabled})this.style.background='var(--surface2)'" onmouseleave="this.style.background='none'">
      <input type="checkbox" data-perm="${p.id}" ${checked?'checked':''} ${disabled?'disabled':''} style="width:15px;height:15px;accent-color:var(--blue);cursor:${disabled?'default':'pointer'}">
      <span style="font-size:0.75rem">${p.icon}</span>
      <span style="font-size:0.85rem;${disabled?'color:var(--muted)':''}">${p.label}</span>
    </label>`;
  }).join('');
}

function openPermsModal(idx) {
  _permsTargetIdx = idx;
  const m = DB.team[idx];
  const isAdmin = (m.role||'').toLowerCase() === 'admin';
  const col = AVATAR_COLORS[idx % AVATAR_COLORS.length];
  const init = ((m.firstName||'?')[0]+(m.lastName||'?')[0]).toUpperCase();

  // Member header
  document.getElementById('permsModalMember').innerHTML = `
    <div style="width:38px;height:38px;border-radius:50%;background:${col};display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.9rem;flex-shrink:0">${init}</div>
    <div>
      <div style="font-weight:600;font-size:0.95rem">${m.firstName} ${m.lastName}</div>
      <div style="font-size:0.75rem;color:var(--muted)">${m.email||'Team member'}</div>
    </div>`;

  // Admin toggle
  const adminCheck = document.getElementById('permsAdminCheck');
  const adminTrack = document.getElementById('permsAdminTrack');
  const adminThumb = document.getElementById('permsAdminThumb');
  adminCheck.checked = isAdmin;
  adminTrack.style.background = isAdmin ? 'var(--blue)' : 'var(--border2)';
  adminThumb.style.transform = isAdmin ? 'translateX(18px)' : 'translateX(0)';

  buildPermsChecklist('permsChecklist', isAdmin ? null : (m.permissions || DEFAULT_WORKER_PERMISSIONS), isAdmin);
  openModal('permsModal');
}

function onPermsAdminToggle() {
  const isAdmin = document.getElementById('permsAdminCheck').checked;
  const track = document.getElementById('permsAdminTrack');
  const thumb = document.getElementById('permsAdminThumb');
  track.style.background = isAdmin ? 'var(--blue)' : 'var(--border2)';
  thumb.style.transform = isAdmin ? 'translateX(18px)' : 'translateX(0)';
  // Rebuild checklist — disabled+all checked if admin, otherwise editable
  if (_permsTargetIdx !== null) {
    const m = DB.team[_permsTargetIdx];
    buildPermsChecklist('permsChecklist', isAdmin ? null : (m.permissions || DEFAULT_WORKER_PERMISSIONS), isAdmin);
  }
}

async function savePermissions() {
  if (_permsTargetIdx === null) return;
  const m = DB.team[_permsTargetIdx];
  const isAdmin = document.getElementById('permsAdminCheck').checked;
  let perms = null;
  if (!isAdmin) {
    perms = [...document.querySelectorAll('#permsChecklist input[type=checkbox]:checked')].map(cb => cb.dataset.perm);
  }
  const newRole = isAdmin ? 'Admin' : 'Worker';
  DB.team[_permsTargetIdx].role = newRole;
  DB.team[_permsTargetIdx].permissions = perms;
  renderTeam();
  closeModal('permsModal');
  try {
    await sbPatch('team_members', 'id=eq.' + m._id, { role: newRole, permissions: perms });
    showToast('Permissions saved');
  } catch(e) { showToast('Save failed'); }
}

function openDefaultPermsModal() {
  document.getElementById('teamHeaderDropdown').style.display = 'none';
  buildPermsChecklist('defaultPermsChecklist', DB.defaultWorkerPerms || DEFAULT_WORKER_PERMISSIONS, false);
  openModal('defaultPermsModal');
}

async function saveDefaultPerms() {
  const perms = [...document.querySelectorAll('#defaultPermsChecklist input[type=checkbox]:checked')].map(cb => cb.dataset.perm);
  DB.defaultWorkerPerms = perms;
  closeModal('defaultPermsModal');
  try {
    await sbPatch('companies', 'id=eq.' + COMPANY_ID, { default_worker_perms: perms });
    showToast('Default permissions saved');
  } catch(e) { showToast('Save failed'); }
}

function toggleTeamHeaderMenu() {
  const dd = document.getElementById('teamHeaderDropdown');
  const isOpen = dd.style.display !== 'none';
  dd.style.display = isOpen ? 'none' : 'block';
  if (!isOpen) {
    setTimeout(() => document.addEventListener('click', function h() {
      dd.style.display = 'none'; document.removeEventListener('click', h);
    }), 0);
  }
}

// ══ ALERTS ══
// ══ NOTIFICATIONS ══
async function pushNotif(type, title, body, extras) {
  if (!COMPANY_ID) return;
  const me = ((DB.firstName||'')+' '+(DB.lastName||'')).trim() || 'System';
  const notif = {
    _id: null, type, title, body, read: false,
    actorName: me, createdAt: new Date().toISOString(),
    projectIdx: extras?.projectIdx,
  };
  DB.notifications.unshift(notif);
  updateAlertsBadge();
  // Persist to Supabase
  const payload = {
    company_id:  COMPANY_ID,
    type, title, body,
    actor_name:  me,
    project_id:  extras?.projectIdx !== undefined ? (DB.projects[extras.projectIdx]?._id || null) : null,
    project_idx: extras?.projectIdx ?? null,
    read:        false,
  };
  sbPost('notifications', payload).then(rows => {
    if (rows?.[0]?.id) notif._id = rows[0].id;
  }).catch(console.error);
}

function timeAgo(iso) {
  if (!iso) return '';
  const diff = Date.now() - new Date(iso).getTime();
  const m = Math.floor(diff/60000), h = Math.floor(diff/3600000), d = Math.floor(diff/86400000);
  if (d > 6)  return new Date(iso).toLocaleDateString('en-US',{month:'short',day:'numeric'});
  if (d >= 1) return d+'d ago';
  if (h >= 1) return h+'h ago';
  if (m >= 1) return m+'m ago';
  return 'Just now';
}

const NOTIF_ICONS = {
  member_join:    { icon:'👤', bg:'rgba(26,109,232,0.12)',  color:'var(--blue-l)' },
  promoted:       { icon:'⭐', bg:'rgba(217,149,32,0.12)',  color:'#d99520' },
  demoted:        { icon:'⬇️', bg:'rgba(255,255,255,0.06)', color:'var(--muted)' },
  project_create: { icon:'📁', bg:'rgba(26,109,232,0.1)',   color:'var(--blue-l)' },
  assigned:       { icon:'📌', bg:'rgba(13,160,104,0.12)',  color:'var(--green)' },
  transaction:    { icon:'💰', bg:'rgba(13,160,104,0.1)',   color:'var(--green)' },
  hourly_rate:    { icon:'💵', bg:'rgba(217,149,32,0.1)',   color:'#d99520' },
  budget_alert:   { icon:'⚠️', bg:'rgba(232,64,64,0.1)',    color:'var(--red)' },
  sub_added:      { icon:'🔧', bg:'rgba(26,109,232,0.08)',  color:'var(--blue-l)' },
  labor_saved:    { icon:'⏱', bg:'rgba(26,109,232,0.08)',   color:'var(--blue-l)' },
  default:        { icon:'🔔', bg:'rgba(255,255,255,0.06)', color:'var(--text2)' },
};

function updateAlertsBadge() {
  const badge   = document.getElementById('alertsBadge');
  const budgetAlerts = computeAlerts();
  const unread  = (DB.notifications||[]).filter(n=>!n.read).length;
  const total   = unread + budgetAlerts.filter(a=>a.severity==='critical'||a.severity==='high').length;
  if (total > 0) { badge.style.display='grid'; badge.textContent=total>99?'99+':total; }
  else { badge.style.display='none'; }
}

function markAllRead() {
  const unread = DB.notifications.filter(n=>!n.read);
  unread.forEach(n => {
    n.read = true;
    if (n._id) sbPatch('notifications','id=eq.'+n._id,{read:true}).catch(console.error);
  });
  updateAlertsBadge();
  renderAlerts();
}

function renderAlerts() {
  const empty   = document.getElementById('alertsEmpty');
  const notifs  = DB.notifications || [];
  const budgets = computeAlerts();
  const markBtn = document.getElementById('markAllReadBtn');

  // Budget alerts section
  const budgetWrap = document.getElementById('budgetAlertsWrap');
  if (budgetWrap) {
    if (budgets.length) {
      const sevCfg = {
        critical: { color:'var(--red)',    bg:'rgba(232,64,64,0.1)',  label:'Critical' },
        high:     { color:'var(--red)',    bg:'rgba(232,64,64,0.07)', label:'High'     },
        medium:   { color:'var(--orange)', bg:'rgba(217,149,32,0.09)',label:'Medium'   },
        low:      { color:'var(--blue-l)', bg:'rgba(26,109,232,0.07)',label:'Info'     },
      };
      budgetWrap.innerHTML =
        '<div style="font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--muted);margin-bottom:0.6em">Budget Alerts</div>'+
        '<div style="display:flex;flex-direction:column;gap:0.45em;margin-bottom:1.25em">'+
        budgets.map(a => {
          const s = sevCfg[a.severity]||sevCfg.low;
          return '<div class="alert-item" style="cursor:'+(a.projectIdx!==undefined?'pointer':'default')+'" onclick="'+(a.projectIdx!==undefined?'openProject('+a.projectIdx+')':'')+'">'
            +'<div class="alert-icon" style="background:'+s.bg+'"><svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M6 1L1 10h10L6 1z" stroke="'+s.color+'" stroke-width="1.4" stroke-linejoin="round"/><path d="M6 5v2.5M6 9v.5" stroke="'+s.color+'" stroke-width="1.4" stroke-linecap="round"/></svg></div>'
            +'<div class="alert-body"><div class="alert-title">'+a.title+'</div><div class="alert-desc">'+a.desc+'</div></div>'
            +'<span style="font-size:0.65rem;font-weight:700;letter-spacing:0.05em;text-transform:uppercase;padding:0.2em 0.55em;border-radius:0.3em;color:'+s.color+';background:'+s.bg+';flex-shrink:0">'+s.label+'</span>'
            +'</div>';
        }).join('')+'</div>';
    } else {
      budgetWrap.innerHTML = '';
    }
  }

  // Activity notifications
  const notifList = document.getElementById('notifList');
  const unread = notifs.filter(n=>!n.read).length;
  if (markBtn) markBtn.style.display = unread > 0 ? '' : 'none';

  if (!notifs.length && !budgets.length) {
    if (notifList) notifList.innerHTML = '';
    empty.style.display = 'flex'; return;
  }
  empty.style.display = 'none';

  if (!notifList) return;
  if (!notifs.length) { notifList.innerHTML = ''; return; }

  // Section header
  let html = '<div style="font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--muted);margin-bottom:0.6em">Activity</div>';
  html += notifs.map((n,i) => {
    const cfg = NOTIF_ICONS[n.type] || NOTIF_ICONS.default;
    const isUnread = !n.read;
    return '<div class="alert-item" style="cursor:'+(n.projectIdx!==undefined?'pointer':'default')+';opacity:'+(isUnread?1:0.65)+';border-left:2px solid '+(isUnread?'var(--blue)':'transparent')+'" onclick="readNotif('+i+',event)">'
      +'<div class="alert-icon" style="background:'+cfg.bg+';font-size:0.85rem;display:grid;place-items:center">'+cfg.icon+'</div>'
      +'<div class="alert-body"><div class="alert-title" style="font-weight:'+(isUnread?700:500)+'">'+n.title+'</div><div class="alert-desc">'+n.body+'</div></div>'
      +'<span style="font-size:0.7rem;color:var(--muted);white-space:nowrap;flex-shrink:0">'+timeAgo(n.createdAt)+'</span>'
      +(isUnread?'<div style="width:6px;height:6px;border-radius:50%;background:var(--blue);flex-shrink:0;margin-left:0.25em"></div>':'')
    +'</div>';
  }).join('');
  notifList.innerHTML = html;
}

function readNotif(idx, e) {
  const n = DB.notifications[idx];
  if (!n) return;
  if (!n.read) {
    n.read = true;
    if (n._id) sbPatch('notifications','id=eq.'+n._id,{read:true}).catch(console.error);
    updateAlertsBadge();
    renderAlerts();
  }
  if (n.projectIdx !== undefined && n.projectIdx >= 0) openProject(n.projectIdx);
}

// ══ REPORTS ══
let reportFilter = 'all';

function setReportFilter(f) {
  reportFilter = f;
  document.querySelectorAll('.report-filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === f));
  renderReports();
}

function getProjectStatus(p) {
  const now = new Date(); now.setHours(0,0,0,0);
  const start = p.startDate ? new Date(p.startDate+'T00:00:00') : null;
  const end   = p.endDate   ? new Date(p.endDate+'T00:00:00')   : null;
  if (start && start > now) return 'upcoming';
  if (end && end < now)     return 'completed';
  return 'in-progress';
}

function renderReports() {
  const grid  = document.getElementById('reportsGrid');
  const empty = document.getElementById('reportsEmpty');
  if (!DB.projects.length) { grid.innerHTML=''; empty.style.display='flex'; return; }
  const filtered = DB.projects.map((p,i) => ({p,i})).filter(({p}) => reportFilter === 'all' || getProjectStatus(p) === reportFilter);
  if (!filtered.length) { grid.innerHTML=''; empty.style.display='flex'; return; }
  empty.style.display='none';
  grid.innerHTML = filtered.map(({p,i}) => {
    const pus   = DB.purchases.filter(x=>x.projectIdx===i);
    const spent = spentFromPurchases(pus);
    const pct   = p.budget>0?Math.round(spent/p.budget*100):0;
    const status = getProjectStatus(p);
    const statusColor = status==='in-progress'?'var(--green)':status==='upcoming'?'var(--blue)':'var(--muted)';
    const statusLabel = status==='live'?'In Progress':status==='upcoming'?'Upcoming':'Completed';
    // Days duration
    let daysStr = '';
    if (p.startDate && p.endDate) {
      const days = Math.round((new Date(p.endDate+'T00:00:00') - new Date(p.startDate+'T00:00:00'))/(1000*86400));
      daysStr = days + ' day' + (days!==1?'s':'');
    }
    const barColor = pct>100?'var(--red)':pct>80?'#f5a623':'var(--green)';
    return '<div class="report-card" onclick="window.open(getReportURL('+i+'),\'_blank\')">'+
      '<div style="display:flex;align-items:center;gap:0.9em">'+
        '<div style="width:38px;height:38px;border-radius:0.5em;background:'+p.color+'22;display:grid;place-items:center;flex-shrink:0">'+
          '<svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="2" y="1" width="12" height="14" rx="1.5" stroke="'+p.color+'" stroke-width="1.4"/><path d="M5 5h6M5 8h6M5 11h3" stroke="'+p.color+'" stroke-width="1.3" stroke-linecap="round"/></svg>'+
        '</div>'+
        '<div style="flex:1;min-width:0">'+
          '<div style="display:flex;align-items:center;gap:0.5em;margin-bottom:0.15em">'+
            '<div class="report-name">'+p.name+'</div>'+
            '<span style="font-size:0.65rem;font-weight:700;letter-spacing:0.05em;text-transform:uppercase;color:'+statusColor+'">'+statusLabel+'</span>'+
          '</div>'+
          '<div class="report-desc">'+
            '$'+fmt(spent)+' spent · '+pct+'% of budget'+(daysStr?' · '+daysStr:'')+
          '</div>'+
        '</div>'+
        '<div style="display:flex;flex-direction:column;align-items:flex-end;gap:0.4em;flex-shrink:0">'+
          '<button class="tb-btn primary" style="font-size:0.75rem;padding:0.3em 0.75em" onclick="event.stopPropagation();exportReport('+i+')">Share</button>'+
        '</div>'+
      '</div>'+
      '<div style="margin-top:0.85em;height:4px;border-radius:2px;background:var(--surface3);overflow:hidden">'+
        '<div style="height:100%;width:'+Math.min(100,pct)+'%;background:'+barColor+';border-radius:2px"></div>'+
      '</div>'+
    '</div>';
  }).join('');
}

function getReportURL(idx) {
  const p   = DB.projects[idx];
  // Only include expenses (not income) for client reports
  const pus = DB.purchases.filter(x=>x.projectIdx===idx && x.type!=='income');
  const data = {
    project: p,
    purchases: pus,
    companyName: DB.companyName || '',
    generatedAt: Date.now(),
  };
  // btoa fails on non-latin chars — use encodeURIComponent safe encoding
  const hash = btoa(unescape(encodeURIComponent(JSON.stringify(data))));
  return window.location.origin + window.location.pathname.replace('dashboard.html','') + 'reports.html#' + hash;
}

function exportReport(idx) {
  const url = getReportURL(idx);
  // Show modal with link
  const modal = document.getElementById('reportLinkModal');
  document.getElementById('reportLinkInput').value = url;
  document.getElementById('reportLinkPreview').href = url;
  modal.classList.add('open');
}

function copyReportLink() {
  const input = document.getElementById('reportLinkInput');
  navigator.clipboard.writeText(input.value).then(() => {
    const btn = document.getElementById('copyLinkBtn');
    btn.textContent = 'Copied!';
    setTimeout(() => { btn.textContent = 'Copy Link'; }, 2000);
  });
}

// ══ ANALYTICS ══
let anMetric    = 'spending';
let anGranularity = 'weekly';
let anPeriod    = '3m';

const AN_METRIC_CFG = {
  spending:     { label:'Spending Over Time',     color:'#e84040', gradStart:'rgba(232,64,64,0.18)',   gradEnd:'rgba(232,64,64,0)',   fmt: v=>'$'+fmtShort(v) },
  revenue:      { label:'Revenue Over Time',      color:'#0da068', gradStart:'rgba(13,160,104,0.18)',  gradEnd:'rgba(13,160,104,0)',  fmt: v=>'$'+fmtShort(v) },
  profit:       { label:'Profit Over Time',       color:'#1a6de8', gradStart:'rgba(26,109,232,0.18)',  gradEnd:'rgba(26,109,232,0)',  fmt: v=>'$'+fmtShort(v) },
  transactions: { label:'Transactions Over Time', color:'#a78bfa', gradStart:'rgba(167,139,250,0.18)', gradEnd:'rgba(167,139,250,0)', fmt: v=>v+' txn' },
};

const AN_GRANULARITY = [
  { id:'daily',   label:'Daily'   },
  { id:'weekly',  label:'Weekly'  },
  { id:'monthly', label:'Monthly' },
];

const AN_PERIODS = [
  { id:'1m',  label:'This Month'    },
  { id:'3m',  label:'3 Months'      },
  { id:'6m',  label:'6 Months'      },
  { id:'1y',  label:'This Year'     },
  { id:'all', label:'All Time'      },
];

function selectMetric(m) {
  anMetric = m;
  document.querySelectorAll('.an-metric-card').forEach(el => el.classList.toggle('active', el.dataset.metric === m));
  renderAnalyticsChart();
}

function selectGranularity(g) {
  anGranularity = g;
  renderAnalyticsChart();
}

function selectPeriod(p) {
  anPeriod = p;
  renderAnalyticsChart();
}

function anPeriodRange() {
  const now = new Date();
  const end = new Date(now); end.setHours(23,59,59,999);
  let start;
  if (anPeriod === '1m') { start = new Date(now.getFullYear(), now.getMonth(), 1); }
  else if (anPeriod === '3m') { start = new Date(now); start.setMonth(start.getMonth()-3); start.setDate(1); }
  else if (anPeriod === '6m') { start = new Date(now); start.setMonth(start.getMonth()-6); start.setDate(1); }
  else if (anPeriod === '1y') { start = new Date(now.getFullYear(), 0, 1); }
  else {
    // All time — find earliest purchase date
    const dates = DB.purchases.map(p=>p.date).filter(Boolean).sort();
    start = dates.length ? new Date(dates[0]+'T00:00:00') : new Date(now.getFullYear(), 0, 1);
  }
  return { start, end };
}

function anBucketKey(date, gran) {
  const d = new Date(date+'T12:00:00');
  if (gran === 'daily')   return d.toISOString().slice(0,10);
  if (gran === 'monthly') return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
  // weekly — ISO week start (Monday)
  const day = d.getDay() || 7;
  const mon = new Date(d); mon.setDate(d.getDate()-day+1);
  return mon.toISOString().slice(0,10);
}

function anBucketLabel(key, gran) {
  if (gran === 'monthly') {
    const [y,m] = key.split('-');
    return new Date(y, m-1, 1).toLocaleDateString('en-US',{month:'short',year:'2-digit'});
  }
  const d = new Date(key+'T12:00:00');
  if (gran === 'daily') return d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
  return 'Wk '+d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
}

function anGetSeriesData() {
  const { start, end } = anPeriodRange();
  const purchases = DB.purchases.filter(p => {
    if (!p.date) return false;
    const d = new Date(p.date+'T12:00:00');
    return d >= start && d <= end;
  });

  const buckets = {};
  purchases.forEach(p => {
    const key = anBucketKey(p.date, anGranularity);
    if (!buckets[key]) buckets[key] = { spending:0, revenue:0, profit:0, transactions:0 };
    const amt = Math.abs(p.amount);
    if (p.type === 'income') { buckets[key].revenue += amt; buckets[key].profit += amt; }
    else { buckets[key].spending += amt; buckets[key].profit -= amt; }
    buckets[key].transactions += 1;
  });

  // Generate all bucket keys in range so there are no gaps
  const keys = [];
  const cur = new Date(start);
  while (cur <= end) {
    keys.push(anBucketKey(cur.toISOString().slice(0,10), anGranularity));
    if (anGranularity === 'daily')   cur.setDate(cur.getDate()+1);
    else if (anGranularity === 'weekly')  cur.setDate(cur.getDate()+7);
    else cur.setMonth(cur.getMonth()+1);
  }
  const uniq = [...new Set(keys)];
  return uniq.map(k => ({ key:k, label:anBucketLabel(k,anGranularity), value: buckets[k]?.[anMetric] || 0 }));
}

function drawChart(points, cfg) {
  const svg = document.getElementById('an-chart-svg');
  const noData = document.getElementById('an-no-data');
  const wrap = document.getElementById('an-chart-wrap');
  if (!svg) return;

  const maxVal = Math.max(...points.map(p=>p.value), 1);
  const hasData = points.some(p=>p.value>0);

  if (!hasData) {
    svg.innerHTML = '';
    noData.style.display = 'flex';
    return;
  }
  noData.style.display = 'none';

  const W = wrap.clientWidth || 700;
  const H = 180;
  const pad = { top:16, right:16, bottom:36, left:0 };
  const cW = W - pad.left - pad.right;
  const cH = H - pad.top - pad.bottom;
  const n  = points.length;

  const x = i => pad.left + (n <= 1 ? cW/2 : (i/(n-1))*cW);
  const y = v => pad.top + cH - (v/maxVal)*cH;

  // Build path
  const pts = points.map((p,i) => [x(i), y(p.value)]);
  const pathD = pts.map((p,i)=>( i===0?'M':'L')+p[0].toFixed(1)+' '+p[1].toFixed(1)).join(' ');
  const areaD = pathD + ' L'+pts[pts.length-1][0].toFixed(1)+' '+(pad.top+cH)+' L'+pts[0][0].toFixed(1)+' '+(pad.top+cH)+' Z';

  const gradId = 'an-grad-'+anMetric;
  svg.innerHTML = `
    <defs>
      <linearGradient id="${gradId}" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="${cfg.gradStart}"/>
        <stop offset="100%" stop-color="${cfg.gradEnd}"/>
      </linearGradient>
    </defs>
    <!-- Grid lines -->
    ${[0,0.25,0.5,0.75,1].map(f=>{
      const yy = (pad.top + cH*(1-f)).toFixed(1);
      const lbl = f===0?'':cfg.fmt(maxVal*f);
      return `<line x1="${pad.left}" y1="${yy}" x2="${W}" y2="${yy}" stroke="rgba(255,255,255,0.05)" stroke-width="1"/>
              <text x="${pad.left}" y="${(parseFloat(yy)-4).toFixed(1)}" fill="rgba(255,255,255,0.2)" font-size="9" font-family="JetBrains Mono,monospace">${lbl}</text>`;
    }).join('')}
    <!-- Area fill -->
    <path d="${areaD}" fill="url(#${gradId})"/>
    <!-- Line -->
    <path d="${pathD}" fill="none" stroke="${cfg.color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <!-- Dots + hit areas -->
    ${pts.map((p,i)=>`
      <circle cx="${p[0].toFixed(1)}" cy="${p[1].toFixed(1)}" r="3" fill="${cfg.color}" opacity="0.9"/>
      <circle cx="${p[0].toFixed(1)}" cy="${p[1].toFixed(1)}" r="14" fill="transparent" class="an-hit"
        data-label="${points[i].label}" data-val="${cfg.fmt(points[i].value)}"
        data-x="${p[0].toFixed(1)}" data-y="${p[1].toFixed(1)}"
        onmouseenter="anShowTooltip(event,this)" onmouseleave="anHideTooltip()"/>
    `).join('')}
    <!-- X axis labels — show ~6 evenly spaced -->
    ${points.filter((_,i)=> n<=8 || i%(Math.ceil(n/6))===0).map((pt,_,arr)=>{
      const idx = points.indexOf(pt);
      const px = x(idx).toFixed(1);
      return `<text x="${px}" y="${(pad.top+cH+20).toFixed(1)}" fill="rgba(255,255,255,0.3)" font-size="9.5" font-family="DM Sans,sans-serif" text-anchor="middle">${pt.label}</text>`;
    }).join('')}
  `;
}

function anShowTooltip(e, el) {
  const tt = document.getElementById('an-tooltip');
  const wrap = document.getElementById('an-chart-wrap');
  if (!tt||!wrap) return;
  document.getElementById('an-tooltip-label').textContent = el.dataset.label;
  document.getElementById('an-tooltip-val').textContent   = el.dataset.val;
  const rect = wrap.getBoundingClientRect();
  const cx = parseFloat(el.dataset.x), cy = parseFloat(el.dataset.y);
  let left = cx + 12, top = cy - 38;
  if (left + 120 > wrap.clientWidth) left = cx - 130;
  if (top < 0) top = cy + 10;
  tt.style.left = left + 'px';
  tt.style.top  = top  + 'px';
  tt.style.display = 'block';
}
function anHideTooltip() {
  const tt = document.getElementById('an-tooltip');
  if (tt) tt.style.display = 'none';
}

function renderAnalyticsChart() {
  const cfg = AN_METRIC_CFG[anMetric];

  // Update chart label and total
  const lbl = document.getElementById('an-chart-label');
  const tot = document.getElementById('an-chart-total');
  if (lbl) lbl.textContent = cfg.label;

  // Render granularity filters
  const gf = document.getElementById('an-granularity-filters');
  if (gf) gf.innerHTML = AN_GRANULARITY.map(g=>
    `<button class="an-filter-pill${anGranularity===g.id?' active':''}" onclick="selectGranularity('${g.id}')">${g.label}</button>`
  ).join('');

  // Render period filters
  const pf = document.getElementById('an-period-filters');
  if (pf) pf.innerHTML = AN_PERIODS.map(p=>
    `<button class="an-filter-pill${anPeriod===p.id?' active':''}" onclick="selectPeriod('${p.id}')">${p.label}</button>`
  ).join('');

  const points = anGetSeriesData();
  const total  = points.reduce((s,p)=>s+p.value,0);
  if (tot) {
    tot.textContent = cfg.fmt(total);
    tot.style.color = anMetric==='profit' && total<0 ? 'var(--red)' : cfg.color;
  }

  drawChart(points, cfg);
}

function renderAnalyticsMetricTotals() {
  const pus = DB.purchases;
  const totalSpend  = pus.filter(p=>p.type!=='income').reduce((s,p)=>s+Math.abs(p.amount),0);
  const totalRev    = pus.filter(p=>p.type==='income').reduce((s,p)=>s+Math.abs(p.amount),0);
  const totalProfit = totalRev - totalSpend;

  const els = {
    'anv-spending':     '$'+fmtShort(totalSpend),
    'anv-revenue':      '$'+fmtShort(totalRev),
    'anv-profit':       (totalProfit<0?'-':'')+'$'+fmtShort(Math.abs(totalProfit)),
    'anv-transactions': pus.length+' total',
  };
  Object.entries(els).forEach(([id,val])=>{
    const el = document.getElementById(id);
    if (el) {
      el.textContent = val;
      if (id==='anv-profit') el.style.color = totalProfit<0?'var(--red)':'';
    }
  });
}

function renderAnalyticsProjectTable() {
  const el = document.getElementById('an-proj-table');
  if (!el) return;
  if (!DB.projects.length) { el.innerHTML='<div style="padding:2em;text-align:center;color:var(--muted);font-size:0.85rem">No projects yet</div>'; return; }

  const rows = DB.projects.map((p,i) => {
    const pus   = DB.purchases.filter(x=>x.projectIdx===i);
    const spent = spentFromPurchases(pus);
    const rem   = (p.budget||0) - spent;
    const pct   = p.budget>0 ? Math.round(spent/p.budget*100) : 0;
    const col   = pct>100?'var(--red)':pct>85?'var(--orange)':'var(--green)';
    const status = getProjectStatus(p);
    const statusLabel = status==='in-progress'?'In Progress':status==='upcoming'?'Upcoming':'Completed';
    const statusCol   = status==='in-progress'?'var(--green)':status==='upcoming'?'var(--blue-l)':'var(--muted)';
    return { p,i,spent,rem,pct,col,statusLabel,statusCol };
  }).sort((a,b)=>b.spent-a.spent);

  el.innerHTML =
    `<div class="an-proj-head">
      <div>Project</div><div style="text-align:right">Budget</div><div style="text-align:right">Spent</div><div style="text-align:right">Status</div><div>Progress</div>
    </div>` +
    rows.map(({p,i,spent,rem,pct,col,statusLabel,statusCol})=>
      `<div class="an-proj-row" style="cursor:pointer" onclick="openProject(${i})">
        <div style="display:flex;align-items:center;gap:0.6em;min-width:0">
          <div style="width:8px;height:8px;border-radius:50%;background:${p.color};flex-shrink:0"></div>
          <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.name}</div>
        </div>
        <div style="text-align:right;color:var(--text2)">$${fmt(p.budget||0)}</div>
        <div style="text-align:right;font-weight:600;color:${col}">$${fmt(spent)}</div>
        <div style="text-align:right;font-size:0.75rem;font-weight:700;color:${statusCol}">${statusLabel}</div>
        <div style="display:flex;align-items:center;gap:0.5em">
          <div style="flex:1;height:5px;border-radius:3px;background:var(--surface2);overflow:hidden">
            <div style="height:100%;width:${Math.min(100,pct)}%;background:${col};border-radius:3px;transition:width 0.6s cubic-bezier(0.16,1,0.3,1)"></div>
          </div>
          <div style="font-size:0.72rem;color:var(--text2);width:2.5em;text-align:right;flex-shrink:0">${pct}%</div>
        </div>
      </div>`
    ).join('');
}

function renderAnalytics() {
  renderAnalyticsMetricTotals();
  renderAnalyticsChart();
  renderAnalyticsProjectTable();
}

// ══ MODALS ══
function openModal(id) {
  if (id === 'newProjModal') resetProjectModal();
  document.getElementById(id).classList.add('open');
  // Wire Enter on category name input after modal is in DOM
  if (id === 'newProjModal') {
    setTimeout(() => {
      const el = document.getElementById('np-cat-name');
      if (el) el.onkeydown = e => { if (e.key === 'Enter') { e.preventDefault(); addCategory(); } };
    }, 0);
  }
}
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// ══ CUSTOM CONFIRM / ALERT ══
let _confirmCallback = null;
function showConfirm(message, onConfirm, title, okLabel, okDanger) {
  document.getElementById('confirmTitle').textContent = title || 'Are you sure?';
  document.getElementById('confirmMessage').textContent = message;
  const btn = document.getElementById('confirmOkBtn');
  btn.textContent = okLabel || 'Confirm';
  btn.style.background = okDanger ? 'var(--red)' : '';
  btn.style.borderColor = okDanger ? 'var(--red)' : '';
  _confirmCallback = onConfirm;
  document.getElementById('confirmModal').classList.add('open');
}
function closeConfirm(result) {
  document.getElementById('confirmModal').classList.remove('open');
  if (result && _confirmCallback) _confirmCallback();
  _confirmCallback = null;
}
function showAlert(message, title) {
  document.getElementById('alertTitle').textContent = title || 'Notice';
  document.getElementById('alertMessage').textContent = message;
  document.getElementById('alertModal').classList.add('open');
}

document.querySelectorAll('.modal-bg').forEach(bg=>bg.addEventListener('click',e=>{if(e.target===bg)bg.classList.remove('open');}));
document.addEventListener('keydown',e=>{if(e.key==='Escape')document.querySelectorAll('.modal-bg.open').forEach(m=>m.classList.remove('open'));});

function pickColor(el) {
  document.querySelectorAll('.dot-color').forEach(d=>d.classList.remove('selected'));
  el.classList.add('selected'); newProjColor=el.dataset.color;
}

// ══ CATEGORY BUILDER STATE ══
let newProjCats = []; // [{name, pct}]  — "All" is implicit, not stored here
let newProjLaborEnabled = true; // Labor Estimate chip toggle
let newProjLaborWorkers = {}; // { uid: hoursPerWeek }
let newProjLaborPct = null; // budget % for labor category

function resetProjectModal() {
  newProjCats = [];
  newProjLaborEnabled = true;
  newProjLaborWorkers = {};
  newProjLaborPct = null;
  // Populate assign workers checkboxes
  const npWorkersList = document.getElementById('np-workers-list');
  const npWorkersField = document.getElementById('np-workers-field');
  if (npWorkersList) {
      renderModalWorkersList();
  }
  ['np-name','np-budget','np-client','np-location','np-start','np-end','np-cat-name','np-cat-pct'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  document.getElementById('np-cat-err').style.display = 'none';
  renderCatChips();
  // Reset color
  document.querySelectorAll('.dot-color').forEach(d => d.classList.remove('selected'));
  document.querySelector('.dot-color[data-color="#3b82f6"]').classList.add('selected');
  newProjColor = '#3b82f6';
}

function toggleLaborChip() {
  newProjLaborEnabled = !newProjLaborEnabled;
  renderModalWorkersList();
  renderCatChips();
}

function setLaborHours(uid, val) {
  newProjLaborWorkers[uid] = parseFloat(val) || 0;
  // Update totals display without re-rendering the whole list (avoids losing focus)
  updateLaborTotals();
}

function updateLaborTotals() {
  const totalEl  = document.getElementById('np-labor-total');
  const weeklyEl = document.getElementById('np-labor-weekly');
  if (!totalEl && !weeklyEl) return;
  const total  = calcModalLaborEstimate();
  const weekly = calcModalLaborWeekly();
  if (totalEl)  totalEl.textContent  = total  > 0 ? '$'+fmt(total)+' total est.'  : '';
  if (weeklyEl) weeklyEl.textContent = weekly > 0 ? '$'+fmt(weekly)+'/wk' : '';
  // Also update labor chip label in cat list
  const chip = document.getElementById('labor-chip');
  if (chip) {
    const badge = chip.querySelector('.cat-chip-pct');
    if (badge) badge.textContent = total > 0 ? '$'+fmt(total)+' est.' : '';
  }
}

function renderModalWorkersList() {
  const npWorkersList  = document.getElementById('np-workers-list');
  const npWorkersField = document.getElementById('np-workers-field');
  if (!npWorkersList) return;
  // Only show workers (not admins)
  const workers = DB.team.filter(m => (m.role||'').toLowerCase() !== 'admin');
  if (!workers.length) { npWorkersField.style.display = 'none'; return; }
  npWorkersField.style.display = '';
  npWorkersList.innerHTML = workers.map(m => {
    const uid  = m.user_id || m._id;
    const name = (m.firstName+' '+m.lastName).trim();
    const rate = m.hourlyRate || 0;
    const hrs  = newProjLaborWorkers[uid] || '';
    const init = ((m.firstName||'?')[0]+(m.lastName||'?')[0]).toUpperCase();
    return '<label style="display:flex;align-items:center;gap:0.75em;padding:0.55em 0.7em;border-radius:0.5em;cursor:pointer;border:1px solid var(--border);background:var(--surface2);margin-bottom:0.3em" onclick="event.stopPropagation();npToggleWorker(this)">' +
      '<input type="checkbox" data-uid="'+uid+'" style="display:none"/>' +
      '<div style="width:32px;height:32px;border-radius:0.4em;background:var(--blue);display:grid;place-items:center;font-size:0.72rem;font-weight:700;color:#fff;flex-shrink:0">'+init+'</div>' +
      '<span style="font-size:0.88rem;font-weight:600;flex:1">'+name+'</span>' +
      (newProjLaborEnabled
        ? '<input type="number" id="labor-hrs-'+uid+'" min="0" step="0.5" placeholder="hrs/wk" value="'+hrs+'" ' +
          'style="width:5em;background:var(--surface);border:1px solid var(--border2);border-radius:0.35em;padding:0.25em 0.45em;font-size:0.78rem;color:var(--text);font-family:DM Sans,sans-serif;outline:none;text-align:center" ' +
          'oninput="setLaborHours(\''+uid+'\',this.value)" onclick="event.stopPropagation()" ' +
          'onfocus="this.style.borderColor=\'var(--blue)\'" onblur="this.style.borderColor=\'var(--border2)\'"/>'
        : '') +
      (rate > 0 && newProjLaborEnabled ? '<span style="font-size:0.7rem;color:var(--muted)">$'+rate+'/hr</span>' : '') +
      '<div class="np-aw-check" style="width:22px;height:22px;border-radius:0.35em;border:2px solid var(--border2);background:transparent;display:grid;place-items:center;flex-shrink:0;transition:all 0.15s"></div>' +
    '</label>';
  }).join('') +
  (newProjLaborEnabled ? '<div style="display:flex;justify-content:space-between;font-size:0.73rem;font-weight:600;color:var(--blue-l);margin-top:0.4em;padding-top:0.35em;border-top:1px solid rgba(26,109,232,0.12)">' +
    '<span id="np-labor-weekly"></span><span id="np-labor-total"></span></div>' : '');
}

function npToggleWorker(label) {
  const cb = label.querySelector('input[type=checkbox]');
  if (!cb) return;
  cb.checked = !cb.checked;
  const checkBox = label.querySelector('.np-aw-check');
  if (cb.checked) {
    label.style.background = 'rgba(26,109,232,0.07)';
    label.style.borderColor = 'rgba(26,109,232,0.3)';
    if (checkBox) { checkBox.style.background = 'var(--blue)'; checkBox.style.borderColor = 'var(--blue)'; checkBox.innerHTML = '<svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M2 6l3 3 5-5" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>'; }
  } else {
    label.style.background = 'var(--surface2)';
    label.style.borderColor = 'var(--border)';
    if (checkBox) { checkBox.style.background = 'transparent'; checkBox.style.borderColor = 'var(--border2)'; checkBox.innerHTML = ''; }
  }
}
function onWorkerCheck() { /* no longer used — npToggleWorker handles it */ }

function calcModalLaborEstimate() {
  const start = document.getElementById('np-start')?.value;
  const end   = document.getElementById('np-end')?.value;
  if (!start || !end) return 0;
  const weeks = Math.max(0, (new Date(end) - new Date(start)) / (7 * 24 * 3600 * 1000));
  return DB.team.reduce((sum, m) => {
    const uid  = m.user_id || m._id;
    const hrs  = newProjLaborWorkers[uid] || 0;
    const rate = m.hourlyRate || 0;
    return sum + hrs * rate * weeks;
  }, 0);
}

function calcModalLaborWeekly() {
  return DB.team.reduce((sum, m) => {
    const uid  = m.user_id || m._id;
    const hrs  = newProjLaborWorkers[uid] || 0;
    const rate = m.hourlyRate || 0;
    return sum + hrs * rate;
  }, 0);
}

function renderModalLaborRows() {
  const assignedUids = Array.from(document.querySelectorAll('#np-workers-list input[type=checkbox]:checked')).map(cb => cb.dataset.uid);
  const workers = DB.team.filter(m => {
    const uid = m.user_id || m._id;
    return assignedUids.length === 0 || assignedUids.includes(uid);
  });
  if (!workers.length) return '<div style="font-size:0.75rem;color:var(--muted);padding:0.3em 0.75em">Assign workers above to configure labor hours.</div>';
  const start = document.getElementById('np-start')?.value;
  const end   = document.getElementById('np-end')?.value;
  const weeks = (start && end) ? Math.max(0, (new Date(end) - new Date(start)) / (7*24*3600*1000)) : 0;
  const weeklyTotal = calcModalLaborWeekly();
  const totalEst    = calcModalLaborEstimate();
  return '<div style="background:rgba(26,109,232,0.04);border:1px solid rgba(26,109,232,0.12);border-radius:0.4em;padding:0.6em 0.75em;margin:0.15em 0 0.1em">' +
    workers.map(m => {
      const uid  = m.user_id || m._id;
      const name = (m.firstName+' '+m.lastName).trim();
      const rate = m.hourlyRate || 0;
      const hrs  = newProjLaborWorkers[uid] || '';
      const cost = (parseFloat(hrs)||0) * rate * weeks;
      return '<div style="display:flex;align-items:center;gap:0.5em;padding:0.25em 0;font-size:0.8rem">' +
        '<span style="flex:1;font-weight:500">' + name + '</span>' +
        '<span style="color:var(--muted);font-size:0.72rem">$' + rate + '/hr</span>' +
        '<input type="number" min="0" step="0.5" placeholder="hrs/wk" value="' + hrs + '" ' +
          'style="width:5em;background:var(--surface);border:1px solid var(--border2);border-radius:0.35em;padding:0.25em 0.4em;font-size:0.78rem;color:var(--text);font-family:DM Sans,sans-serif;outline:none;text-align:center" ' +
          'oninput="setLaborHours(\''+uid+'\',this.value)" onfocus="this.style.borderColor=\'var(--blue)\'" onblur="this.style.borderColor=\'var(--border2)\'"/>' +
        (cost > 0 ? '<span style="font-size:0.72rem;color:var(--blue-l);font-weight:600;min-width:3.5em;text-align:right">$'+fmt(cost)+'</span>' : '<span style="min-width:3.5em"></span>') +
      '</div>';
    }).join('') +
    (weeklyTotal > 0 || totalEst > 0 ? '<div style="border-top:1px solid rgba(26,109,232,0.15);margin-top:0.35em;padding-top:0.35em;display:flex;justify-content:space-between;font-size:0.75rem;font-weight:600;color:var(--blue-l)">' +
      '<span>' + (weeklyTotal > 0 ? '$'+fmt(weeklyTotal)+'/wk' : '') + '</span>' +
      '<span>' + (totalEst > 0 ? '$'+fmt(totalEst)+' total est.' : (!start||!end?'Set dates to see total':'')) + '</span>' +
    '</div>' : '') +
  '</div>';
}

function renderCatChips() {
  const list = document.getElementById('np-cats-list');
  const totalPct = newProjCats.reduce((s,c) => s+(c.pct||0), 0);
  // Calculate labor estimate for display
  const laborTotal = calcModalLaborEstimate();
  const laborWeekly = calcModalLaborWeekly();

  list.innerHTML =
    '<div class="cat-chip cat-chip-all"><span style="font-size:0.8rem;font-weight:600">All</span><span style="font-size:0.72rem;color:var(--muted);margin-left:auto">Tracks total spend</span></div>' +
    // Labor Estimate chip
    '<div class="cat-chip" id="labor-chip" style="border-color:' + (newProjLaborEnabled ? 'rgba(26,109,232,0.35)' : 'var(--border)') + ';background:' + (newProjLaborEnabled ? 'rgba(26,109,232,0.07)' : 'var(--surface2)') + ';cursor:pointer" onclick="toggleLaborChip()">' +
      '<span style="font-size:0.8rem;font-weight:600;color:' + (newProjLaborEnabled ? 'var(--blue-l)' : 'var(--muted)') + '">Labor Estimate</span>' +
      (newProjLaborEnabled && laborTotal > 0 ? '<span class="cat-chip-pct" style="margin-left:0.4em">$' + fmt(laborTotal) + ' est.</span>' : '') +
      (newProjLaborEnabled ? ' <span style="margin-left:0.5em;font-size:0.7rem;color:var(--muted)" onclick="event.stopPropagation()"><input type="number" id="np-labor-pct" min="1" max="100" placeholder="%" value="' + (newProjLaborPct||'') + '" style="width:2.8em;background:var(--surface);border:1px solid var(--border2);border-radius:0.3em;padding:0.12em 0.3em;font-size:0.72rem;color:var(--text);font-family:DM Sans,sans-serif;outline:none;text-align:center" oninput="newProjLaborPct=parseInt(this.value)||null" onclick="event.stopPropagation()" onfocus="this.style.borderColor=\'var(--blue)\'" onblur="this.style.borderColor=\'var(--border2)\'"/>%</span>' : '') +
      '<span style="margin-left:auto;font-size:0.7rem;color:' + (newProjLaborEnabled ? 'var(--blue-l)' : 'var(--muted)') + '">' + (newProjLaborEnabled ? '✓ on' : 'off') + '</span>' +
    '</div>' +

    newProjCats.map((c,i) =>
      '<div class="cat-chip">' +
        '<span class="cat-chip-name">' + c.name + '</span>' +
        (c.pct ? '<span class="cat-chip-pct">' + c.pct + '%</span>' : '') +
        '<button class="cat-chip-del" onclick="removeCat(' + i + ')" title="Remove">✕</button>' +
      '</div>'
    ).join('') +
    (newProjCats.length && totalPct > 0 ? '<div style="font-size:0.72rem;color:var(--muted);padding:0.2em 0.1em">' + totalPct + '% of budget allocated across categories</div>' : '');
}

function addCategory() {
  const nameEl = document.getElementById('np-cat-name');
  const pctEl  = document.getElementById('np-cat-pct');
  const errEl  = document.getElementById('np-cat-err');
  const name   = nameEl.value.trim();
  const pct    = pctEl.value ? parseInt(pctEl.value) : null;

  errEl.style.display = 'none';

  if (!name) { nameEl.focus(); return; }
  if (name.toLowerCase() === 'all') { errEl.textContent = '"All" is a built-in category.'; errEl.style.display='block'; return; }
  if (newProjCats.find(c => c.name.toLowerCase() === name.toLowerCase())) {
    errEl.textContent = 'That category already exists.'; errEl.style.display='block'; return;
  }
  if (pct !== null && (pct < 1 || pct > 100)) {
    errEl.textContent = 'Percentage must be between 1 and 100.'; errEl.style.display='block'; return;
  }
  const totalPct = newProjCats.reduce((s,c) => s+(c.pct||0), 0);
  if (pct && totalPct + pct > 100) {
    errEl.textContent = 'Total allocated budget would exceed 100%. Currently at ' + totalPct + '%.'; errEl.style.display='block'; return;
  }

  newProjCats.push({ name, pct: pct || null });
  nameEl.value = '';
  pctEl.value  = '';
  nameEl.focus();
  renderCatChips();
}

function removeCat(idx) {
  newProjCats.splice(idx, 1);
  renderCatChips();
}

// ══ SAVE NEW PROJECT ══
function saveNewProject() {
  const name = document.getElementById('np-name').value.trim();
  if (!name) { document.getElementById('np-name').focus(); return; }

  const client   = document.getElementById('np-client').value.trim();
  const location = document.getElementById('np-location').value.trim();
  const clientStr = [client, location].filter(Boolean).join(' · ');

  const assignedWorkers = Array.from(
    document.querySelectorAll('#np-workers-list input[type=checkbox]:checked')
  ).map(cb => cb.dataset.uid);

  const proj = {
    name,
    budget:          parseFloat(document.getElementById('np-budget').value) || 0,
    client:          clientStr,
    clientName:      client,
    location:        location,
    startDate:       document.getElementById('np-start').value,
    endDate:         document.getElementById('np-end').value,
    color:           newProjColor,
    categories:      ['Labor Estimate', ...newProjCats.map(c => c.name)].filter((_,i) => i===0 ? newProjLaborEnabled : true),
    catBudgets:      { ...(newProjLaborEnabled && newProjLaborPct ? {'Labor Estimate': newProjLaborPct} : {}), ...Object.fromEntries(newProjCats.filter(c=>c.pct).map(c=>[c.name, c.pct])) },
    laborEnabled:    newProjLaborEnabled,
    laborWorkers:    newProjLaborEnabled ? {...newProjLaborWorkers} : {},
    assignedWorkers: assignedWorkers,
  };
  DB.projects.push(proj);
  const idx = DB.projects.length - 1;
  closeModal('newProjModal');
  resetProjectModal();
  renderAll();
  pushNotif('project_create', 'New project created', 'Project "'+proj.name+'"'+(proj.clientName?' for '+proj.clientName:'')+' was created.', {projectIdx:idx});
  // Await so _id is set before any purchase saves reference this project
  sbSaveProject(proj, idx).then(() => {
    if (proj.laborEnabled) upsertLaborTransaction(idx);
  }).catch(e => { console.error('Project save failed:', e); showToast('Failed to save project'); });
}

// ══ ASSIGN WORKERS ══
let assignWorkersProjectIdx = null;
function openAssignWorkersModal(idx) {
  assignWorkersProjectIdx = idx;
  const proj = DB.projects[idx];
  const assigned = proj.assignedWorkers || [];
  const list = document.getElementById('aw-list');
  const workers = DB.team.filter(m => (m.role||'').toLowerCase() !== 'admin');
  if (!workers.length) {
    list.innerHTML = '<div style="font-size:0.82rem;color:var(--muted)">No workers yet. Add workers from the Team tab.</div>';
  } else {
    list.innerHTML = workers.map(m => {
      const uid     = m.user_id || m._id;
      const name    = (m.firstName+' '+m.lastName).trim();
      const isChecked = assigned.includes(uid);
      const initials  = ((m.firstName||'?')[0]+(m.lastName||'?')[0]).toUpperCase();
      return '<label style="display:flex;align-items:center;gap:0.85em;padding:0.65em 0.75em;border-radius:0.55em;cursor:pointer;transition:background 0.12s;border:1px solid '+(isChecked?'rgba(26,109,232,0.3)':'var(--border)')+';background:'+(isChecked?'rgba(26,109,232,0.07)':'var(--surface2)')+'" onmouseover="if(!this.querySelector(\'input\').checked)this.style.background=\'var(--surface3)\'" onmouseout="if(!this.querySelector(\'input\').checked)this.style.background=\'var(--surface2)\';else this.style.background=\'rgba(26,109,232,0.07)\';this.style.borderColor=this.querySelector(\'input\').checked?\'rgba(26,109,232,0.3)\':\'var(--border)\'">' +
        '<input type="checkbox" data-uid="'+uid+'" '+(isChecked?'checked':'')+' style="display:none" onchange="updateAWRow(this)"/>' +
        '<div style="width:36px;height:36px;border-radius:0.45em;background:var(--blue);display:grid;place-items:center;font-size:0.78rem;font-weight:700;color:#fff;flex-shrink:0">'+initials+'</div>' +
        '<span style="font-size:0.92rem;font-weight:600;flex:1">'+name+'</span>' +
        '<div style="width:22px;height:22px;border-radius:0.35em;border:2px solid '+(isChecked?'var(--blue)':'var(--border2)')+';background:'+(isChecked?'var(--blue)':'transparent')+';display:grid;place-items:center;flex-shrink:0;transition:all 0.15s">'+(isChecked?'<svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M2 6l3 3 5-5" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>':'')+'</div>' +
      '</label>';
    }).join('');
  }
  openModal('assignWorkersModal');
}
function updateAWRow(cb) {
  const label = cb.closest('label');
  if (!label) return;
  if (cb.checked) {
    label.style.background = 'rgba(26,109,232,0.07)';
    label.style.borderColor = 'rgba(26,109,232,0.3)';
    const box = label.querySelector('div:last-child');
    if (box) { box.style.background = 'var(--blue)'; box.style.borderColor = 'var(--blue)'; box.innerHTML = '<svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M2 6l3 3 5-5" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>'; }
  } else {
    label.style.background = 'var(--surface2)';
    label.style.borderColor = 'var(--border)';
    const box = label.querySelector('div:last-child');
    if (box) { box.style.background = 'transparent'; box.style.borderColor = 'var(--border2)'; box.innerHTML = ''; }
  }
}

function saveAssignWorkers() {
  const idx = assignWorkersProjectIdx;
  if (idx === null) return;
  const workers = Array.from(document.querySelectorAll('#aw-list input[type=checkbox]:checked'))
    .map(cb => cb.dataset.uid);
  const prevWorkers = DB.projects[idx].assignedWorkers || [];
  const newlyAdded  = workers.filter(uid => !prevWorkers.includes(uid));
  DB.projects[idx].assignedWorkers = workers;
  closeModal('assignWorkersModal');
  renderProjectDetail(idx);
  renderSidebar();
  sbSaveProject(DB.projects[idx], idx).catch(console.error);
  if (newlyAdded.length) {
    const proj = DB.projects[idx];
    const names = newlyAdded.map(uid => { const m = DB.team.find(t=>t.user_id===uid); return m?(m.firstName+' '+m.lastName).trim():'Worker'; });
    pushNotif('assigned', names.join(', ')+' assigned to '+proj.name, names.length===1?names[0]+' can now see and log transactions on this project.':''+names.length+' workers added to this project.', {projectIdx:idx});
  }
}

// ══ QUICK ADD PURCHASE (from project detail) ══
// ── Transaction type toggle ──
let txType = { qpu: 'expense', pu: 'expense', pd: 'expense' };
function setTxType(prefix, type) {
  txType[prefix] = type;
  const expBtn = document.getElementById(prefix+'-btn-expense');
  const incBtn = document.getElementById(prefix+'-btn-income');
  if (expBtn) { expBtn.className = type === 'expense' ? 'active-expense' : ''; }
  if (incBtn) { incBtn.className = type === 'income'  ? 'active-income'  : ''; }
  // Lock category to Revenue for income; restore select for expense
  const catMap = { qpu: 'qpu-category', pu: 'pu-category', pd: 'pd-edit-category' };
  const catEl = document.getElementById(catMap[prefix]);
  if (catEl) {
    if (type === 'income') {
      catEl.innerHTML = ['Deposit','Progress Payment','Final Payment','Change Order Payment'].map(c=>'<option>'+c+'</option>').join('');
      catEl.disabled = false;
      catEl.style.opacity = '';
    } else {
      catEl.disabled = false;
      catEl.style.opacity = '';
      // Re-trigger the normal category population
      if (prefix === 'qpu' && typeof activeProject !== 'undefined' && activeProject !== null) {
        const cats = (DB.projects[activeProject] && DB.projects[activeProject].categories) || [];
        catEl.innerHTML = (cats.length ? cats : ['General']).map(c=>'<option>'+c+'</option>').join('');
      } else if (prefix === 'pu') {
        updatePurchaseCats();
      }
    }
  }
}
function resetTxType(prefix) { setTxType(prefix, 'expense'); }

function openQuickPurchase() {
  if (activeProject === null) return;
  const p    = DB.projects[activeProject];
  const cats = p.categories || [];
  document.getElementById('qpu-proj-label').textContent = p.name + ' · ' + new Date().toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
  document.getElementById('qpu-category').innerHTML = (cats.length ? cats : ['General']).filter(c=>c!=='Labor Estimate').map(c=>'<option>'+c+'</option>').join('');
  document.getElementById('qpu-vendor').value  = '';
  document.getElementById('qpu-amount').value  = '';
  document.getElementById('qpu-notes').value   = '';
  resetTxType('qpu');
  openModal('quickPurchaseModal');
  setTimeout(() => document.getElementById('qpu-vendor').focus(), 80);
}
function saveQuickPurchase() {
  const vendor = document.getElementById('qpu-vendor').value.trim();
  const amount = parseFloat(document.getElementById('qpu-amount').value);
  if (!vendor || isNaN(amount) || amount <= 0) { document.getElementById(!vendor?'qpu-vendor':'qpu-amount').focus(); return; }
  const me = ((DB.firstName||'')+' '+(DB.lastName||'')).trim() || 'Admin';
  const pu = {
    vendor, amount: Math.abs(amount),
    type: txType['qpu'],
    projectIdx: activeProject,
    category:   document.getElementById('qpu-category').value,
    date:       new Date().toISOString().split('T')[0],
    worker:     me,
    notes:      document.getElementById('qpu-notes').value.trim(),
    ts:         Date.now()
  };
  DB.purchases.push(pu);
  const puIdx = DB.purchases.length - 1;
  closeModal('quickPurchaseModal');
  renderAll();
  renderProjectDetail(activeProject);
  sbSavePurchase(pu, puIdx).catch(console.error);
  const qpProj = DB.projects[activeProject];
  pushNotif('transaction', (pu.type==='income'?'Income':'Expense')+' logged on '+(qpProj?.name||'project'), '$'+fmt(pu.amount)+' at '+pu.vendor+(pu.category?' · '+pu.category:''), {projectIdx:activeProject});
}

// ══ FULL ADD PURCHASE (from other views) ══
function openAddPurchase() {
  if (!DB.projects.length) { showAlert('Create a project first, then you can add transactions to it.', 'No Projects Yet'); return; }
  const ps = document.getElementById('pu-project');
  ps.innerHTML = DB.projects.map((p,i)=>'<option value="'+i+'">'+p.name+'</option>').join('');
  if (activeProject!==null) ps.value = activeProject;
  updatePurchaseCats();
  const ws = document.getElementById('pu-worker');
  ws.innerHTML = '<option>'+(DB.firstName||'')+' '+(DB.lastName||'')+' (you)</option>'+DB.team.map(m=>'<option>'+m.firstName+' '+m.lastName+'</option>').join('');
  document.getElementById('pu-date').value = new Date().toISOString().split('T')[0];
  resetTxType('pu');
  openModal('newPurchaseModal');
}
function updatePurchaseCats() {
  const idx  = parseInt(document.getElementById('pu-project').value);
  const cats = (DB.projects[idx]&&DB.projects[idx].categories)||[];
  document.getElementById('pu-category').innerHTML = (cats.length?cats:['General']).filter(c=>c!=='Labor Estimate').map(c=>'<option>'+c+'</option>').join('');
}
function saveNewPurchase() {
  const vendor = document.getElementById('pu-vendor').value.trim();
  const amount = parseFloat(document.getElementById('pu-amount').value);
  if (!vendor||isNaN(amount)||amount<=0) { document.getElementById(!vendor?'pu-vendor':'pu-amount').focus(); return; }
  const pu2 = { vendor, amount: Math.abs(amount), type: txType['pu'], projectIdx:parseInt(document.getElementById('pu-project').value), category:document.getElementById('pu-category').value, date:document.getElementById('pu-date').value, worker:document.getElementById('pu-worker').value, notes:document.getElementById('pu-notes').value.trim(), ts:Date.now() };
  DB.purchases.push(pu2);
  const pu2Idx = DB.purchases.length - 1;
  ['pu-vendor','pu-amount','pu-notes'].forEach(id=>document.getElementById(id).value='');
  closeModal('newPurchaseModal');
  renderAll();
  if (activeView==='project'&&activeProject!==null) renderProjectDetail(activeProject);
  sbSavePurchase(pu2, pu2Idx).catch(console.error);
  const npProj = DB.projects[pu2.projectIdx];
  pushNotif('transaction', (pu2.type==='income'?'Income':'Expense')+' logged on '+(npProj?.name||'project'), '$'+fmt(pu2.amount)+' at '+pu2.vendor+(pu2.category?' · '+pu2.category:''), {projectIdx:pu2.projectIdx});
}

// ══ PURCHASE DETAIL / EDIT ══
let activePurchaseIdx = null;

function openPurchaseDetail(globalIdx) {
  activePurchaseIdx = globalIdx;
  const pu = DB.purchases[globalIdx];
  const pdType = pu.type || 'expense';
  const pdAmtEl = document.getElementById('pd-amount');
  pdAmtEl.textContent = (pdType === 'income' ? '+' : '-') + '$' + fmt(Math.abs(pu.amount));
  pdAmtEl.style.color = pdType === 'income' ? '#22c55e' : 'var(--red)';
  document.getElementById('pd-category').textContent = pu.category||'—';
  document.getElementById('pd-vendor').textContent   = pu.vendor;
  document.getElementById('pd-date').textContent     = fmtDate(pu.date);
  document.getElementById('pd-worker').textContent   = pu.worker||'—';
  const notesRow = document.getElementById('pd-notes-row');
  if (pu.notes) {
    notesRow.style.display = 'flex';
    document.getElementById('pd-notes').textContent = pu.notes;
  } else {
    notesRow.style.display = 'none';
  }
  document.getElementById('pd-view').style.display = 'block';
  document.getElementById('pd-edit').style.display = 'none';
  openModal('purchaseDetailModal');
}

function switchToEditMode() {
  const pu   = DB.purchases[activePurchaseIdx];
  const proj = DB.projects[pu.projectIdx];
  const cats = (proj && proj.categories) || [];
  document.getElementById('pd-edit-vendor').value  = pu.vendor;
  document.getElementById('pd-edit-amount').value  = pu.amount;
  document.getElementById('pd-edit-date').value    = pu.date||'';
  document.getElementById('pd-edit-worker').value  = pu.worker||'';
  document.getElementById('pd-edit-notes').value   = pu.notes||'';
  document.getElementById('pd-edit-category').innerHTML = (cats.length?cats:['General']).filter(c=>c!=='Labor Estimate').map(c=>'<option'+(c===pu.category?' selected':'')+'>'+c+'</option>').join('');
  document.getElementById('pd-view').style.display = 'none';
  document.getElementById('pd-edit').style.display = 'block';
}

function switchToViewMode() {
  document.getElementById('pd-view').style.display = 'block';
  document.getElementById('pd-edit').style.display = 'none';
}

function savePurchaseEdit() {
  const vendor = document.getElementById('pd-edit-vendor').value.trim();
  const amount = parseFloat(document.getElementById('pd-edit-amount').value);
  if (!vendor||isNaN(amount)||amount<=0) return;
  const pu = DB.purchases[activePurchaseIdx];
  pu.vendor   = vendor;
  pu.amount   = amount;
  pu.category = document.getElementById('pd-edit-category').value;
  pu.date     = document.getElementById('pd-edit-date').value;
  pu.worker   = document.getElementById('pd-edit-worker').value.trim();
  pu.notes    = document.getElementById('pd-edit-notes').value.trim();
  sbSavePurchase(pu, activePurchaseIdx).catch(console.error);
  closeModal('purchaseDetailModal');
  renderAll();
  if (activeView==='project'&&activeProject!==null) renderProjectDetail(activeProject);
}

function deletePurchaseFromDetail() {
  showConfirm('This transaction will be permanently deleted.', () => {
    const _pu = DB.purchases[activePurchaseIdx];
    sbDeletePurchase(_pu).catch(console.error);
    DB.purchases.splice(activePurchaseIdx, 1);
    closeModal('purchaseDetailModal');
    renderAll();
    if (activeView==='project'&&activeProject!==null) renderProjectDetail(activeProject);
  }, 'Delete Transaction?', 'Delete', true);
}

// ══ EDIT PROJECT FIELDS ══
let editFieldKey    = null;
let editFieldType   = 'text';

const FIELD_CONFIG = {
  name:       { title:'Project Name',   label:'Name',       type:'text'   },
  budget:     { title:'Total Budget',   label:'Budget ($)', type:'number' },
  clientName: { title:'Client Name',    label:'Client',     type:'text'   },
  location:   { title:'Location',       label:'Location',   type:'text'   },
  startDate:  { title:'Start Date',     label:'Start date', type:'date'   },
  endDate:    { title:'End Date',       label:'End date',   type:'date'   },
};

function editProjectField(key) {
  if (activeProject === null) return;
  const cfg = FIELD_CONFIG[key];
  if (!cfg) return;
  const p   = DB.projects[activeProject];
  editFieldKey  = key;
  editFieldType = cfg.type;

  document.getElementById('ef-title').textContent = cfg.title;
  document.getElementById('ef-label').textContent = cfg.label;

  // Hide all inputs, show correct one
  ['ef-input-text','ef-input-number','ef-input-date'].forEach(id => document.getElementById(id).style.display='none');
  const inputId = 'ef-input-'+(cfg.type==='number'?'number':cfg.type==='date'?'date':'text');
  const input   = document.getElementById(inputId);
  input.style.display = '';
  input.value = p[key] !== undefined ? p[key] : '';

  openModal('editFieldModal');
  setTimeout(() => input.focus(), 80);
}

function saveFieldEdit() {
  if (activeProject === null || !editFieldKey) return;
  const p     = DB.projects[activeProject];
  const inputId = 'ef-input-'+(editFieldType==='number'?'number':editFieldType==='date'?'date':'text');
  const raw   = document.getElementById(inputId).value;
  const val   = editFieldType === 'number' ? (parseFloat(raw)||0) : raw.trim();
  p[editFieldKey] = val;
  // Keep combined client string in sync
  if (editFieldKey === 'clientName' || editFieldKey === 'location') {
    p.client = [p.clientName||'', p.location||''].filter(Boolean).join(' · ');
  }
  sbSaveProject(p, activeProject).catch(console.error);
  closeModal('editFieldModal');
  renderProjectDetail(activeProject);
  renderSidebar();
  renderDashboard();
}

// ══ EDIT CATEGORIES (existing project) ══
let editCatsList = [];

function openEditCats() {
  if (activeProject === null) return;
  const p  = DB.projects[activeProject];
  editCatsList = (p.categories||[]).map(name => ({
    name,
    pct: p.catBudgets && p.catBudgets[name] ? p.catBudgets[name] : null
  }));
  document.getElementById('ec-cat-name').value = '';
  document.getElementById('ec-cat-pct').value  = '';
  document.getElementById('ec-err').style.display = 'none';
  renderEcChips();
  openModal('editCatsModal');
  setTimeout(() => {
    const el = document.getElementById('ec-cat-name');
    if (el) el.onkeydown = e => { if (e.key==='Enter') { e.preventDefault(); ecAddCategory(); } };
  }, 0);
}

function renderEcChips() {
  const list = document.getElementById('ec-chips-list');
  list.innerHTML =
    '<div class="cat-chip cat-chip-all"><span style="font-size:0.8rem;font-weight:600">All</span><span style="font-size:0.72rem;color:var(--muted);margin-left:auto">Tracks total spend</span></div>' +
    editCatsList.map((c,i) =>
      '<div class="cat-chip">'+
        '<span class="cat-chip-name">'+c.name+'</span>'+
        (c.pct?'<span class="cat-chip-pct">'+c.pct+'%</span>':'')+
        '<button class="cat-chip-del" onclick="ecRemoveCat('+i+')" title="Remove">✕</button>'+
      '</div>'
    ).join('');
}

function ecAddCategory() {
  const nameEl = document.getElementById('ec-cat-name');
  const pctEl  = document.getElementById('ec-cat-pct');
  const errEl  = document.getElementById('ec-err');
  const name   = nameEl.value.trim();
  const pct    = pctEl.value ? parseInt(pctEl.value) : null;
  errEl.style.display = 'none';
  if (!name) { nameEl.focus(); return; }
  if (name.toLowerCase()==='all') { errEl.textContent='"All" is built-in.'; errEl.style.display='block'; return; }
  if (editCatsList.find(c=>c.name.toLowerCase()===name.toLowerCase())) { errEl.textContent='Already exists.'; errEl.style.display='block'; return; }
  if (pct && (pct<1||pct>100)) { errEl.textContent='Percentage must be 1–100.'; errEl.style.display='block'; return; }
  const total = editCatsList.reduce((s,c)=>s+(c.pct||0),0);
  if (pct && total+pct>100) { errEl.textContent='Total would exceed 100% (currently '+total+'%).'; errEl.style.display='block'; return; }
  editCatsList.push({name, pct:pct||null});
  nameEl.value=''; pctEl.value=''; nameEl.focus();
  renderEcChips();
}

function ecRemoveCat(i) {
  editCatsList.splice(i,1);
  renderEcChips();
}

function saveEditedCats() {
  if (activeProject === null) return;
  const p = DB.projects[activeProject];
  p.categories = editCatsList.map(c=>c.name);
  p.catBudgets = {};
  editCatsList.filter(c=>c.pct).forEach(c => { p.catBudgets[c.name]=c.pct; });
  sbSaveProject(p, activeProject).catch(console.error);
  closeModal('editCatsModal');
  renderProjectDetail(activeProject);
}



// ══ ADD MEMBER ══
function saveNewMember() {
  const first = document.getElementById('tm-first').value.trim();
  const last  = document.getElementById('tm-last').value.trim();
  if (!first||!last) { document.getElementById('tm-first').focus(); return; }
  const nm = { firstName:first, lastName:last, email:document.getElementById('tm-email').value.trim(), role:document.getElementById('tm-role').value };
  DB.team.push(nm);
  const nmIdx = DB.team.length - 1;
  ['tm-first','tm-last','tm-email'].forEach(id=>document.getElementById(id).value='');
  closeModal('newMemberModal'); renderTeam();
  sbSaveTeamMember(nm, nmIdx).catch(console.error);
  pushNotif('member_join', (nm.firstName+' '+nm.lastName).trim()+' added to team', nm.email?nm.email+' joined as '+nm.role+'.':nm.role+' added to your team.', {});
}

// ══ DELETE ══
function deletePurchase(idx) {
  showConfirm('This transaction will be permanently deleted.', () => { const _dp=DB.purchases[idx]; sbDeletePurchase(_dp).catch(console.error); DB.purchases.splice(idx,1); renderAll(); if (activeView==='project'&&activeProject!==null) renderProjectDetail(activeProject); }, 'Delete Transaction?', 'Delete', true); return;
}
function deleteMember(idx) {
  showConfirm('This member will be removed from your team.', () => { const _dm=DB.team[idx]; sbDeleteTeamMember(_dm).catch(console.error); DB.team.splice(idx,1); renderTeam(); }, 'Remove Member?', 'Remove', true); return;
}
function deleteCurrentProject() {
  showConfirm('"'+DB.projects[activeProject].name+'" and all its purchases will be permanently deleted.', () => {
    const idx = activeProject;
    const _dp = DB.projects[idx];
    sbDeleteProject(_dp).catch(console.error);
    DB.purchases = DB.purchases.filter(p=>p.projectIdx!==idx).map(p=>Object.assign({},p,{projectIdx:p.projectIdx>idx?p.projectIdx-1:p.projectIdx}));
    DB.projects.splice(idx,1);
    activeProject=null; showView('dashboard'); renderAll();
  }, 'Delete Project?', 'Delete', true);
}

// ══ SIGN OUT ══
// ══ PROFILE MODAL ══
let _profileAvatarMode = 'initials';
let _profileAvatarColor = '';
let _profileAvatarImageData = null;

function openProfileModal() {
  const session = getSession();
  _profileAvatarColor = DB.avatarColor || '#1a6de8';
  _profileAvatarImageData = DB.avatarImage || null;
  _profileAvatarMode = _profileAvatarImageData ? 'image' : 'initials';

  document.getElementById('profileFirstName').value = DB.firstName || '';
  document.getElementById('profileLastName').value  = DB.lastName  || '';
  document.getElementById('profileEmail').value     = session?.user?.email || '';
  document.getElementById('profileJobTitle').value  = DB.jobTitle  || '';
  document.getElementById('profilePhone').value     = DB.phone     || '';

  setAvatarMode(_profileAvatarMode);
  updateProfileAvatarPreview();
  openModal('profileModal');
}

function setAvatarMode(mode) {
  _profileAvatarMode = mode;
  const colorRow = document.getElementById('avatarColorRow');
  const imageRow = document.getElementById('avatarImageRow');
  colorRow.style.display = (mode === 'image') ? 'none' : 'block';
  imageRow.style.display = (mode === 'image') ? 'block' : 'none';
  ['Initials','Color','Image'].forEach(m => {
    const btn = document.getElementById('avatarMode'+m);
    if (btn) btn.style.background = (mode === m.toLowerCase()) ? 'var(--blue)' : '';
    if (btn) btn.style.color      = (mode === m.toLowerCase()) ? '#fff' : '';
    if (btn) btn.style.borderColor= (mode === m.toLowerCase()) ? 'var(--blue)' : '';
  });
  updateProfileAvatarPreview();
}

function selectAvatarColor(color) {
  _profileAvatarColor = color;
  document.querySelectorAll('.avatar-color-swatch').forEach(s => {
    s.style.borderColor = (s.style.background === color || s.style.backgroundColor === color) ? '#fff' : 'transparent';
  });
  updateProfileAvatarPreview();
}

function previewAvatarImage(input) {
  if (!input.files || !input.files[0]) return;
  const reader = new FileReader();
  reader.onload = e => {
    _profileAvatarImageData = e.target.result;
    updateProfileAvatarPreview();
  };
  reader.readAsDataURL(input.files[0]);
}

function updateProfileAvatarPreview() {
  const el = document.getElementById('profileAvatarPreview');
  if (!el) return;
  const first = document.getElementById('profileFirstName')?.value || DB.firstName || '?';
  const last  = document.getElementById('profileLastName')?.value  || DB.lastName  || '?';
  const init  = (first[0] + last[0]).toUpperCase();

  if (_profileAvatarMode === 'image' && _profileAvatarImageData) {
    el.innerHTML = `<img src="${_profileAvatarImageData}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
    el.style.background = 'none';
  } else if (_profileAvatarMode === 'color') {
    el.innerHTML = '';
    el.style.background = _profileAvatarColor || '#1a6de8';
  } else {
    el.textContent = init;
    el.style.background = _profileAvatarColor || '#1a6de8';
  }
}

async function saveProfile() {
  const btn   = document.getElementById('profileSaveBtn');
  const first = document.getElementById('profileFirstName').value.trim();
  const last  = document.getElementById('profileLastName').value.trim();
  const title = document.getElementById('profileJobTitle').value.trim();
  const phone = document.getElementById('profilePhone').value.trim();
  if (!first) { showToast('First name is required'); return; }

  btn.textContent = 'Saving…'; btn.disabled = true;
  try {
    const avatarImage = (_profileAvatarMode === 'image' ? _profileAvatarImageData : null);

    // Persist to Supabase user metadata
    const session = getSession();
    if (!session?.access_token) { showToast('Not signed in'); return; }

    const newMeta = {
      first_name:   first,
      last_name:    last,
      job_title:    title,
      phone:        phone,
      avatar_color: _profileAvatarColor,
      avatar_image: avatarImage
    };

    // Refresh token if needed before making the authenticated request
    const freshSession = await refreshSessionIfNeeded();
    if (!freshSession?.access_token) { showToast('Session expired — please sign in again'); return; }

    const res = await fetch(SB_URL + '/auth/v1/user', {
      method: 'PUT',
      headers: { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + freshSession.access_token, 'Content-Type': 'application/json' },
      body: JSON.stringify({ data: newMeta })
    });
    if (!res.ok) {
      const errBody = await res.json().catch(() => ({}));
      throw new Error(errBody.message || ('HTTP ' + res.status));
    }

    // Update the cached session in localStorage so reload reads fresh data
    const updatedSession = JSON.parse(JSON.stringify(freshSession));
    if (!updatedSession.user) updatedSession.user = {};
    updatedSession.user.user_metadata = { ...(updatedSession.user.user_metadata || {}), ...newMeta };
    setSession(updatedSession);

    // Also patch team_members row so the name shows correctly on admin's team tab
    // (works for both workers and admins who are listed in team_members)
    const uid = freshSession.user?.id;
    if (uid) {
      // team_members rows have a user_id column linking to auth.users
      await fetch(SB_URL + '/rest/v1/team_members?user_id=eq.' + uid, {
        method: 'PATCH',
        headers: {
          'apikey': SB_KEY,
          'Authorization': 'Bearer ' + freshSession.access_token,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify({ first_name: first, last_name: last })
      }).catch(() => {}); // non-fatal — not all users have a team_members row yet
    }

    // Update in-memory DB
    DB.firstName   = first;
    DB.lastName    = last;
    DB.jobTitle    = title;
    DB.phone       = phone;
    DB.avatarColor = _profileAvatarColor;
    DB.avatarImage = avatarImage;
    // Also update the matching entry in DB.team so the team tab reflects immediately
    if (uid) {
      const myTeamEntry = DB.team.find(m => m.user_id === uid);
      if (myTeamEntry) { myTeamEntry.firstName = first; myTeamEntry.lastName = last; }
    }

    // Update sidebar avatar + name live
    const initials = (first[0] + (last[0]||'')).toUpperCase();
    const avatarEl = document.getElementById('userAvatar');
    if (DB.avatarImage) {
      avatarEl.innerHTML = `<img src="${DB.avatarImage}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
      avatarEl.style.background = 'none';
    } else {
      avatarEl.textContent = initials;
      avatarEl.style.background = DB.avatarColor || '#1a6de8';
    }
    document.getElementById('userName').textContent = (first + ' ' + last).trim();
    renderTeam();
    closeModal('profileModal');
    showToast('Profile saved');
  } catch(e) {
    showToast('Save failed — ' + e.message);
  } finally {
    btn.textContent = 'Save Changes'; btn.disabled = false;
  }
}

// ══ MEMBER DETAIL MODAL ══
function openMemberDetail(teamIdx) {
  const m = DB.team[teamIdx];
  if (!m) return;
  const col   = AVATAR_COLORS[teamIdx % AVATAR_COLORS.length];
  const init  = ((m.firstName||'?')[0]+(m.lastName||'?')[0]).toUpperCase();
  const spend = spentFromPurchases(DB.purchases.filter(p=>p.worker&&p.worker.startsWith(m.firstName)));
  const buys  = DB.purchases.filter(p=>p.worker&&p.worker.startsWith(m.firstName));
  const projSet = new Set(buys.map(p=>p.projectIdx));
  const role  = (m.role||'worker').toLowerCase();

  const avatarEl = document.getElementById('mdAvatar');
  avatarEl.textContent = init;
  avatarEl.style.background = col;

  document.getElementById('mdName').textContent = m.firstName + ' ' + m.lastName;
  document.getElementById('mdRoleTag').innerHTML = role === 'admin'
    ? `<span style="padding:0.2em 0.6em;border-radius:0.3em;font-size:0.67rem;font-weight:700;letter-spacing:0.05em;text-transform:uppercase;background:rgba(217,149,32,0.15);color:#d99520;border:1px solid rgba(217,149,32,0.25)">Admin</span>`
    : `<span style="padding:0.2em 0.6em;border-radius:0.3em;font-size:0.67rem;font-weight:700;letter-spacing:0.05em;text-transform:uppercase;background:rgba(26,109,232,0.12);color:var(--blue-l);border:1px solid rgba(26,109,232,0.2)">Worker</span>`;

  document.getElementById('mdSpent').textContent     = '$' + fmt(spend);
  document.getElementById('mdPurchases').textContent = buys.length;
  // Project count: how many projects this member is assigned to
  const memberUid = m.user_id || m._id;
  const projCount = m.role === 'Admin' || m.role === 'admin'
    ? DB.projects.length
    : DB.projects.filter(p => (p.assignedWorkers||[]).includes(memberUid)).length;
  const projCountEl = document.getElementById('mdProjects');
  if (projCountEl) projCountEl.textContent = projCount;
  document.getElementById('mdEmail').textContent     = m.email || '—';
  document.getElementById('mdJoined').textContent    = m.joined_at ? 'Joined ' + fmtDate(new Date(m.joined_at).toISOString().split('T')[0]) : 'Member';

  // Recent purchases
  const recent = buys.slice(0,5);
  document.getElementById('mdPurchasesList').innerHTML = recent.length
    ? `<div style="font-size:0.75rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.07em;margin-bottom:0.5em">Recent Transactions</div>` +
      recent.map(p => `<div style="display:flex;justify-content:space-between;align-items:center;padding:0.5em 0;border-top:1px solid var(--border)">
        <div><div style="font-size:0.83rem;font-weight:500">${p.vendor||'Unknown'}</div><div style="font-size:0.72rem;color:var(--muted)">${p.category||''} · ${fmtDate(p.date)}</div></div>
        <span style="font-size:0.88rem;font-weight:700;flex-shrink:0;margin-left:0.75em">$${fmt(p.amount)}</span>
      </div>`).join('')
    : `<div style="font-size:0.82rem;color:var(--muted);text-align:center;padding:1em 0">No transactions yet</div>`;

  // Footer — admin can manage
  const isPrimaryAdmin = DB.role === 'admin';
  document.getElementById('mdFooter').innerHTML = isPrimaryAdmin
    ? `<button class="btn-cancel" style="color:var(--red);border-color:rgba(232,64,64,0.3)" onclick="event.stopPropagation();closeModal('memberDetailModal');deleteMember(${teamIdx})">Remove</button>
       <div style="display:flex;gap:0.5em">
         <button class="btn-cancel" onclick="closeModal('memberDetailModal')">Close</button>
         <button class="btn-save" onclick="closeModal('memberDetailModal');promoteMember(${teamIdx})">${role==='admin'?'Demote to Worker':'Promote to Admin'}</button>
       </div>`
    : `<button class="btn-cancel" onclick="closeModal('memberDetailModal')">Close</button>`;

  // Show hourly rate field for admins only
  const rateRow = document.getElementById('mdRateRow');
  const rateInput = document.getElementById('mdHourlyRate');
  if (rateRow && rateInput) {
    rateRow.style.display = DB.role === 'admin' ? '' : 'none';
    rateInput.value = m.hourlyRate || '';
    rateInput.dataset.teamIdx = teamIdx;
  }

  openModal('memberDetailModal');
}

async function saveHourlyRate() {
  const input = document.getElementById('mdHourlyRate');
  const teamIdx = parseInt(input.dataset.teamIdx);
  const rate = parseFloat(input.value) || 0;
  const m = DB.team[teamIdx];
  if (!m) return;
  const oldRate = m.hourlyRate;
  m.hourlyRate = rate;
  // Save to team_members row
  try {
    await sbPatch('team_members', 'id=eq.' + m._id, { hourly_rate: rate });
    input.style.borderColor = 'var(--green)';
    setTimeout(() => input.style.borderColor = 'var(--border2)', 1200);
    if (rate !== oldRate) pushNotif('hourly_rate', (m.firstName+' '+m.lastName).trim()+' hourly rate updated', '$'+rate+'/hr'+(oldRate?' (was $'+oldRate+'/hr)':''), {});
  } catch(e) {
    showToast('Failed to save rate');
  }
}

function signOut() {
  showConfirm('You will be returned to the sign-in screen.', () => {
    setSession(null);
    localStorage.removeItem('forge_cache');
    localStorage.removeItem('forge_company_id');
    window.location.href = 'auth.html';
  }, 'Sign Out?', 'Sign Out');
}

init();
</script>
</body>
</html>
