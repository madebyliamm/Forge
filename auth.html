<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Forge.inc — Sign In</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#07090e;--surface:#0d1117;--surface2:#131920;--surface3:#1a2230;
  --border:rgba(255,255,255,0.055);--border2:rgba(255,255,255,0.1);
  --blue:#1a6de8;--blue-l:#4a8ff0;
  --text:#edf0f5;--text2:#9aa3b4;--muted:#55627a;
  --green:#0da068;--red:#f87171;
}
html,body{height:100%;font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;}
.bg-grid{position:fixed;inset:0;pointer-events:none;z-index:0;background-image:linear-gradient(rgba(255,255,255,0.013) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.013) 1px,transparent 1px);background-size:52px 52px;mask-image:radial-gradient(ellipse 80% 80% at 50% 50%,black 0%,transparent 100%);}
.bg-glow{position:fixed;top:-10%;left:50%;transform:translateX(-50%);width:80vw;height:60vh;background:radial-gradient(ellipse,rgba(26,109,232,0.07) 0%,transparent 65%);pointer-events:none;z-index:0;}
.page{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2rem 1rem;position:relative;z-index:1;}
.logo{display:flex;align-items:center;gap:0.55em;text-decoration:none;color:var(--text);margin-bottom:2.5rem;}
.logo-mark{width:2rem;height:2rem;background:var(--blue);border-radius:0.45em;display:grid;place-items:center;flex-shrink:0;}
.logo-name{font-size:1.1rem;font-weight:700;letter-spacing:-0.02em;}
.logo-name .tld{color:var(--blue-l);}
.card{background:var(--surface);border:1px solid var(--border2);border-radius:1em;width:100%;max-width:420px;overflow:hidden;box-shadow:0 0 0 1px rgba(255,255,255,0.03),0 2em 5em rgba(0,0,0,0.5);animation:rise 0.4s cubic-bezier(0.16,1,0.3,1) both;}
@keyframes rise{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}

/* LOADING */
.loading{padding:3em;display:flex;justify-content:center;align-items:center;gap:0.4em;}
.loading span{width:8px;height:8px;border-radius:50%;background:var(--blue);animation:pulse 1.2s ease-in-out infinite;}
.loading span:nth-child(2){animation-delay:0.2s;}
.loading span:nth-child(3){animation-delay:0.4s;}
@keyframes pulse{0%,80%,100%{transform:scale(0.6);opacity:0.4}40%{transform:scale(1);opacity:1}}

/* CARD HEADER */
.card-head{padding:2em 2em 1.5em;border-bottom:1px solid var(--border);text-align:center;}
.company-avatar{width:52px;height:52px;border-radius:12px;background:var(--blue);display:grid;place-items:center;font-size:1.1rem;font-weight:700;color:#fff;margin:0 auto 1em;overflow:hidden;}
.company-avatar img{width:100%;height:100%;object-fit:cover;}
.card-title{font-size:1.2rem;font-weight:700;letter-spacing:-0.02em;margin-bottom:0.3em;}
.card-sub{font-size:0.83rem;color:var(--text2);line-height:1.5;}

/* CARD BODY */
.card-body{padding:1.75em 2em 2em;}
.field{margin-bottom:1em;}
.field label{display:block;font-size:0.78rem;font-weight:600;color:var(--text2);margin-bottom:0.38em;letter-spacing:0.01em;}
.field input{width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:0.5em;padding:0.65em 0.85em;font-size:0.9rem;color:var(--text);font-family:'DM Sans',sans-serif;transition:border-color 0.15s,box-shadow 0.15s;outline:none;-webkit-appearance:none;}
.field input::placeholder{color:var(--muted);}
.field input:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(26,109,232,0.15);}
.field.has-error input{border-color:var(--red);}
.field.has-error .field-error{display:block;}
.field-error{font-size:0.73rem;color:var(--red);margin-top:0.28em;display:none;}
.row-2{display:grid;grid-template-columns:1fr 1fr;gap:0.75em;}
.input-wrap{position:relative;}
.input-wrap input{padding-right:2.5em;}
.pw-toggle{position:absolute;right:0.75em;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--muted);padding:0;display:grid;place-items:center;transition:color 0.15s;}
.pw-toggle:hover{color:var(--text2);}
.optional{color:var(--muted);font-weight:400;}
.btn-join{width:100%;background:var(--blue);color:#fff;padding:0.75em 1.5em;border-radius:0.5em;font-size:0.925rem;font-weight:600;border:none;cursor:pointer;font-family:'DM Sans',sans-serif;transition:opacity 0.15s,transform 0.15s;display:flex;align-items:center;justify-content:center;gap:0.45em;margin-top:0.25em;}
.btn-join:hover:not(:disabled){opacity:0.9;transform:translateY(-1px);}
.btn-join:disabled{opacity:0.45;cursor:not-allowed;transform:none;}
.signin-hint{text-align:center;margin-top:1.25em;font-size:0.8rem;color:var(--muted);}
.signin-hint a{color:var(--blue-l);text-decoration:none;font-weight:600;}
.signin-hint a:hover{text-decoration:underline;}

/* INVALID STATE */
.state-invalid{padding:2.5em 2em;text-align:center;}
.state-icon{font-size:2.5rem;margin-bottom:0.75em;}
.state-title{font-size:1.1rem;font-weight:700;margin-bottom:0.4em;}
.state-sub{font-size:0.83rem;color:var(--text2);line-height:1.5;}

/* SUCCESS STATE */
.state-success{padding:2.5em 2em;text-align:center;}
.success-icon{width:56px;height:56px;background:rgba(13,160,104,0.12);border-radius:50%;display:grid;place-items:center;margin:0 auto 1.25em;animation:pop 0.4s cubic-bezier(0.16,1,0.3,1) both;}
@keyframes pop{from{transform:scale(0.5);opacity:0}to{transform:scale(1);opacity:1}}
.success-title{font-size:1.2rem;font-weight:700;letter-spacing:-0.02em;margin-bottom:0.4em;}
.success-sub{font-size:0.83rem;color:var(--text2);margin-bottom:1.75em;line-height:1.5;}
.btn-go{display:inline-flex;align-items:center;gap:0.45em;background:var(--blue);color:#fff;border:none;border-radius:0.5em;padding:0.72em 1.75em;font-size:0.9rem;font-weight:600;font-family:'DM Sans',sans-serif;cursor:pointer;text-decoration:none;transition:opacity 0.15s;}
.btn-go:hover{opacity:0.9;}

.page-foot{margin-top:2em;font-size:0.72rem;color:var(--muted);}
.flow{display:none;} .flow.active{display:block;}
.flow-title{font-size:1.3rem;font-weight:700;letter-spacing:-0.025em;margin-bottom:0.25em;}
.flow-sub{font-size:0.855rem;color:var(--text2);margin-bottom:1.8rem;line-height:1.5;}
.btn-back{background:none;border:none;cursor:pointer;color:var(--text2);font-size:0.82rem;font-family:'DM Sans',sans-serif;display:flex;align-items:center;gap:0.35em;padding:0;margin-bottom:1.4rem;transition:color 0.15s;}
.btn-back:hover{color:var(--text);}
.forgot-row{display:flex;justify-content:flex-end;margin-top:-0.45rem;margin-bottom:1.2rem;}
.forgot-row a{font-size:0.8rem;color:var(--blue-l);text-decoration:none;}
.forgot-row a:hover{text-decoration:underline;}
.optional{color:var(--muted);font-weight:400;}
</style>
</head>
<body>
<div class="bg-grid"></div>
<div class="bg-glow"></div>
<main class="page">
  <a href="index.html" class="logo">
    <div class="logo-mark"><svg viewBox="0 0 14 14" fill="none" width="14" height="14"><path d="M3 3h8M3 7h5M3 11V3" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    <span class="logo-name">Forge<span class="tld">.inc</span></span>
  </a>

  <div class="card" style="padding:2.5rem">

    <!-- SIGN IN -->
    <div class="flow active" id="flow-signin">
      <div class="flow-title">Welcome back</div>
      <div class="flow-sub">Sign in to your Forge account.</div>
      <div class="field" id="si-f-email">
        <label>Email</label>
        <input type="email" id="si-email" placeholder="you@company.com" autocomplete="email"/>
        <div class="field-error">Enter a valid email</div>
      </div>
      <div class="field" id="si-f-pw">
        <label>Password</label>
        <div class="input-wrap">
          <input type="password" id="si-pw" placeholder="Your password" autocomplete="current-password"/>
          <button class="pw-toggle" type="button" onclick="togglePw('si-pw',this)" tabindex="-1">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M1 8s2.5-5 7-5 7 5 7 5-2.5 5-7 5-7-5-7-5z" stroke="currentColor" stroke-width="1.4"/><circle cx="8" cy="8" r="2" stroke="currentColor" stroke-width="1.4"/></svg>
          </button>
        </div>
        <div class="field-error">Incorrect email or password</div>
      </div>
      <div class="forgot-row"><a href="#" onclick="showFlow('forgot');return false;">Forgot password?</a></div>
      <button class="btn-join" id="signinBtn" onclick="submitSignin()">
        Sign in
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M2 6h8M6 2l4 4-4 4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <div class="signin-hint" style="margin-top:1.1em">
        Joining a team? <a href="#" onclick="showFlow('join-code');return false;">Enter invite code</a>
      </div>
    </div>

    <!-- FORGOT PASSWORD -->
    <div class="flow" id="flow-forgot">
      <button class="btn-back" onclick="showFlow('signin')">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M9 2L4 7l5 5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Back
      </button>
      <div class="flow-title">Reset password</div>
      <div class="flow-sub">Enter your email and we'll send you a reset link.</div>
      <div class="field" id="fp-f-email">
        <label>Email</label>
        <input type="email" id="fp-email" placeholder="you@company.com" autocomplete="email"/>
        <div class="field-error">Enter a valid email</div>
      </div>
      <button class="btn-join" id="forgotBtn" onclick="submitForgot()">
        Send Reset Link
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M2 6h8M6 2l4 4-4 4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <div class="signin-hint" style="margin-top:1.1em">Remembered it? <a href="#" onclick="showFlow('signin');return false;">Sign in</a></div>
    </div>

    <!-- JOIN — STEP 1: Enter code -->
    <div class="flow" id="flow-join-code">
      <button class="btn-back" onclick="showFlow('signin')">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M9 2L4 7l5 5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Back
      </button>
      <div class="flow-title">Join your team</div>
      <div class="flow-sub">Enter the 6-character code your admin shared, or paste your invite link.</div>
      <div class="field" id="jc-f-code">
        <label>Team code or invite link</label>
        <input type="text" id="jc-code" placeholder="e.g. ABC123" autocomplete="off"
          style="text-transform:uppercase;letter-spacing:0.12em;font-size:1.1rem;font-weight:600;text-align:center"
          oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,6)"/>
        <div class="field-error">Enter a valid 6-character code</div>
      </div>
      <button class="btn-join" id="joinCodeBtn" onclick="submitCode()">
        Continue
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M2 6h8M6 2l4 4-4 4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <div class="signin-hint" style="margin-top:1.1em">Already have an account? <a href="#" onclick="showFlow('signin');return false;">Sign in</a></div>
    </div>

    <!-- JOIN — STEP 2: Name/email/pw -->
    <div class="flow" id="flow-join-form">
      <button class="btn-back" onclick="showFlow('join-code')">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M9 2L4 7l5 5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Back
      </button>
      <div class="company-avatar" id="companyAvatar" style="width:44px;height:44px;border-radius:10px;background:var(--blue);display:grid;place-items:center;font-size:0.95rem;font-weight:700;color:#fff;margin-bottom:0.9em;overflow:hidden"></div>
      <div class="flow-title" id="joinFormTitle">Join the team</div>
      <div class="flow-sub" id="joinFormSub">Create your account to get started.</div>
      <div class="row-2">
        <div class="field" id="f-first">
          <label>First name</label>
          <input type="text" id="inp-first" placeholder="Jane" autocomplete="given-name"/>
          <div class="field-error">Required</div>
        </div>
        <div class="field" id="f-last">
          <label>Last name</label>
          <input type="text" id="inp-last" placeholder="Doe" autocomplete="family-name"/>
          <div class="field-error">Required</div>
        </div>
      </div>
      <div class="field" id="f-email">
        <label>Email <span class="optional">(optional)</span></label>
        <input type="email" id="inp-email" placeholder="jane@company.com" autocomplete="email"/>
        <div class="field-error">Enter a valid email</div>
      </div>
      <div class="field" id="f-pw">
        <label>Create a password</label>
        <div class="input-wrap">
          <input type="password" id="inp-pw" placeholder="Min. 8 characters" autocomplete="new-password"/>
          <button class="pw-toggle" type="button" onclick="togglePw('inp-pw',this)" tabindex="-1">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M1 8s2.5-5 7-5 7 5 7 5-2.5 5-7 5-7-5-7-5z" stroke="currentColor" stroke-width="1.4"/><circle cx="8" cy="8" r="2" stroke="currentColor" stroke-width="1.4"/></svg>
          </button>
        </div>
        <div class="field-error">Must be at least 8 characters</div>
      </div>
      <button class="btn-join" id="btnJoin" onclick="submitJoin()">
        <span id="btnText">Join Team</span>
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M2 6h8M6 2l4 4-4 4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
    </div>

    <!-- SUCCESS -->
    <div class="flow" id="flow-success">
      <div class="state-success" style="text-align:center;padding:0.5em 0">
        <div class="success-icon" style="width:56px;height:56px;background:rgba(13,160,104,0.12);border-radius:50%;display:grid;place-items:center;margin:0 auto 1.25em">
          <svg width="26" height="26" viewBox="0 0 26 26" fill="none"><path d="M4 13l7 7 11-11" stroke="#0da068" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
        <div class="flow-title" id="successTitle" style="margin-bottom:0.35em">You're on the team!</div>
        <div class="flow-sub" id="successSub" style="margin-bottom:1.75em">You can now log purchases and track job budgets.</div>
        <a href="dashboard.html" class="btn-go btn-join" style="text-decoration:none">
          Open Dashboard
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M2 6h8M6 2l4 4-4 4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </a>
      </div>
    </div>

  </div>
  <div style="margin-top:1.5em;text-align:center;font-size:0.82rem;color:var(--muted)">New company? <a href="join.html" style="color:var(--blue-l);text-decoration:none;font-weight:600">Start free trial →</a></div>
  <div class="page-foot">Forge.inc · Construction Budget Tracking</div>
</main>

<script>
const SB_URL = 'https://rgexuyvucvcqulnhypkw.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJnZXh1eXZ1Y3ZjcXVsbmh5cGt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NzMxMzcsImV4cCI6MjA4NzU0OTEzN30.j2RTOp9Bfc9s0QV4YFqyz_Y4u8-buqtp2yhccF8D_LE';

// Redirect if already logged in
(function() {
  try { const s = localStorage.getItem('forge_session'); if (s && JSON.parse(s)?.access_token) window.location.replace('dashboard.html'); } catch(e) {}
  // Check if arriving from invite link (?code=XXXXXX)
  const code = new URLSearchParams(window.location.search).get('code');
  if (code) window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('jc-code').value = code.slice(0,6).toUpperCase();
    submitCode();
  });
})();

let company = null;

async function sbGet(table, params) {
  const r = await fetch(SB_URL + '/rest/v1/' + table + (params ? '?' + params : ''), {
    headers: { 'apikey': SB_KEY, 'Content-Type': 'application/json' }
  });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}
async function sbAuth(path, body) {
  const r = await fetch(SB_URL + '/auth/v1/' + path, {
    method: 'POST',
    headers: { 'apikey': SB_KEY, 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  const data = await r.json();
  if (!r.ok) throw new Error(data.error_description || data.msg || data.error || 'Auth error');
  return data;
}
async function sbPost(table, body, token) {
  const r = await fetch(SB_URL + '/rest/v1/' + table, {
    method: 'POST',
    headers: { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
    body: JSON.stringify(body)
  });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

function showFlow(name) {
  document.querySelectorAll('.flow').forEach(f => f.classList.remove('active'));
  document.getElementById('flow-' + name).classList.add('active');
  setTimeout(() => { const inp = document.querySelector('#flow-' + name + ' input'); if (inp) inp.focus(); }, 50);
}

function avatarColor(str) {
  const colors = ['#1a6de8','#0da068','#d99520','#8b5cf6','#ec4899','#e84040','#06b6d4'];
  let h = 0;
  for (let i = 0; i < str.length; i++) h = str.charCodeAt(i) + ((h << 5) - h);
  return colors[Math.abs(h) % colors.length];
}

// ── SIGN IN ──
async function submitSignin() {
  const email = document.getElementById('si-email').value.trim();
  const pw    = document.getElementById('si-pw').value;
  let ok = true;
  function check(id, valid) { document.getElementById(id).classList.toggle('has-error', !valid); if (!valid) ok = false; }
  check('si-f-email', /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email));
  check('si-f-pw', pw.length > 0);
  if (!ok) return;
  const btn = document.getElementById('signinBtn');
  btn.textContent = 'Signing in…'; btn.disabled = true;
  try {
    const data = await sbAuth('token?grant_type=password', { email, password: pw });
    localStorage.setItem('forge_session', JSON.stringify(data));
    window.location.href = 'dashboard.html';
  } catch(err) {
    btn.textContent = 'Sign in'; btn.disabled = false;
    document.getElementById('si-f-pw').classList.add('has-error');
  }
}

// ── FORGOT PASSWORD ──
async function submitForgot() {
  const email = document.getElementById('fp-email').value.trim();
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { document.getElementById('fp-f-email').classList.add('has-error'); return; }
  const btn = document.getElementById('forgotBtn');
  btn.textContent = 'Sending…'; btn.disabled = true;
  try {
    await fetch(SB_URL + '/auth/v1/recover', { method:'POST', headers:{'apikey':SB_KEY,'Content-Type':'application/json'}, body:JSON.stringify({email}) });
    btn.textContent = '✓ Check your email';
  } catch(err) {
    btn.textContent = 'Send Reset Link'; btn.disabled = false;
  }
}

// ── JOIN: STEP 1 — validate code ──
async function submitCode() {
  const raw  = document.getElementById('jc-code').value.trim().toUpperCase();
  // Accept full invite URL or just the code
  const code = raw.includes('code=') ? new URLSearchParams(raw.split('?')[1]).get('code') : raw;
  if (!code || code.length !== 6) { document.getElementById('jc-f-code').classList.add('has-error'); return; }
  document.getElementById('jc-f-code').classList.remove('has-error');
  const btn = document.getElementById('joinCodeBtn');
  btn.textContent = 'Looking up…'; btn.disabled = true;
  try {
    const rows = await sbGet('companies', 'team_code=eq.' + encodeURIComponent(code) + '&select=id,name&limit=1');
    if (!rows.length) { document.getElementById('jc-f-code').classList.add('has-error'); btn.textContent = 'Continue'; btn.disabled = false; return; }
    company = rows[0];
    const initials = company.name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
    const avatar = document.getElementById('companyAvatar');
    avatar.textContent = initials;
    avatar.style.background = avatarColor(company.name);
    document.getElementById('joinFormTitle').textContent = 'Join ' + company.name;
    document.getElementById('joinFormSub').textContent   = 'Create your account to get started with ' + company.name + '.';
    document.getElementById('btnText').textContent       = 'Join ' + company.name;
    btn.textContent = 'Continue'; btn.disabled = false;
    showFlow('join-form');
  } catch(e) {
    document.getElementById('jc-f-code').classList.add('has-error');
    btn.textContent = 'Continue'; btn.disabled = false;
  }
}

// ── JOIN: STEP 2 — create account ──
async function submitJoin() {
  const first = document.getElementById('inp-first').value.trim();
  const last  = document.getElementById('inp-last').value.trim();
  const email = document.getElementById('inp-email').value.trim();
  const pw    = document.getElementById('inp-pw').value;
  let ok = true;
  function check(id, valid) { document.getElementById(id).classList.toggle('has-error', !valid); if (!valid) ok = false; }
  check('f-first', first.length > 0);
  check('f-last',  last.length > 0);
  check('f-pw',    pw.length >= 8);
  if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { document.getElementById('f-email').classList.add('has-error'); ok = false; }
  else document.getElementById('f-email').classList.remove('has-error');
  if (!ok) return;
  const btn = document.getElementById('btnJoin');
  btn.disabled = true; document.getElementById('btnText').textContent = 'Joining…';
  const uid = Math.random().toString(36).slice(2,9);
  const workerEmail = email || (first.toLowerCase()+'.'+last.toLowerCase()+'.'+uid+'@forge-worker.internal');
  try {
    const auth = await sbAuth('signup', { email: workerEmail, password: pw, data: { first_name: first, last_name: last, role: 'worker', company_id: company.id } });
    const token = auth.access_token;
    if (token) {
      await sbPost('team_members', { company_id: company.id, first_name: first, last_name: last, email: email||null, role: 'Worker', user_id: auth.user?.id, joined_at: Date.now() }, token);
      localStorage.setItem('forge_session', JSON.stringify(auth));
      localStorage.setItem('forge_company_id', company.id);
    }
    document.getElementById('successTitle').textContent = 'Welcome, ' + first + '!';
    document.getElementById('successSub').textContent   = 'You have joined ' + company.name + '. Open your dashboard to get started.';
    showFlow('success');
  } catch(err) {
    btn.disabled = false; document.getElementById('btnText').textContent = 'Join ' + (company?.name||'Team');
    const errEl = document.querySelector('#f-pw .field-error');
    if (errEl) errEl.textContent = err.message;
    document.getElementById('f-pw').classList.add('has-error');
  }
}

function togglePw(inputId, btn) {
  const input = document.getElementById(inputId);
  const show  = input.type === 'password';
  input.type  = show ? 'text' : 'password';
  btn.innerHTML = show
    ? `<svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M1 8s2.5-5 7-5 7 5 7 5-2.5 5-7 5-7-5-7-5z" stroke="currentColor" stroke-width="1.4" opacity="0.4"/><path d="M3 3l10 10" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/></svg>`
    : `<svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M1 8s2.5-5 7-5 7 5 7 5-2.5 5-7 5-7-5-7-5z" stroke="currentColor" stroke-width="1.4"/><circle cx="8" cy="8" r="2" stroke="currentColor" stroke-width="1.4"/></svg>`;
}

document.addEventListener('keydown', e => {
  if (e.key !== 'Enter') return;
  const active = document.querySelector('.flow.active');
  if (!active) return;
  switch(active.id) {
    case 'flow-signin':    submitSignin(); break;
    case 'flow-forgot':    submitForgot(); break;
    case 'flow-join-code': submitCode();   break;
    case 'flow-join-form': submitJoin();   break;
  }
});
</script>
</body>
</html>
