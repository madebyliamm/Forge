<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Project Report â€” Forge.inc</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #0a0a0a; --surface: #111; --surface2: #181818; --surface3: #1e1e1e;
  --border: rgba(255,255,255,0.07); --border2: rgba(255,255,255,0.11);
  --text: #f0f0f0; --text2: #999; --muted: #555;
  --green: #0da068; --orange: #f5a623; --red: #e84040; --blue: #1a6de8; --blue-l: #4a8ff0;
}
html, body { min-height:100vh; background:var(--bg); color:var(--text); font-family:'DM Sans',sans-serif; -webkit-font-smoothing:antialiased; }

/* LOADING */
#loading { position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bg);z-index:100;transition:opacity 0.4s; }
#loading.hidden { opacity:0;pointer-events:none; }
.loader-logo { font-size:1.4rem;font-weight:700;letter-spacing:-0.03em; }
.loader-logo span { color:var(--blue-l); }

/* NOT FOUND */
#notFound { display:none;min-height:100vh;align-items:center;justify-content:center;flex-direction:column;gap:1em;text-align:center; }
#notFound.visible { display:flex; }

/* PAGE */
.page { max-width:820px;margin:0 auto;padding:3em 2em 6em;opacity:0;transform:translateY(14px);transition:opacity 0.45s ease,transform 0.45s ease; }
.page.visible { opacity:1;transform:translateY(0); }

/* HEADER */
.rpt-header { display:flex;justify-content:space-between;align-items:center;margin-bottom:2.5em;padding-bottom:2em;border-bottom:1px solid var(--border); }
.brand { display:flex;align-items:center;gap:0.55em;font-size:0.9rem;font-weight:700;letter-spacing:-0.02em; }
.brand-mark { width:28px;height:28px;background:var(--blue);border-radius:0.4em;display:grid;place-items:center;flex-shrink:0; }
.brand span { color:var(--blue-l); }
.rpt-date { font-size:0.75rem;color:var(--muted);font-family:'JetBrains Mono',monospace; }

/* HERO */
.hero { margin-bottom:2.5em; }
.hero-tag { display:inline-flex;align-items:center;gap:0.4em;font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--blue-l);margin-bottom:0.6em; }
.hero-tag::before { content:'';width:5px;height:5px;border-radius:50%;background:var(--blue-l);animation:pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.4;transform:scale(0.6)} }
.hero-name { font-size:clamp(1.8rem,5vw,2.8rem);font-weight:700;letter-spacing:-0.04em;line-height:1.1;margin-bottom:0.6em; }
.hero-meta { display:flex;align-items:center;gap:1.25em;flex-wrap:wrap;font-size:0.85rem;color:var(--text2); }
.hero-meta-item { display:flex;align-items:center;gap:0.4em; }
.hero-meta-item svg { opacity:0.4;flex-shrink:0; }

/* STATUS BADGE */
.badge { display:inline-flex;align-items:center;padding:0.25em 0.7em;border-radius:100px;font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:0.05em; }
.badge-over { background:rgba(232,64,64,0.12);color:var(--red); }
.badge-warn { background:rgba(245,166,35,0.12);color:var(--orange); }
.badge-good { background:rgba(13,160,104,0.12);color:var(--green); }

/* STATS GRID */
.stats-grid { display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1px;background:var(--border);border-radius:12px;overflow:hidden;margin-bottom:2.5em; }
.stat-box { background:var(--surface);padding:1.4em 1.6em;position:relative;overflow:hidden; }
.stat-box::before { content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--accent,var(--blue));opacity:0.5; }
.stat-label { font-size:0.65rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--muted);margin-bottom:0.45em; }
.stat-val { font-size:1.55rem;font-weight:700;letter-spacing:-0.04em;line-height:1;margin-bottom:0.25em; }
.stat-note { font-size:0.72rem;color:var(--text2); }

/* SECTION */
.section { margin-bottom:2.25em; }
.section-title { font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:0.12em;color:var(--muted);margin-bottom:1.1em;display:flex;align-items:center;gap:0.75em; }
.section-title::after { content:'';flex:1;height:1px;background:var(--border); }

/* BUDGET VISUAL */
.budget-card { background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.6em; }
.budget-numbers { display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:0.85em; }
.budget-spent-amt { font-size:1.6rem;font-weight:700;letter-spacing:-0.04em; }
.budget-total-lbl { font-size:0.78rem;color:var(--text2); }
.budget-bar-wrap { height:8px;border-radius:4px;background:var(--surface2);position:relative;overflow:hidden;margin-bottom:0.6em; }
.budget-bar-fill { position:absolute;top:0;left:0;height:100%;border-radius:4px;transition:width 1.1s cubic-bezier(0.16,1,0.3,1); }
.budget-bar-over { position:absolute;top:0;left:0;height:100%;border-radius:4px;background:var(--red);transition:width 1.1s cubic-bezier(0.16,1,0.3,1) 0.25s; }
.budget-foot { display:flex;justify-content:space-between;font-size:0.75rem;color:var(--text2); }

/* CATEGORY BREAKDOWN */
.cat-list { display:flex;flex-direction:column;gap:0.7em; }
.cat-row { background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:1em 1.15em; }
.cat-row-head { display:flex;justify-content:space-between;align-items:center;margin-bottom:0.55em; }
.cat-row-name { font-size:0.88rem;font-weight:600; }
.cat-row-right { display:flex;align-items:center;gap:0.85em; }
.cat-row-pct { font-size:0.72rem;color:var(--text2);font-family:'JetBrains Mono',monospace; }
.cat-row-amt { font-size:0.88rem;font-weight:700;font-family:'JetBrains Mono',monospace; }
.cat-bar { height:3px;border-radius:2px;background:var(--surface2);position:relative;overflow:hidden; }
.cat-bar-fill { position:absolute;top:0;left:0;height:100%;border-radius:2px;transition:width 0.9s cubic-bezier(0.16,1,0.3,1); }

/* TRANSACTION TABLE */
.tx-table { background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden; }
.tx-head { display:grid;grid-template-columns:100px 1fr 110px 120px;padding:0.7em 1.15em;border-bottom:1px solid var(--border);font-size:0.63rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--muted); }
.tx-row { display:grid;grid-template-columns:100px 1fr 110px 120px;padding:0.8em 1.15em;border-bottom:1px solid var(--border);font-size:0.82rem;cursor:pointer;transition:background 0.1s;align-items:center; }
.tx-row:last-child { border-bottom:none; }
.tx-row:hover { background:rgba(255,255,255,0.02); }
.tx-date { font-size:0.73rem;color:var(--text2);font-family:'JetBrains Mono',monospace; }
.tx-vendor { font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding-right:0.5em; }
.tx-amt { font-weight:700;font-family:'JetBrains Mono',monospace;text-align:right; }
.tx-cat { display:flex;justify-content:flex-end; }
.cat-pill { display:inline-block;padding:0.18em 0.6em;border-radius:100px;font-size:0.63rem;font-weight:600;background:rgba(255,255,255,0.06);color:var(--text2); }
.tx-detail { display:none;grid-column:1/-1;background:var(--surface2);border-top:1px solid var(--border);padding:0.8em 1.15em;font-size:0.78rem;color:var(--text2);gap:1.5em;flex-wrap:wrap; }
.tx-detail.open { display:flex; }
.tx-detail-item strong { color:var(--text);display:block;margin-bottom:0.1em;font-size:0.75rem; }

/* DOWNLOAD BTN */
.download-btn { display:inline-flex;align-items:center;gap:0.45em;padding:0.42em 0.9em;background:var(--blue);color:#fff;border:none;border-radius:0.45em;font-size:0.78rem;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;transition:opacity 0.15s;white-space:nowrap; }
.download-btn:hover { opacity:0.85; }
.download-btn svg { flex-shrink:0; }

/* FOOTER */
.rpt-footer { margin-top:3.5em;padding-top:1.75em;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1em; }
.footer-brand { font-size:0.78rem;color:var(--muted); }
.footer-brand strong { color:var(--text2); }
.footer-note { font-size:0.7rem;color:var(--muted);font-family:'JetBrains Mono',monospace; }

/* FADE IN */
.fade { opacity:0;transform:translateY(16px);transition:opacity 0.45s ease,transform 0.45s ease; }
.fade.in { opacity:1;transform:translateY(0); }

@media print {
  .download-btn { display:none; }
  body { background:#fff;color:#000; }
  :root { --bg:#fff;--surface:#f8f8f8;--surface2:#f0f0f0;--surface3:#e8e8e8;--border:rgba(0,0,0,0.1);--border2:rgba(0,0,0,0.15);--text:#111;--text2:#555;--muted:#888; }
  .page { padding:2em 1.5em; }
}
@media (max-width:600px) {
  .page { padding:2em 1.25em 4em; }
  .tx-head, .tx-row { grid-template-columns:86px 1fr 90px; }
  .tx-cat { display:none; }
  .rpt-header { flex-direction:column;gap:0.75em;align-items:flex-start; }
  .stats-grid { grid-template-columns:1fr 1fr; }
}
</style>
</head>
<body>

<div id="loading"><div class="loader-logo">Forge<span>.inc</span></div></div>

<div id="notFound">
  <div style="font-size:2.5rem">ðŸ“‹</div>
  <div style="font-size:1.4rem;font-weight:700;letter-spacing:-0.03em">Report not found</div>
  <div style="color:var(--text2);font-size:0.88rem;margin-top:0.25em">This link may be invalid or expired.</div>
</div>

<div class="page" id="reportPage">

  <div class="rpt-header fade">
    <div class="brand">
      <div class="brand-mark">
        <svg viewBox="0 0 14 14" fill="none" width="14" height="14">
          <path d="M3 3h8M3 7h5M3 11V3" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <span style="color:var(--text)">Forge</span><span style="color:var(--blue-l)">.inc</span>
    </div>
    <div style="display:flex;align-items:center;gap:1em">
      <div class="rpt-date" id="rptDate">â€”</div>
      <button class="download-btn" onclick="downloadPDF()">
        <svg width="13" height="13" viewBox="0 0 14 14" fill="none"><path d="M7 1v8M4 6l3 3 3-3" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><path d="M2 11h10" stroke="white" stroke-width="1.8" stroke-linecap="round"/></svg>
        Save as PDF
      </button>
    </div>
  </div>

  <div class="hero fade">
    <div class="hero-tag">Project Report</div>
    <div class="hero-name" id="heroName">â€”</div>
    <div class="hero-meta" id="heroMeta"></div>
  </div>

  <div class="stats-grid fade" id="statsGrid"></div>

  <div class="section fade">
    <div class="section-title">Budget Overview</div>
    <div class="budget-card">
      <div class="budget-numbers">
        <div>
          <div class="budget-spent-amt" id="budgetSpentAmt">â€”</div>
          <div style="font-size:0.75rem;color:var(--text2);margin-top:0.2em">of <span id="budgetTotalAmt">â€”</span> budget</div>
        </div>
        <div id="budgetBadge"></div>
      </div>
      <div class="budget-bar-wrap">
        <div class="budget-bar-fill" id="barFill" style="width:0%"></div>
        <div class="budget-bar-over" id="barOver" style="width:0%;display:none"></div>
      </div>
      <div class="budget-foot">
        <span id="budgetRemLabel">â€”</span>
        <span id="budgetPctLabel">â€”</span>
      </div>
    </div>
  </div>

  <div class="section fade" id="catSection" style="display:none">
    <div class="section-title">By Category</div>
    <div class="cat-list" id="catList"></div>
  </div>

  <div class="section fade">
    <div class="section-title">Transactions</div>
    <div class="tx-table" id="txTable">
      <div class="tx-head">
        <div>Date</div><div>Vendor</div><div style="text-align:right">Amount</div><div style="text-align:right">Category</div>
      </div>
      <div id="txRows"></div>
    </div>
  </div>

  <div class="rpt-footer fade">
    <div class="footer-brand">Generated by <strong>Forge.inc</strong></div>
    <div class="footer-note" id="footerCompany"></div>
  </div>

</div>

<script>
const fmt  = n => Number(n||0).toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0});
const fmtD = d => { if(!d) return 'â€”'; const dt=new Date(d+'T12:00:00'); return dt.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}); };

function load() {
  const hash = window.location.hash.slice(1);
  if (!hash) return null;
  try { return JSON.parse(decodeURIComponent(escape(atob(hash)))); } catch(e) {
    try { return JSON.parse(atob(hash)); } catch(e2) { return null; }
  }
}

function statusBadge(pct) {
  if (pct > 100) return '<span class="badge badge-over">Over Budget</span>';
  if (pct > 85)  return '<span class="badge badge-warn">Near Limit</span>';
  return '<span class="badge badge-good">On Track</span>';
}
function projectStatusBadge(p) {
  const now   = new Date(); now.setHours(0,0,0,0);
  const start = p.startDate ? new Date(p.startDate+'T00:00:00') : null;
  const end   = p.endDate   ? new Date(p.endDate+'T00:00:00')   : null;
  if (start && start > now) return '<span class="badge" style="background:rgba(26,109,232,0.12);color:var(--blue-l)">Upcoming</span>';
  if (end && end < now)     return '<span class="badge" style="background:rgba(255,255,255,0.07);color:var(--text2)">Completed</span>';
  return '<span class="badge badge-good">In Progress</span>';
}
function barColor(pct) {
  return pct > 100 ? 'var(--red)' : pct > 85 ? 'var(--orange)' : 'var(--green)';
}

function render(data) {
  const { project: p, purchases: pus, companyName, generatedAt } = data;

  // Only expenses
  const expenses = pus.filter(x => x.type !== 'income');
  const spent    = expenses.reduce((s,x) => s + Math.abs(x.amount), 0);
  const rem      = (p.budget||0) - spent;
  const pct      = p.budget > 0 ? (spent / p.budget * 100) : 0;
  const pctRound = Math.round(pct);
  const col      = barColor(pct);

  // Date
  document.getElementById('rptDate').textContent =
    'Generated ' + new Date(generatedAt).toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});

  // Hero
  document.getElementById('heroName').textContent = p.name;
  const meta = [];
  if (p.clientName || p.client) {
    const cn = p.clientName || p.client.split(' Â· ')[0];
    meta.push(`<div class="hero-meta-item"><svg width="12" height="12" viewBox="0 0 12 12" fill="none"><circle cx="6" cy="4" r="2.5" stroke="currentColor" stroke-width="1.3"/><path d="M1.5 10.5c0-2.5 2-4 4.5-4s4.5 1.5 4.5 4" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/></svg>${cn}</div>`);
  }
  if (p.location) {
    meta.push(`<div class="hero-meta-item"><svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M6 1a3.5 3.5 0 013.5 3.5C9.5 7.5 6 11 6 11S2.5 7.5 2.5 4.5A3.5 3.5 0 016 1z" stroke="currentColor" stroke-width="1.3"/><circle cx="6" cy="4.5" r="1" stroke="currentColor" stroke-width="1.2"/></svg>${p.location}</div>`);
  }
  // Project duration in days instead of start date
  if (p.startDate && p.endDate) {
    const days = Math.round((new Date(p.endDate+'T00:00:00') - new Date(p.startDate+'T00:00:00')) / 86400000);
    meta.push(`<div class="hero-meta-item"><svg width="12" height="12" viewBox="0 0 12 12" fill="none"><rect x="1" y="2" width="10" height="9" rx="1.2" stroke="currentColor" stroke-width="1.3"/><path d="M4 1v2M8 1v2M1 5h10" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/></svg>${days} day${days!==1?'s':''}</div>`);
  } else if (p.startDate) {
    meta.push(`<div class="hero-meta-item"><svg width="12" height="12" viewBox="0 0 12 12" fill="none"><rect x="1" y="2" width="10" height="9" rx="1.2" stroke="currentColor" stroke-width="1.3"/><path d="M4 1v2M8 1v2M1 5h10" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/></svg>Started ${fmtD(p.startDate)}</div>`);
  }
  meta.push(projectStatusBadge(p));
  document.getElementById('heroMeta').innerHTML = meta.join('');

  // Stats
  const statsData = [
    { label:'Total Budget',  val:'$'+fmt(p.budget||0),  note: p.name,                         accent:'var(--blue)' },
    { label:'Total Spent',   val:'$'+fmt(spent),         note: expenses.length+' transactions', accent: col },
    { label:'Remaining',     val:(rem<0?'-':'')+'$'+fmt(Math.abs(rem)), note: rem<0?'Over budget':pctRound+'% used', accent: rem<0?'var(--red)':'var(--green)' },
    { label:'Transactions',  val: expenses.length,       note:(p.categories||[]).filter(c=>c!=='Labor Estimate').length+' categories', accent:'var(--blue)' },
  ];
  document.getElementById('statsGrid').innerHTML = statsData.map(s =>
    `<div class="stat-box" style="--accent:${s.accent}">
      <div class="stat-label">${s.label}</div>
      <div class="stat-val" style="color:${s.accent}">${s.val}</div>
      <div class="stat-note">${s.note}</div>
    </div>`
  ).join('');

  // Budget bar
  setTimeout(() => {
    const fill = document.getElementById('barFill');
    fill.style.width = Math.min(100, pct) + '%';
    fill.style.background = col;
    if (pct > 100) {
      const over = document.getElementById('barOver');
      over.style.display = 'block';
      setTimeout(() => { over.style.width = Math.min(pct-100, 100)+'%'; }, 250);
    }
  }, 350);
  document.getElementById('budgetSpentAmt').textContent = '$'+fmt(spent);
  document.getElementById('budgetSpentAmt').style.color = col;
  document.getElementById('budgetTotalAmt').textContent = '$'+fmt(p.budget||0);
  document.getElementById('budgetBadge').innerHTML = statusBadge(pct);
  document.getElementById('budgetRemLabel').textContent = rem >= 0 ? '$'+fmt(rem)+' remaining' : '$'+fmt(Math.abs(rem))+' over budget';
  document.getElementById('budgetPctLabel').textContent = pctRound+'% used';

  // Categories
  const cats = (p.categories || []);
  const catsWithSpend = cats.map(cat => ({
    name: cat,
    spent: expenses.filter(x=>x.category===cat).reduce((s,x)=>s+Math.abs(x.amount),0)
  })).filter(c => c.spent > 0);

  if (catsWithSpend.length) {
    document.getElementById('catSection').style.display = '';
    document.getElementById('catList').innerHTML = catsWithSpend
      .sort((a,b) => b.spent - a.spent)
      .map((cat, idx) => {
        const cp  = p.budget > 0 ? (cat.spent / p.budget * 100) : 0;
        const cpR = Math.round(cp);
        const bw  = Math.min(100, cp); // bar width = % of budget, capped at 100
        const cc  = cp > 100 ? 'var(--red)' : cp > 85 ? 'var(--orange)' : (p.color || 'var(--blue)');
        return `<div class="cat-row">
          <div class="cat-row-head">
            <div class="cat-row-name">${cat.name}</div>
            <div class="cat-row-right">
              <div class="cat-row-pct">${cpR}% of budget</div>
              <div class="cat-row-amt" style="color:${cc}">$${fmt(cat.spent)}</div>
            </div>
          </div>
          <div class="cat-bar">
            <div class="cat-bar-fill" style="width:0%;background:${cc}" data-w="${bw.toFixed(1)}" data-delay="${idx*60}"></div>
          </div>
        </div>`;
      }).join('');
    setTimeout(() => {
      document.querySelectorAll('.cat-bar-fill').forEach(el => {
        setTimeout(() => { el.style.width = el.dataset.w + '%'; }, parseInt(el.dataset.delay||0));
      });
    }, 500);
  }

  // Transactions
  const sorted = [...expenses].sort((a,b) => (b.date||'').localeCompare(a.date||''));
  document.getElementById('txRows').innerHTML = sorted.length
    ? sorted.map((tx,i) => `
      <div class="tx-row" onclick="toggleTx(${i})">
        <div class="tx-date">${fmtD(tx.date)}</div>
        <div class="tx-vendor">${tx.vendor||'â€”'}</div>
        <div class="tx-amt" style="color:${col}">$${fmt(Math.abs(tx.amount))}</div>
        <div class="tx-cat"><span class="cat-pill">${tx.category||'General'}</span></div>
      </div>
      <div class="tx-detail" id="txd-${i}">
        ${tx.notes ? `<div class="tx-detail-item"><strong>Notes</strong>${tx.notes}</div>` : ''}
        ${tx.worker ? `<div class="tx-detail-item"><strong>Added by</strong>${tx.worker}</div>` : ''}
        <div class="tx-detail-item"><strong>Date</strong>${fmtD(tx.date)}</div>
        ${tx.category ? `<div class="tx-detail-item"><strong>Category</strong>${tx.category}</div>` : ''}
      </div>`)
      .join('')
    : '<div style="padding:2em;text-align:center;color:var(--muted);font-size:0.85rem">No transactions recorded</div>';

  // Footer
  document.getElementById('footerCompany').textContent = companyName || '';
}

function toggleTx(i) {
  const el = document.getElementById('txd-'+i);
  if (el) el.classList.toggle('open');
}

function downloadPDF() {
  // Set document title to project name so the PDF filename is meaningful
  const heroName = document.getElementById('heroName');
  const orig = document.title;
  if (heroName) document.title = heroName.textContent + ' â€” Forge Report';
  window.print();
  setTimeout(() => { document.title = orig; }, 1000);
}

window.addEventListener('load', () => {
  const loading  = document.getElementById('loading');
  const page     = document.getElementById('reportPage');
  const notFound = document.getElementById('notFound');
  const data = load();
  setTimeout(() => {
    loading.classList.add('hidden');
    if (!data) { notFound.classList.add('visible'); return; }
    render(data);
    page.classList.add('visible');
    const fades = document.querySelectorAll('.fade');
    fades.forEach((el,i) => setTimeout(() => el.classList.add('in'), 80 + i*60));
  }, 500);
});
</script>
</body>
</html>
